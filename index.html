<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLOE JACK — Subscriber Content Planner</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="SLOE JACK — Subscriber Content Planner">
    <meta property="og:description" content="Stay consistent with your subscriber content. Track daily habits, weekly tasks, and never miss a post.">
    <meta property="og:image" content="og-thumbnail.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="SLOE JACK — Subscriber Content Planner">
    <meta name="twitter:description" content="Stay consistent with your subscriber content. Track daily habits, weekly tasks, and never miss a post.">
    <meta name="twitter:image" content="og-thumbnail.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #141416;
            --bg-tertiary: #1c1c1f;
            --bg-card: #1e1e22;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-primary: #f97316;
            --accent-secondary: #fb923c;
            --accent-glow: rgba(249, 115, 22, 0.15);
            --border-color: #27272a;
            --border-subtle: #1f1f23;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --gradient-1: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            --gradient-2: linear-gradient(135deg, #1e1e22 0%, #141416 100%);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 40px rgba(249, 115, 22, 0.2);
        }

        [data-theme="light"] {
            --bg-primary: #fafaf9;
            --bg-secondary: #f5f5f4;
            --bg-tertiary: #e7e5e4;
            --bg-card: #ffffff;
            --text-primary: #1c1917;
            --text-secondary: #57534e;
            --text-muted: #a8a29e;
            --accent-primary: #ea580c;
            --accent-secondary: #f97316;
            --accent-glow: rgba(234, 88, 12, 0.1);
            --border-color: #d6d3d1;
            --border-subtle: #e7e5e4;
            --gradient-2: linear-gradient(135deg, #ffffff 0%, #f5f5f4 100%);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --shadow-glow: 0 0 40px rgba(234, 88, 12, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.25rem;
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.02em;
        }

        .logo-sub {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* To-Do Tab with Badge */
        .todo-tab {
            position: relative;
        }

        .todo-tab-badge {
            background: #ef4444;
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.125rem 0.4rem;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            margin-left: 0.25rem;
        }

        .todo-tab-badge:empty,
        .todo-tab-badge[data-count="0"] {
            display: none;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.25rem;
        }

        .theme-toggle:hover {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .btn-primary.paid-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-primary.paid-btn:hover {
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.375rem;
            border-radius: 12px;
        }

        .view-tab {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-tab:hover {
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        /* Main Layout */
        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Calendar View */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.25rem;
        }

        .calendar-nav-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
        }

        .calendar-title {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .calendar-day-header {
            background: var(--bg-secondary);
            padding: 1rem;
            text-align: center;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .calendar-day {
            background: var(--bg-card);
            min-height: 140px;
            padding: 0.75rem;
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .calendar-day:hover {
            background: var(--bg-tertiary);
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            background: var(--accent-glow);
        }

        .calendar-day.today::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-1);
        }

        .calendar-day.weekend {
            background: var(--bg-secondary);
            cursor: default;
        }

        .calendar-day.weekend:hover {
            background: var(--bg-secondary);
        }

        .day-number {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .day-tasks {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .task-pill {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-pill:hover {
            transform: scale(1.02);
        }

        .task-pill.daily {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-left: 2px solid #22c55e;
        }

        .task-pill.weekly {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-left: 2px solid #3b82f6;
        }

        .task-pill.monthly {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border-left: 2px solid #a855f7;
        }

        .task-pill.quarterly {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
            border-left: 2px solid #f97316;
        }

        /* List Views */
        .list-view {
            display: none;
        }

        .list-view.active {
            display: block;
        }

        .list-section {
            margin-bottom: 2rem;
        }

        .list-section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .list-section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .list-section-icon.daily { background: rgba(34, 197, 94, 0.2); }
        .list-section-icon.weekly { background: rgba(59, 130, 246, 0.2); }
        .list-section-icon.monthly { background: rgba(168, 85, 247, 0.2); }
        .list-section-icon.quarterly { background: rgba(249, 115, 22, 0.2); }
        .list-section-icon.yearly { background: rgba(236, 72, 153, 0.2); }

        .list-section-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .list-section-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .task-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .task-item:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-checkbox:hover {
            border-color: var(--accent-primary);
        }

        .task-checkbox.checked {
            background: var(--gradient-1);
            border-color: var(--accent-primary);
        }

        .task-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .task-title[contenteditable="true"] {
            outline: none;
            padding: 0.25rem 0.5rem;
            margin: -0.25rem -0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .task-title[contenteditable="true"]:hover {
            background: var(--bg-tertiary);
        }

        .task-title[contenteditable="true"]:focus {
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        .task-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
        }

        .task-category {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .task-category.stories { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .task-category.groupchat { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .task-category.reels { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .task-category.live { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .task-category.shows { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .task-category.merch { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .task-category.video { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .task-category.polls { background: rgba(234, 179, 8, 0.2); color: #eab308; }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .task-item:hover .task-actions {
            opacity: 1;
        }

        .task-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .task-action-btn:hover {
            background: var(--accent-glow);
            color: var(--accent-primary);
        }

        /* Auto-populate Panel */
        .auto-panel {
            position: fixed;
            right: -400px;
            top: 0;
            bottom: 0;
            width: 400px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 200;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .auto-panel.open {
            right: 0;
        }

        .auto-panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .auto-panel-title {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .auto-panel-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .auto-panel-close:hover {
            background: var(--accent-glow);
            color: var(--accent-primary);
        }

        .auto-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .idea-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .idea-card:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }

        .idea-type {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .idea-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .idea-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Idea Preview in Modal */
        .idea-preview {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .idea-preview-type {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-primary);
            margin-bottom: 0.375rem;
        }

        .idea-preview-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.375rem;
        }

        .idea-preview-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            flex-shrink: 0;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Paid Stats Preview */
        .paid-stats-preview {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .paid-preview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .paid-preview-row:first-child {
            border-bottom: 1px solid var(--border-color);
        }

        .paid-preview-row span:last-child {
            font-weight: 700;
            color: #8b5cf6;
            font-size: 1.1rem;
        }

        /* Category Manager */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .category-item:hover {
            border-color: var(--accent-primary);
        }

        .category-color-dot {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .category-icon-input {
            width: 40px;
            padding: 0.375rem;
            text-align: center;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .category-name-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
        }

        .category-name-input:focus,
        .category-icon-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .category-color-picker {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
            background: transparent;
        }

        .category-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .category-color-picker::-webkit-color-swatch {
            border: 2px solid var(--border-color);
            border-radius: 6px;
        }

        .category-delete-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .category-delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .category-item.default .category-delete-btn {
            opacity: 0.3;
            pointer-events: none;
        }

        .add-category-btn {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: transparent;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .add-category-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: var(--accent-glow);
        }

        .manage-categories-link {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }

        .manage-categories-link:hover {
            color: var(--accent-primary);
        }

        /* Pin Button */
        .task-pin-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .task-pin-btn:hover {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .task-pin-btn.pinned {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .editor-pin-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .editor-pin-btn:hover {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .editor-pin-btn.pinned {
            color: #eab308;
        }

        /* Times per week selector */
        .editor-times-select {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .editor-times-select:hover {
            border-color: var(--accent-primary);
        }

        .editor-times-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Remaining count badge in pinned section */
        .frequency-pinned-remaining {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        .frequency-pinned-remaining.done {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .frequency-pinned-remaining.partial {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .coming-up-unpin {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            flex-shrink: 0;
            opacity: 0;
        }

        .coming-up-item:hover .coming-up-unpin {
            opacity: 1;
        }

        .coming-up-unpin:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-card.daily .stat-value { color: #22c55e; }
        .stat-card.weekly .stat-value { color: #3b82f6; }
        .stat-card.monthly .stat-value { color: #a855f7; }
        .stat-card.quarterly .stat-value { color: #f97316; }
        .stat-card.yearly .stat-value { color: #ec4899; }

        .stat-progress {
            margin-top: 0.75rem;
        }

        .stat-progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .stat-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .stat-card.daily .stat-progress-fill { background: #22c55e; }
        .stat-card.weekly .stat-progress-fill { background: #3b82f6; }
        .stat-card.monthly .stat-progress-fill { background: #a855f7; }
        .stat-card.quarterly .stat-progress-fill { background: #f97316; }
        .stat-card.yearly .stat-progress-fill { background: #ec4899; }

        .stat-progress-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.375rem;
            display: flex;
            justify-content: space-between;
        }

        /* Notification Bell */
        .notification-wrapper {
            position: relative;
        }

        .notification-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.25rem;
            position: relative;
        }

        .notification-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            width: 360px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 200;
            display: none;
            max-height: 500px;
            overflow-y: auto;
        }

        .notification-dropdown.open {
            display: block;
            animation: modalIn 0.2s ease;
        }

        .notification-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .notification-settings-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .notification-settings-btn:hover {
            opacity: 1;
        }

        .notification-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .notification-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .notification-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .notification-list {
            padding: 0.5rem;
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 0.875rem 1rem;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            gap: 0.875rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: var(--bg-tertiary);
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .notification-icon.weekly { background: rgba(59, 130, 246, 0.2); }
        .notification-icon.monthly { background: rgba(168, 85, 247, 0.2); }
        .notification-icon.quarterly { background: rgba(249, 115, 22, 0.2); }
        .notification-icon.yearly { background: rgba(236, 72, 153, 0.2); }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .notification-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-tag {
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .notification-tag.weekly { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .notification-tag.monthly { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .notification-tag.quarterly { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .notification-tag.yearly { background: rgba(236, 72, 153, 0.2); color: #ec4899; }

        .notification-tag.urgent { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .notification-tag.soon { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .notification-tag.upcoming { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .notification-empty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Notification Settings */
        .notification-settings-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .notification-setting-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .notification-setting-item:last-child {
            margin-bottom: 0;
        }

        .notification-setting-info {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .notification-setting-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .notification-setting-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .notification-setting-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .notification-setting-select {
            width: 100%;
        }

        .notification-item.due {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .notification-item.due .notification-icon {
            background: rgba(239, 68, 68, 0.2);
        }

        .notification-due-badge {
            background: #ef4444;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .notification-pin-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.5;
            transition: all 0.2s ease;
            padding: 0.25rem;
        }

        .notification-pin-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .email-status {
            padding: 0.5rem;
            border-radius: 8px;
        }

        .email-status.success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .email-status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .email-status.info {
            color: var(--text-muted);
        }

        .email-setup-guide {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .email-setup-guide h5 {
            margin-bottom: 0.5rem;
            color: var(--accent-primary);
        }

        .email-setup-guide ol {
            margin: 0;
            padding-left: 1.25rem;
            color: var(--text-secondary);
        }

        .email-setup-guide li {
            margin-bottom: 0.375rem;
        }

        .email-setup-guide code {
            background: var(--bg-secondary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
        }

        /* Weekly Progress Section */
        .weekly-progress-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(168, 85, 247, 0.05) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .weekly-progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .weekly-progress-title {
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weekly-progress-content {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .weekly-score-display {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .weekly-score-main {
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }

        .weekly-score-number {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .weekly-score-label {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .weekly-score-message {
            font-size: 0.95rem;
            color: var(--text-secondary);
            flex: 1;
        }

        .weekly-progress-bar-container {
            position: relative;
        }

        .weekly-progress-bar {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .weekly-progress-bar::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: var(--progress, 0%);
            background: linear-gradient(90deg, #a855f7 0%, #ec4899 50%, #22c55e 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .weekly-progress-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 0.375rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .weekly-breakdown {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .weekly-breakdown-item {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 100px;
        }

        .weekly-breakdown-icon {
            font-size: 1.25rem;
        }

        .weekly-breakdown-info {
            flex: 1;
        }

        .weekly-breakdown-count {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .weekly-breakdown-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .weekly-breakdown-points {
            font-size: 0.75rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .weekly-comparison {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
            font-size: 0.875rem;
        }

        .weekly-comparison-icon {
            font-size: 1.25rem;
        }

        .weekly-comparison-positive {
            color: #22c55e;
        }

        .weekly-comparison-negative {
            color: #ef4444;
        }

        .weekly-comparison-neutral {
            color: var(--text-muted);
        }

        /* Weekly History Modal */
        .weekly-history-modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .weekly-history-content {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
        }

        .weekly-history-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }

        .weekly-history-item:last-child {
            margin-bottom: 0;
        }

        .weekly-history-score {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 800;
            flex-shrink: 0;
        }

        .weekly-history-score.excellent {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
            color: #22c55e;
        }

        .weekly-history-score.good {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(168, 85, 247, 0.1) 100%);
            color: #a855f7;
        }

        .weekly-history-score.okay {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2) 0%, rgba(234, 179, 8, 0.1) 100%);
            color: #eab308;
        }

        .weekly-history-score.low {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            color: #ef4444;
        }

        .weekly-history-info {
            flex: 1;
        }

        .weekly-history-date {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .weekly-history-breakdown {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .weekly-history-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Coming Up Section */
        .coming-up-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .coming-up-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .coming-up-title {
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .coming-up-toggle {
            font-size: 0.8rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .coming-up-toggle:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        /* Priority To-Dos Section */
        .priority-todos-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(249, 115, 22, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .priority-todos-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .priority-todos-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .priority-todos-icon {
            font-size: 1.1rem;
        }

        .priority-todos-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .priority-todo-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .priority-todo-item:hover {
            background: var(--bg-tertiary);
        }

        .priority-todo-item.completed {
            opacity: 0.5;
        }

        .priority-todo-item.completed .priority-todo-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .priority-todo-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 0.7rem;
        }

        .priority-todo-checkbox:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .priority-todo-item.completed .priority-todo-checkbox {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        .priority-todo-checkbox.p1 { border-color: #ef4444; }
        .priority-todo-checkbox.p2 { border-color: #f97316; }
        .priority-todo-checkbox.p3 { border-color: #3b82f6; }

        .priority-todo-content {
            flex: 1;
            min-width: 0;
        }

        .priority-todo-title {
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .priority-todo-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .priority-todo-badge {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .priority-todo-badge.p1 { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .priority-todo-badge.p2 { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .priority-todo-badge.p3 { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }

        /* Daily Habits Section */
        .daily-habits-section {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.08) 0%, rgba(249, 115, 22, 0.05) 100%);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .daily-habits-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .daily-habits-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .daily-habits-icon {
            font-size: 1.1rem;
        }

        .daily-habits-reset-info {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
            background: var(--bg-tertiary);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .daily-habits-add-btn {
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid rgba(234, 179, 8, 0.3);
            color: #eab308;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .daily-habits-add-btn:hover {
            background: rgba(234, 179, 8, 0.3);
            transform: scale(1.05);
        }

        .daily-habits-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .daily-habit-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .daily-habit-item:hover {
            border-color: rgba(234, 179, 8, 0.5);
        }

        .daily-habit-item.completed {
            opacity: 0.6;
            background: rgba(34, 197, 94, 0.05);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .daily-habit-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 0.8rem;
        }

        .daily-habit-checkbox:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .daily-habit-item.completed .daily-habit-checkbox {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        .daily-habit-content {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .daily-habit-title {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .daily-habit-item.completed .daily-habit-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .daily-habit-category {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .daily-habit-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.25rem;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .daily-habit-item:hover .daily-habit-remove {
            opacity: 1;
        }

        .daily-habit-remove:hover {
            color: #ef4444;
        }

        .daily-habits-empty {
            text-align: center;
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .pinned-tasks-divider {
            display: none; /* No longer needed */
        }

        /* Frequency Pinned Sections */
        .frequency-pinned-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.875rem;
            margin-top: 0.75rem;
        }

        .frequency-pinned-section.weekly {
            border-left: 3px solid #3b82f6;
        }

        .frequency-pinned-section.monthly {
            border-left: 3px solid #8b5cf6;
        }

        .frequency-pinned-section.quarterly {
            border-left: 3px solid #f97316;
        }

        .frequency-pinned-section.yearly {
            border-left: 3px solid #22c55e;
        }

        .frequency-pinned-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.625rem;
        }

        .frequency-pinned-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .frequency-pinned-icon {
            font-size: 1rem;
        }

        .frequency-reset-info {
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 400;
            background: var(--bg-secondary);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .frequency-pinned-header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .priority-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .priority-dot.p1 {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }

        .priority-dot.p2 {
            background: linear-gradient(135deg, #fb923c, #f97316);
        }

        .priority-dot.p3 {
            background: linear-gradient(135deg, #fdba74, #fb923c);
        }

        .priority-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-left: 0.25rem;
            font-weight: 500;
        }

        .frequency-pinned-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .frequency-pinned-grid {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            max-height: none;
            overflow: visible;
        }

        .frequency-pinned-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 0.625rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            cursor: grab;
        }

        .frequency-pinned-item:hover {
            border-color: var(--border-color);
        }

        .frequency-pinned-item.completed {
            opacity: 0.6;
            background: rgba(34, 197, 94, 0.05);
        }

        .frequency-pinned-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .frequency-pinned-item.drag-over {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
        }

        .frequency-pinned-drag {
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: grab;
            opacity: 0.4;
            transition: opacity 0.2s ease;
            user-select: none;
        }

        .frequency-pinned-item:hover .frequency-pinned-drag {
            opacity: 0.8;
        }

        .frequency-pinned-priority {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .frequency-pinned-priority.p1 { background: linear-gradient(135deg, #f97316, #ea580c); color: white; }
        .frequency-pinned-priority.p2 { background: linear-gradient(135deg, #fb923c, #f97316); color: white; }
        .frequency-pinned-priority.p3 { background: linear-gradient(135deg, #fdba74, #fb923c); color: white; }
        .frequency-pinned-priority.p4 { background: var(--bg-tertiary); color: var(--text-secondary); }
        .frequency-pinned-priority.p5 { background: var(--bg-tertiary); color: var(--text-secondary); }

        .frequency-pinned-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .frequency-pinned-checkbox:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .frequency-pinned-item.completed .frequency-pinned-checkbox {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        /* Partial completion state - shows count in checkbox */
        .frequency-pinned-checkbox:not(:empty):not(.frequency-pinned-item.completed .frequency-pinned-checkbox) {
            background: rgba(234, 179, 8, 0.2);
            border-color: #eab308;
            color: #eab308;
            font-weight: 600;
        }

        .frequency-pinned-content {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .frequency-pinned-task {
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .frequency-pinned-item.completed .frequency-pinned-task {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .frequency-pinned-category {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .frequency-pinned-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .frequency-pinned-item:hover .frequency-pinned-remove {
            opacity: 1;
        }

        .frequency-pinned-remove:hover {
            color: #ef4444;
        }

        .frequency-pinned-empty {
            text-align: center;
            padding: 0.75rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .coming-up-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .coming-up-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 0.875rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
            cursor: grab;
        }

        .coming-up-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .coming-up-item.urgent {
            border-left: 3px solid #ef4444;
        }

        .coming-up-item.soon {
            border-left: 3px solid #eab308;
        }

        .coming-up-item.upcoming {
            border-left: 3px solid #22c55e;
        }

        .coming-up-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .coming-up-item.drag-over {
            border: 2px dashed var(--accent-primary);
        }

        .coming-up-drag {
            cursor: grab;
            color: var(--text-muted);
            opacity: 0.5;
            font-size: 1rem;
            padding: 0.25rem;
            flex-shrink: 0;
        }

        .coming-up-drag:hover {
            opacity: 1;
        }

        .coming-up-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .coming-up-checkbox:hover {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .coming-up-checkbox:hover::after {
            content: '✓';
            color: var(--success);
            font-size: 0.7rem;
            font-weight: 700;
        }

        .coming-up-priority {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .coming-up-priority.p1 {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .coming-up-priority.p2 {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }

        .coming-up-priority.p3 {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .coming-up-priority.p4 {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .coming-up-priority.p5 {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .coming-up-priority.p6 {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .coming-up-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .coming-up-content {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .coming-up-task {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .coming-up-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Recently Completed Section */
        .recently-completed-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .recently-completed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .recently-completed-title {
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recently-completed-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .recently-completed-filter {
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .recently-completed-filter:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .recently-completed-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .rc-stat {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 120px;
        }

        .rc-stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .rc-stat-icon.total { background: rgba(34, 197, 94, 0.2); }
        .rc-stat-icon.daily { background: rgba(34, 197, 94, 0.2); }
        .rc-stat-icon.weekly { background: rgba(59, 130, 246, 0.2); }
        .rc-stat-icon.monthly { background: rgba(168, 85, 247, 0.2); }
        .rc-stat-icon.quarterly { background: rgba(249, 115, 22, 0.2); }

        .rc-stat-info {
            flex: 1;
        }

        .rc-stat-value {
            font-weight: 700;
            font-size: 1.25rem;
            line-height: 1.2;
        }

        .rc-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .recently-completed-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .rc-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .rc-item-check {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .rc-item-content {
            flex: 1;
            min-width: 0;
        }

        .rc-item-title {
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rc-item-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rc-item-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            text-align: right;
            min-width: 100px;
        }

        .rc-item-repeat {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .rc-item-repeat:hover {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .rc-item-delete {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .rc-item-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .rc-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .rc-empty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Task Detail Modal */
        .task-detail-modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .task-detail-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .task-detail-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .task-detail-icon.daily { background: rgba(34, 197, 94, 0.2); }
        .task-detail-icon.weekly { background: rgba(59, 130, 246, 0.2); }
        .task-detail-icon.monthly { background: rgba(168, 85, 247, 0.2); }
        .task-detail-icon.quarterly { background: rgba(249, 115, 22, 0.2); }

        .task-detail-info {
            flex: 1;
            min-width: 0;
        }

        .task-detail-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .task-detail-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .task-detail-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .task-detail-section {
            margin-bottom: 1.5rem;
        }

        .task-detail-section:last-child {
            margin-bottom: 0;
        }

        .task-detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .task-detail-description {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            min-height: 100px;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .task-detail-description[contenteditable="true"]:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .task-detail-description:empty::before {
            content: "Click to add description, instructions, or context...";
            color: var(--text-muted);
        }

        .task-detail-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .task-detail-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Home Task Sections */
        .home-task-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .home-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .home-section .list-section-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
        }

        .home-section .task-list {
            max-height: none;
        }

        /* Day Detail Modal */
        .day-modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .day-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .day-modal-date {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .day-modal-number {
            width: 50px;
            height: 50px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .day-modal-info h3 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .day-modal-info p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .day-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .day-section {
            margin-bottom: 1.5rem;
        }

        .day-section:last-child {
            margin-bottom: 0;
        }

        .day-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .day-section-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .day-section-dot.daily { background: #22c55e; }
        .day-section-dot.weekly { background: #3b82f6; }
        .day-section-dot.monthly { background: #a855f7; }
        .day-section-dot.quarterly { background: #f97316; }

        .day-section-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .day-section-count {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        .day-task-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .day-task-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .day-task-item:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .day-task-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid var(--accent-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            background: var(--bg-card);
        }

        .day-task-checkbox:hover {
            background: var(--accent-glow);
        }

        .day-task-checkbox.checked {
            background: var(--gradient-1);
            border-color: var(--accent-primary);
        }

        .day-task-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .day-task-content {
            flex: 1;
            min-width: 0;
        }

        .day-task-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.125rem;
        }

        .day-task-title.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .day-task-category {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        .no-tasks-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Task Editor Styles */
        .editor-task-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: all 0.2s ease;
        }

        .editor-task-item:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .editor-task-drag {
            color: var(--text-muted);
            cursor: grab;
            padding: 0.25rem;
            opacity: 0.5;
        }

        .editor-task-drag:hover {
            opacity: 1;
        }

        .editor-task-content {
            flex: 1;
            min-width: 0;
        }

        .editor-task-title {
            font-weight: 600;
            font-size: 1rem;
            padding: 0.375rem 0.5rem;
            margin: -0.375rem -0.5rem 0.5rem -0.5rem;
            border-radius: 6px;
            outline: none;
            transition: all 0.2s ease;
            display: block;
        }

        .editor-task-title:hover {
            background: var(--bg-secondary);
        }

        .editor-task-title:focus {
            background: var(--bg-secondary);
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        .editor-task-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .editor-category-select {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .editor-category-select:hover {
            border-color: var(--accent-primary);
        }

        .editor-category-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .editor-delete-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .editor-delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .editor-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .editor-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .editor-empty p {
            margin-bottom: 1rem;
        }


        /* ========== TO-DO VIEW STYLES (Todoist-inspired) ========== */
        .todo-layout {
            display: flex;
            height: calc(100vh - 120px);
            background: var(--bg-secondary);
        }

        .todo-main {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .todo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .todo-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .todo-header-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .todo-view-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .todo-view-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .todo-view-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .todo-sections {
            padding: 0.5rem 0;
        }

        .todo-section {
            margin-bottom: 0.5rem;
        }

        .todo-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
        }

        .todo-section-header:hover {
            background: var(--bg-tertiary);
        }

        .todo-section-toggle {
            color: var(--text-muted);
            font-size: 0.65rem;
            transition: transform 0.2s ease;
            width: 16px;
        }

        .todo-section.collapsed .todo-section-toggle {
            transform: rotate(-90deg);
        }

        .todo-section-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
            flex: 1;
        }

        .todo-section-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .todo-section-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .todo-section-header:hover .todo-section-actions {
            opacity: 1;
        }

        .todo-section-action {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: var(--text-muted);
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .todo-section-action:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .todo-section-items {
            padding: 0;
        }

        .todo-section.collapsed .todo-section-items {
            display: none;
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.625rem 1.5rem 0.625rem 2.5rem;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid var(--border-subtle);
        }

        .todo-item:hover {
            background: var(--bg-tertiary);
        }

        .todo-item.selected {
            background: var(--accent-glow);
        }

        .todo-item.completed {
            opacity: 0.5;
        }

        .todo-item-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-top: 2px;
            font-size: 0.6rem;
        }

        .todo-item-checkbox:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .todo-item.completed .todo-item-checkbox {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        .todo-item.priority-1 .todo-item-checkbox { border-color: #ef4444; }
        .todo-item.priority-2 .todo-item-checkbox { border-color: #f97316; }
        .todo-item.priority-3 .todo-item-checkbox { border-color: #3b82f6; }

        .todo-item-content {
            flex: 1;
            min-width: 0;
        }

        .todo-item-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
            word-break: break-word;
        }

        .todo-item.completed .todo-item-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .todo-item-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .todo-item-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .todo-item-date.overdue {
            color: #ef4444;
        }

        .todo-item-date.today {
            color: #22c55e;
        }

        .todo-item-labels {
            display: flex;
            gap: 0.25rem;
        }

        .todo-item-label {
            font-size: 0.65rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .todo-item-actions {
            display: flex;
            gap: 0.125rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .todo-item:hover .todo-item-actions {
            opacity: 1;
        }

        .todo-item-action {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.375rem;
            color: var(--text-muted);
            font-size: 0.8rem;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .todo-item-action:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .todo-item-assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            background: var(--bg-tertiary);
            flex-shrink: 0;
        }

        .todo-item-assignee-avatar.chad {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .todo-item-assignee-avatar.sloe {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .todo-add-inline {
            display: none;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.625rem 1.5rem 0.625rem 2.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .todo-add-inline.active {
            display: flex;
        }

        .todo-add-checkbox-placeholder {
            width: 18px;
            height: 18px;
            border: 2px dashed var(--border-color);
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .todo-add-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .todo-add-input {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
            width: 100%;
            padding: 0;
        }

        .todo-add-input::placeholder {
            color: var(--text-muted);
        }

        .todo-add-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .todo-add-toolbar-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .todo-add-toolbar-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .todo-add-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .todo-add-submit {
            background: var(--accent-primary);
            border: none;
            color: white;
            padding: 0.375rem 0.875rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }

        .todo-add-submit:hover {
            background: var(--accent-secondary);
        }

        .todo-add-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .todo-add-cancel {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 0.375rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .todo-add-cancel:hover {
            background: var(--bg-tertiary);
        }

        .todo-add-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.875rem;
            padding: 0.625rem 1.5rem 0.625rem 2.5rem;
            width: 100%;
            text-align: left;
            transition: all 0.15s ease;
        }

        .todo-add-btn:hover {
            color: var(--accent-primary);
        }

        .todo-add-btn:hover .todo-add-icon {
            background: var(--accent-primary);
            color: white;
        }

        .todo-add-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--accent-primary);
            transition: all 0.15s ease;
        }

        .todo-add-section-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.8rem;
            padding: 0.75rem 1.5rem;
            width: 100%;
            text-align: left;
            transition: all 0.15s ease;
            border-top: 1px dashed var(--border-color);
            margin-top: 0.5rem;
        }

        .todo-add-section-btn:hover {
            color: var(--accent-primary);
        }

        /* Task Detail Side Panel */
        .todo-detail-panel {
            width: 0;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            overflow: hidden;
            transition: width 0.25s ease;
            display: flex;
            flex-direction: column;
        }

        .todo-detail-panel.open {
            width: 400px;
        }

        .todo-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .todo-detail-actions-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .todo-detail-actions-right {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .todo-detail-complete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .todo-detail-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .todo-detail-complete-btn:hover .todo-detail-checkbox {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .todo-detail-action {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .todo-detail-action:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .todo-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
        }

        .todo-detail-title {
            width: 100%;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            outline: none;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .todo-detail-description {
            width: 100%;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.875rem;
            outline: none;
            resize: none;
            font-family: inherit;
            line-height: 1.5;
            min-height: 60px;
            margin-bottom: 1.5rem;
        }

        .todo-detail-description::placeholder {
            color: var(--text-muted);
        }

        .todo-detail-fields {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .todo-detail-field {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .todo-detail-field-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            width: 80px;
            flex-shrink: 0;
        }

        .todo-detail-field-value {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            color: var(--text-primary);
            outline: none;
        }

        .todo-detail-field-value:focus {
            border-color: var(--accent-primary);
        }

        /* Assignee Dropdown */
        .todo-assignee-wrapper {
            position: relative;
            flex: 1;
        }

        .todo-assignee-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.85rem;
            transition: all 0.15s ease;
        }

        .todo-assignee-btn:hover {
            border-color: var(--accent-primary);
        }

        .todo-assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            background: var(--bg-tertiary);
        }

        .todo-assignee-avatar.chad {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .todo-assignee-avatar.sloe {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .todo-assignee-name {
            flex: 1;
            text-align: left;
        }

        .todo-assignee-arrow {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .todo-assignee-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
            overflow: hidden;
            margin-top: 4px;
        }

        .todo-assignee-dropdown.open {
            display: block;
        }

        .todo-assignee-search {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            outline: none;
        }

        .todo-assignee-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .todo-assignee-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .todo-assignee-option:hover {
            background: var(--bg-tertiary);
        }

        .todo-assignee-option.selected {
            background: var(--accent-glow);
        }

        .todo-assignee-option-avatar {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            background: var(--bg-tertiary);
        }

        .todo-assignee-option-avatar.chad {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .todo-assignee-option-avatar.sloe {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .todo-assignee-option-name {
            flex: 1;
            font-size: 0.85rem;
        }

        .todo-assignee-option-check {
            color: var(--accent-primary);
            font-size: 0.85rem;
            opacity: 0;
        }

        .todo-assignee-option.selected .todo-assignee-option-check {
            opacity: 1;
        }

        .todo-priority-selector {
            display: flex;
            gap: 0.25rem;
        }

        .todo-priority-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.375rem 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0.4;
            transition: all 0.15s ease;
        }

        .todo-priority-btn:hover {
            opacity: 0.7;
        }

        .todo-priority-btn.active {
            opacity: 1;
            border-color: currentColor;
        }

        .todo-priority-btn.p1 { color: #ef4444; }
        .todo-priority-btn.p2 { color: #f97316; }
        .todo-priority-btn.p3 { color: #3b82f6; }
        .todo-priority-btn.p4 { color: var(--text-muted); }

        .todo-detail-subtasks {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .todo-detail-subtasks-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .todo-detail-subtasks-header span {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .todo-add-subtask-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .todo-add-subtask-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }

        .todo-subtasks-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .todo-subtask-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0;
        }

        .todo-subtask-checkbox {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            transition: all 0.15s ease;
        }

        .todo-subtask-checkbox:hover {
            border-color: #22c55e;
        }

        .todo-subtask-item.completed .todo-subtask-checkbox {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        .todo-subtask-title {
            font-size: 0.85rem;
            color: var(--text-primary);
            flex: 1;
        }

        .todo-subtask-item.completed .todo-subtask-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .todo-subtask-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            padding: 0.25rem;
            font-size: 0.75rem;
        }

        .todo-subtask-item:hover .todo-subtask-delete {
            opacity: 1;
        }

        /* ========== ANALYTICS VIEW STYLES ========== */
        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .analytics-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .analytics-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .analytics-stats-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-stats-row.three-col {
            grid-template-columns: 2fr 1fr 1fr;
        }

        /* Analytics Overview - New Unified Design */
        .analytics-overview {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            align-items: stretch;
        }

        .analytics-totals {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 200px;
        }

        .analytics-total-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .analytics-total-card.fans {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(249, 115, 22, 0.1) 100%);
            border-color: var(--accent-primary);
        }

        .analytics-total-card.subs {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-color: #8b5cf6;
        }

        .analytics-total-icon {
            font-size: 2rem;
        }

        .analytics-total-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .analytics-total-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .analytics-total-card.fans .analytics-total-value {
            color: var(--accent-primary);
        }

        .analytics-total-card.subs .analytics-total-value {
            color: #8b5cf6;
        }

        .analytics-stats-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 120px repeat(3, 1fr);
            gap: 0.75rem;
            align-content: center;
        }

        .analytics-stats-label {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-primary);
            padding-right: 0.5rem;
        }

        .analytics-stats-label.purple {
            color: #8b5cf6;
        }

        .analytics-mini-stat {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            text-align: center;
        }

        .analytics-mini-stat.purple {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(139, 92, 246, 0.08) 100%);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .analytics-mini-stat.blank {
            background: transparent;
            border: none;
        }

        .mini-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.25rem;
        }

        .mini-stat-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .mini-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .mini-stat-sub {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        .analytics-mini-stat.purple .mini-stat-value {
            color: #8b5cf6;
        }

        @media (max-width: 900px) {
            .analytics-overview {
                flex-direction: column;
            }
            .analytics-totals {
                flex-direction: row;
            }
            .analytics-stats-grid {
                grid-template-columns: 100px repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .analytics-totals {
                flex-direction: column;
            }
            .analytics-stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            .analytics-stats-label {
                grid-column: 1 / -1;
                justify-content: center;
                padding: 0.5rem 0;
            }
        }

        .analytics-stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .analytics-stat-card.main {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(249, 115, 22, 0.1) 100%);
            border-color: var(--accent-primary);
        }

        .analytics-stat-icon {
            font-size: 2rem;
        }

        .analytics-stat-content {
            flex: 1;
        }

        .analytics-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .analytics-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .analytics-stat-card.main .analytics-stat-value {
            color: var(--accent-primary);
        }

        .analytics-stat-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Split Goals Layout */
        .analytics-goals-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .goals-column {
            margin-bottom: 0;
        }

        .goals-column .analytics-goals {
            max-height: none;
        }

        @media (max-width: 1024px) {
            .analytics-goals-split {
                grid-template-columns: 1fr;
            }
        }

        .analytics-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .analytics-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .analytics-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* Shopify Section */
        .shopify-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(150, 191, 72, 0.05) 100%);
            border: 1px solid rgba(150, 191, 72, 0.2);
        }

        .shopify-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .shopify-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .shopify-stat-icon {
            font-size: 1.5rem;
        }

        .shopify-stat-content {
            flex: 1;
        }

        .shopify-stat-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .shopify-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #96bf48;
        }

        .shopify-stat-sub {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .shopify-recent-orders {
            margin-top: 1rem;
        }

        .shopify-recent-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .shopify-orders-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .shopify-order-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .shopify-order-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .shopify-order-number {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .shopify-order-customer {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .shopify-order-date {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .shopify-order-amount {
            font-weight: 600;
            color: #96bf48;
            font-size: 0.9rem;
        }

        .shopify-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .shopify-error {
            text-align: center;
            padding: 1rem;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .shopify-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Goals */
        .analytics-goals {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .analytics-goal {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 1rem 1.25rem;
        }

        .analytics-goal.achieved {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .analytics-goal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .analytics-goal-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analytics-goal-label .goal-icon {
            font-size: 1rem;
        }

        .analytics-goal.achieved .analytics-goal-label {
            color: #22c55e;
        }

        .analytics-goal-target {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .analytics-goal-target span {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .analytics-goal-progress {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .analytics-goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .analytics-goal.achieved .analytics-goal-progress-bar {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .analytics-goal-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .analytics-goal-percent {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .analytics-goal.achieved .analytics-goal-percent {
            color: #22c55e;
        }

        /* Chart */
        .analytics-chart-container {
            height: 300px;
            position: relative;
        }

        /* History */
        .analytics-history {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .analytics-history-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .analytics-history-item.subs-entry {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(139, 92, 246, 0.08) 100%);
        }

        .analytics-history-type {
            font-size: 1rem;
            min-width: 24px;
            text-align: center;
        }

        .analytics-history-date {
            font-size: 0.8rem;
            color: var(--text-muted);
            min-width: 100px;
        }

        .analytics-history-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .analytics-history-item.subs-entry .analytics-history-value {
            color: #8b5cf6;
        }

        .analytics-history-change {
            font-size: 0.8rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .analytics-history-change.positive {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .analytics-history-change.negative {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .analytics-history-revenue {
            font-size: 0.75rem;
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .analytics-history-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            flex: 1;
            text-align: right;
        }

        .analytics-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .analytics-stats-row {
                grid-template-columns: 1fr;
            }
            
            .analytics-goal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
        }

        .analytics-header-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Notification Toggle Options */
        .notify-option {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 0.75rem;
        }

        .notify-option-content {
            flex: 1;
        }

        .notify-option-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .notify-option-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .notify-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .notify-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .notify-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: 0.3s;
            border-radius: 24px;
        }

        .notify-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-muted);
            transition: 0.3s;
            border-radius: 50%;
        }

        .notify-toggle input:checked + .notify-toggle-slider {
            background-color: var(--accent-primary);
        }

        .notify-toggle input:checked + .notify-toggle-slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        .notification-close-mobile {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .todo-add-btn.hidden {
            display: none;
        }

        .todo-completed-toggle {
            padding: 0.5rem 1.5rem 0.5rem 2.5rem;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .todo-completed-toggle:hover {
            color: var(--text-primary);
        }

        .todo-completed-items {
            opacity: 0.6;
        }

        @media (max-width: 900px) {
            .todo-detail-panel.open {
                width: 100%;
                position: fixed;
                top: 0;
                right: 0;
                height: 100vh;
                z-index: 100;
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-bar {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .header-content {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .calendar-grid {
                font-size: 0.85rem;
            }
            
            .calendar-day {
                min-height: 100px;
                padding: 0.5rem;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .coming-up-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            /* Mobile Header */
            .header {
                padding: 0.75rem 1rem;
            }

            .header-content {
                display: grid;
                grid-template-columns: 1fr auto auto;
                grid-template-rows: auto auto;
                gap: 0.75rem;
                align-items: center;
            }

            .logo {
                grid-column: 1;
                grid-row: 1;
            }

            .logo-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .logo-text {
                font-size: 1.1rem;
            }

            .logo-sub {
                display: none;
            }

            .view-tabs {
                grid-column: 1 / -1;
                grid-row: 2;
                width: 100%;
                justify-content: center;
                gap: 0.25rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .view-tabs::-webkit-scrollbar {
                display: none;
            }

            .view-tab {
                flex: 0 0 auto;
                justify-content: center;
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .todo-tab-badge {
                font-size: 0.6rem;
                padding: 0.1rem 0.3rem;
                min-width: 14px;
            }

            .header-actions {
                grid-column: 2 / -1;
                grid-row: 1;
                gap: 0.5rem;
            }

            .header-actions .btn-secondary {
                display: none;
            }

            .header-actions .btn-primary {
                padding: 0.5rem 0.875rem;
                font-size: 0.8rem;
            }

            .theme-toggle,
            .notification-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .notification-badge {
                width: 16px;
                height: 16px;
                font-size: 0.6rem;
            }

            .main {
                padding: 1rem;
            }

            /* Mobile Stats - Compact horizontal strip */
            .stats-bar {
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
                padding-bottom: 0.5rem;
                margin-bottom: 1rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .stats-bar::-webkit-scrollbar {
                display: none;
            }

            .stat-card {
                flex: 0 0 auto;
                min-width: 100px;
                padding: 0.75rem;
                border-radius: 10px;
            }

            .stat-label {
                font-size: 0.55rem;
                margin-bottom: 0.25rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .stat-progress {
                display: none;
            }

            /* Mobile Coming Up - Simplified */
            .coming-up-section {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }

            .coming-up-header {
                margin-bottom: 0.75rem;
            }

            .coming-up-title {
                font-size: 0.9rem;
            }

            .coming-up-grid {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .coming-up-item {
                padding: 0.75rem;
                border-radius: 8px;
                gap: 0.5rem;
            }

            .coming-up-drag {
                font-size: 0.85rem;
                padding: 0.125rem;
            }

            .coming-up-priority {
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
            }

            .coming-up-icon {
                font-size: 1rem;
            }

            .coming-up-task {
                font-size: 0.85rem;
            }

            .coming-up-meta {
                font-size: 0.65rem;
            }

            /* Mobile Task Sections - Accordion style */
            .home-task-sections {
                gap: 0.75rem;
            }

            .home-section {
                padding: 0;
                border-radius: 12px;
                overflow: hidden;
            }

            .home-section .list-section-header {
                padding: 1rem;
                margin-bottom: 0;
                border-bottom: none;
                cursor: pointer;
                background: var(--bg-card);
            }

            .list-section-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }

            .list-section-title {
                font-size: 0.95rem;
                flex: 1;
            }

            .list-section-badge {
                display: none;
            }

            .home-section .task-list {
                padding: 0 0.75rem 0.75rem 0.75rem;
            }

            .task-item {
                padding: 0.75rem;
                border-radius: 10px;
                margin-bottom: 0.5rem;
            }

            .task-checkbox {
                width: 20px;
                height: 20px;
            }

            .task-title {
                font-size: 0.85rem;
            }

            .task-category {
                font-size: 0.6rem;
                padding: 0.2rem 0.5rem;
            }

            .task-actions {
                opacity: 1;
            }

            .task-action-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            /* Mobile Calendar */
            .calendar-header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
                margin-bottom: 1rem;
            }

            .calendar-nav {
                justify-content: center;
            }

            .calendar-nav-btn {
                width: 36px;
                height: 36px;
            }

            .calendar-title {
                font-size: 1.25rem;
            }

            #todayBtn {
                align-self: center;
            }

            .calendar-grid {
                border-radius: 12px;
            }

            .calendar-day-header {
                padding: 0.5rem 0.25rem;
                font-size: 0.6rem;
            }

            .calendar-day {
                min-height: 60px;
                padding: 0.375rem;
            }

            .day-number {
                font-size: 0.7rem;
            }

            .task-pill {
                font-size: 0.5rem;
                padding: 0.1rem 0.2rem;
                border-left-width: 1px;
            }

            /* Mobile Modals - Bottom sheet style */
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }

            .modal {
                border-radius: 20px 20px 0 0;
                max-height: 85vh;
                width: 100%;
                max-width: 100%;
            }

            .day-modal {
                border-radius: 20px 20px 0 0;
                max-height: 85vh;
                width: 100%;
                max-width: 100%;
            }

            .modal-header,
            .day-modal-header {
                padding: 1.25rem 1rem;
            }

            .modal-body,
            .day-modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .day-modal-number {
                width: 44px;
                height: 44px;
                font-size: 1.25rem;
            }

            .day-modal-info h3 {
                font-size: 1.1rem;
            }

            .day-modal-info p {
                font-size: 0.8rem;
            }

            .day-section-header {
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .day-section-title {
                font-size: 0.85rem;
            }

            .day-task-item {
                padding: 0.625rem 0.75rem;
            }

            .day-task-checkbox {
                width: 18px;
                height: 18px;
            }

            .day-task-title {
                font-size: 0.85rem;
            }

            .day-task-category {
                font-size: 0.65rem;
            }

            /* Mobile Editor Modal */
            .editor-task-item {
                padding: 0.875rem;
            }

            .editor-task-title {
                font-size: 0.9rem;
            }

            .editor-task-drag {
                display: none;
            }

            .editor-category-select {
                font-size: 0.7rem;
                padding: 0.3rem 0.6rem;
            }

            .editor-delete-btn {
                width: 28px;
                height: 28px;
            }

            /* Mobile Notification Dropdown */
            .notification-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: 20px 20px 0 0;
                max-height: 70vh;
            }

            .notification-header {
                padding: 1rem;
                font-size: 1rem;
            }

            .notification-list {
                padding: 0.5rem;
            }

            .notification-item {
                padding: 0.75rem;
            }

            .notification-icon {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .notification-title {
                font-size: 0.85rem;
            }

            .notification-meta {
                font-size: 0.7rem;
            }

            .notification-tag {
                font-size: 0.55rem;
                padding: 0.1rem 0.4rem;
            }

            /* Mobile Ideas Panel */
            .auto-panel {
                width: 100%;
                right: -100%;
            }

            .auto-panel.open {
                right: 0;
            }

            .auto-panel-header {
                padding: 1rem;
            }

            .auto-panel-title {
                font-size: 1rem;
            }

            .auto-panel-content {
                padding: 1rem;
            }

            .idea-card {
                padding: 0.875rem;
                margin-bottom: 0.75rem;
            }

            .idea-type {
                font-size: 0.6rem;
            }

            .idea-title {
                font-size: 0.9rem;
            }

            .idea-desc {
                font-size: 0.8rem;
            }

            /* Mobile Form Inputs */
            .form-group {
                margin-bottom: 1rem;
            }

            .form-label {
                font-size: 0.8rem;
            }

            .form-input {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 380px) {
            .logo-text {
                font-size: 1rem;
            }

            .view-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .stat-card {
                min-width: 85px;
                padding: 0.625rem;
            }

            .stat-value {
                font-size: 1.1rem;
            }

            .calendar-day {
                min-height: 50px;
            }

            .task-pill {
                display: none;
            }

            .task-pill:first-child {
                display: block;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ========== COMPREHENSIVE MOBILE OPTIMIZATIONS ========== */
        @media (max-width: 600px) {
            /* Fix notification dropdown close button */
            .notification-dropdown {
                z-index: 1001;
            }
            
            .notification-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                background: var(--bg-card);
                z-index: 1;
            }
            
            .notification-close-mobile {
                display: flex;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: var(--bg-tertiary);
                border: none;
                color: var(--text-primary);
                font-size: 1.2rem;
                cursor: pointer;
                align-items: center;
                justify-content: center;
            }
            
            /* Analytics Header - Clean up buttons */
            .analytics-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .analytics-title {
                font-size: 1.25rem;
                text-align: center;
            }
            
            .analytics-header-actions {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }
            
            .analytics-header-actions .btn {
                padding: 0.6rem 0.875rem;
                font-size: 0.75rem;
            }
            
            .analytics-header-actions .btn-secondary {
                padding: 0.6rem;
            }
            
            /* Analytics Overview - Stack vertically */
            .analytics-overview {
                flex-direction: column;
                gap: 1rem;
            }
            
            .analytics-totals {
                flex-direction: row;
                gap: 0.75rem;
            }
            
            .analytics-total-card {
                flex: 1;
                padding: 1rem;
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
            
            .analytics-total-icon {
                font-size: 1.5rem;
            }
            
            .analytics-total-value {
                font-size: 1.5rem;
            }
            
            .analytics-total-label {
                font-size: 0.65rem;
            }
            
            /* Analytics Stats Grid - Compact 2-column */
            .analytics-stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            .analytics-stats-label {
                grid-column: 1 / -1;
                justify-content: center;
                padding: 0.5rem 0 0.25rem;
                font-size: 0.75rem;
            }
            
            .analytics-mini-stat {
                padding: 0.6rem 0.5rem;
            }
            
            .mini-stat-icon {
                font-size: 1rem;
                margin-bottom: 0.15rem;
            }
            
            .mini-stat-label {
                font-size: 0.55rem;
            }
            
            .mini-stat-value {
                font-size: 1rem;
            }
            
            .mini-stat-sub {
                font-size: 0.55rem;
            }
            
            .analytics-mini-stat.blank {
                display: none;
            }
            
            /* Goals Split - Stack vertically */
            .analytics-goals-split {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .goals-column {
                padding: 1rem;
            }
            
            .analytics-section-title {
                font-size: 0.9rem;
            }
            
            .analytics-goal {
                padding: 0.875rem;
                margin-bottom: 0.5rem;
            }
            
            .analytics-goal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .analytics-goal-label {
                font-size: 0.9rem;
            }
            
            .analytics-goal-target {
                font-size: 0.75rem;
            }
            
            .analytics-goal-stats {
                font-size: 0.75rem;
            }
            
            /* Home Page Task Sections - More compact */
            .home-section {
                margin-bottom: 0.75rem;
            }
            
            .home-section .list-section-header {
                padding: 0.875rem;
            }
            
            .list-section-icon {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            .list-section-title {
                font-size: 0.85rem;
            }
            
            .list-section-count {
                font-size: 0.75rem;
            }
            
            /* Task Items - Cleaner mobile layout */
            .task-item {
                padding: 0.625rem 0.75rem;
                margin-bottom: 0.375rem;
                gap: 0.5rem;
            }
            
            .task-drag {
                display: none;
            }
            
            .task-priority {
                width: 22px;
                height: 22px;
                font-size: 0.65rem;
            }
            
            .task-checkbox {
                width: 22px;
                height: 22px;
            }
            
            .task-content {
                min-width: 0;
            }
            
            .task-title {
                font-size: 0.8rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .task-category {
                font-size: 0.55rem;
                padding: 0.15rem 0.4rem;
            }
            
            .task-actions {
                gap: 0.25rem;
            }
            
            .task-action-btn {
                width: 26px;
                height: 26px;
                font-size: 0.75rem;
            }
            
            /* Daily Habits - Compact grid */
            .daily-habits-grid {
                gap: 0.5rem;
            }
            
            .daily-habit-card {
                padding: 0.75rem;
            }
            
            .habit-emoji {
                font-size: 1.25rem;
            }
            
            .habit-name {
                font-size: 0.7rem;
            }
            
            /* Weekly Progress - Scrollable */
            .weekly-progress-bars {
                gap: 0.5rem;
            }
            
            .progress-item {
                padding: 0.5rem 0.625rem;
            }
            
            .progress-label {
                font-size: 0.65rem;
                min-width: 50px;
            }
            
            .progress-value {
                font-size: 0.65rem;
                min-width: 35px;
            }
            
            /* Pinned Tasks - Compact */
            .frequency-pinned-section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .frequency-pinned-header {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .frequency-pinned-title {
                font-size: 0.85rem;
            }
            
            .frequency-reset-info {
                font-size: 0.6rem;
            }
            
            .frequency-pinned-grid {
                gap: 0.375rem;
            }
            
            .pinned-task-item {
                padding: 0.5rem 0.625rem;
                gap: 0.375rem;
            }
            
            .pinned-task-priority {
                width: 20px;
                height: 20px;
                font-size: 0.6rem;
            }
            
            .pinned-task-checkbox {
                width: 20px;
                height: 20px;
            }
            
            .pinned-task-title {
                font-size: 0.75rem;
            }
            
            .pinned-task-category {
                display: none;
            }
            
            /* Recently Completed - Compact */
            .recently-completed-section {
                padding: 0.875rem;
            }
            
            .recently-completed-header {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .recently-completed-title {
                font-size: 0.85rem;
            }
            
            .recently-completed-filter {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            
            .recently-completed-stats {
                gap: 0.375rem;
                margin-bottom: 0.75rem;
            }
            
            .rc-stat {
                padding: 0.5rem;
                min-width: 60px;
            }
            
            .rc-stat-value {
                font-size: 1rem;
            }
            
            .rc-stat-label {
                font-size: 0.55rem;
            }
            
            /* Priority To-dos Section */
            .priority-todos-section {
                padding: 0.875rem;
                margin-bottom: 0.75rem;
            }
            
            .priority-todo-item {
                padding: 0.625rem;
            }
            
            .priority-badge {
                font-size: 0.55rem;
                padding: 0.15rem 0.35rem;
            }
            
            /* To-Do View */
            .todo-container {
                padding: 0.75rem;
            }
            
            .todo-section-header {
                padding: 0.75rem;
            }
            
            .todo-section-title {
                font-size: 0.85rem;
            }
            
            .todo-item {
                padding: 0.625rem 0.75rem;
            }
            
            .todo-item-title {
                font-size: 0.8rem;
            }
            
            /* Notification Settings Modal Fix */
            .analytics-notify-modal .modal {
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .notify-option {
                padding: 0.75rem 0;
            }
            
            .notify-option-info h4 {
                font-size: 0.85rem;
            }
            
            .notify-option-info p {
                font-size: 0.7rem;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 380px) {
            .analytics-totals {
                flex-direction: column;
            }
            
            .analytics-total-card {
                flex-direction: row;
                text-align: left;
                justify-content: flex-start;
            }
            
            .analytics-header-actions .btn {
                padding: 0.5rem 0.625rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">SJ</div>
                <div>
                    <div class="logo-text">SLOE JACK</div>
                    <div class="logo-sub">Subscriber Content Planner</div>
                </div>
            </div>
            
            <div class="view-tabs">
                <button class="view-tab active" data-view="home">🏠 Home</button>
                <button class="view-tab todo-tab" data-view="todo">
                    📝 To-Do
                    <span class="todo-tab-badge" id="headerTodoBadge">0</span>
                </button>
                <button class="view-tab" data-view="analytics">📊 Analytics</button>
                <button class="view-tab" data-view="calendar">📅 Calendar</button>
            </div>
            
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    <span id="themeIcon">🌙</span>
                </button>
                <div class="notification-wrapper">
                    <button class="notification-btn" id="notificationBtn" title="Notifications">
                        🔔
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <span>🔔 Notifications</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="notification-settings-btn" id="notificationSettingsBtn" title="Settings">⚙️</button>
                                <button class="notification-close-mobile" id="notificationCloseMobile" title="Close">✕</button>
                            </div>
                        </div>
                        <div class="notification-tabs">
                            <button class="notification-tab active" data-tab="due">Due Now</button>
                            <button class="notification-tab" data-tab="upcoming">Coming Up</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" id="ideasBtn">
                    💡 Ideas
                </button>
                <button class="btn btn-primary" id="addTaskBtn">
                    ＋ Add Task
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Home View -->
        <div class="list-view active" id="homeView">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-card daily" onclick="openTaskEditor('daily')">
                    <div class="stat-label">Daily Tasks</div>
                    <div class="stat-value" id="dailyCount">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill" id="dailyProgress" style="width: 0%"></div>
                        </div>
                        <div class="stat-progress-text">
                            <span id="dailyCompleted">0 done</span>
                            <span id="dailyRemaining">0 left</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card weekly" onclick="openTaskEditor('weekly')">
                    <div class="stat-label">Weekly Tasks</div>
                    <div class="stat-value" id="weeklyCount">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill" id="weeklyProgress" style="width: 0%"></div>
                        </div>
                        <div class="stat-progress-text">
                            <span id="weeklyCompleted">0 done</span>
                            <span id="weeklyRemaining">0 left</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card monthly" onclick="openTaskEditor('monthly')">
                    <div class="stat-label">Monthly Tasks</div>
                    <div class="stat-value" id="monthlyCount">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill" id="monthlyProgress" style="width: 0%"></div>
                        </div>
                        <div class="stat-progress-text">
                            <span id="monthlyCompleted">0 done</span>
                            <span id="monthlyRemaining">0 left</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card quarterly" onclick="openTaskEditor('quarterly')">
                    <div class="stat-label">Quarterly Tasks</div>
                    <div class="stat-value" id="quarterlyCount">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill" id="quarterlyProgress" style="width: 0%"></div>
                        </div>
                        <div class="stat-progress-text">
                            <span id="quarterlyCompleted">0 done</span>
                            <span id="quarterlyRemaining">0 left</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card yearly" onclick="openTaskEditor('yearly')">
                    <div class="stat-label">Yearly Tasks</div>
                    <div class="stat-value" id="yearlyCount">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill" id="yearlyProgress" style="width: 0%"></div>
                        </div>
                        <div class="stat-progress-text">
                            <span id="yearlyCompleted">0 done</span>
                            <span id="yearlyRemaining">0 left</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly Progress Section -->
            <div class="weekly-progress-section" id="weeklyProgressSection">
                <div class="weekly-progress-header">
                    <div class="weekly-progress-title">🏆 Weekly Progress</div>
                    <button class="coming-up-toggle" id="weeklyHistoryBtn">View History</button>
                </div>
                <div class="weekly-progress-content">
                    <div class="weekly-score-display">
                        <div class="weekly-score-main">
                            <div class="weekly-score-number" id="weeklyScoreNumber">0</div>
                            <div class="weekly-score-label">/ 10</div>
                        </div>
                        <div class="weekly-score-message" id="weeklyScoreMessage">Start completing tasks!</div>
                    </div>
                    <div class="weekly-progress-bar-container">
                        <div class="weekly-progress-bar" id="weeklyProgressBar"></div>
                        <div class="weekly-progress-markers">
                            <span>0</span>
                            <span>5</span>
                            <span>10</span>
                        </div>
                    </div>
                    <div class="weekly-breakdown" id="weeklyBreakdown">
                        <!-- Populated by JS -->
                    </div>
                    <div class="weekly-comparison" id="weeklyComparison">
                        <!-- Last week comparison -->
                    </div>
                </div>
            </div>

            <!-- Weekly History Modal -->
            <div class="modal-overlay" id="weeklyHistoryModal">
                <div class="weekly-history-modal">
                    <div class="modal-header">
                        <h3 class="modal-title">📊 Score History</h3>
                        <button class="auto-panel-close" id="closeWeeklyHistory">✕</button>
                    </div>
                    <div class="weekly-history-content" id="weeklyHistoryContent">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Coming Up Section -->
            <div class="coming-up-section" id="comingUpSection">
                <div class="coming-up-header">
                    <div class="coming-up-title">📌 Pinned Tasks</div>
                    <button class="coming-up-toggle" id="comingUpToggle">Hide</button>
                </div>
                
                <!-- Priority To-Dos Section (from To-Do list) -->
                <div class="priority-todos-section" id="priorityTodosSection" style="display: none;">
                    <div class="priority-todos-header">
                        <div class="priority-todos-title">
                            <span class="priority-todos-icon">🚩</span>
                            <span>Priority To-Dos</span>
                        </div>
                    </div>
                    <div class="priority-todos-list" id="priorityTodosList">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Daily Habits Subsection -->
                <div class="daily-habits-section" id="dailyHabitsSection">
                    <div class="daily-habits-header">
                        <div class="daily-habits-title">
                            <span class="daily-habits-icon">☀️</span>
                            <span>Daily Habits</span>
                            <span class="daily-habits-reset-info">Resets at midnight</span>
                        </div>
                        <button class="daily-habits-add-btn" id="addDailyHabitBtn" title="Add daily habit">＋</button>
                    </div>
                    <div class="daily-habits-grid" id="dailyHabitsGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Weekly Pinned Tasks -->
                <div class="frequency-pinned-section weekly" id="weeklyPinnedSection">
                    <div class="frequency-pinned-header">
                        <div class="frequency-pinned-title">
                            <span class="frequency-pinned-icon">📆</span>
                            <span>Weekly</span>
                            <span class="frequency-reset-info">Resets Sunday</span>
                        </div>
                        <div class="frequency-pinned-header-right">
                            <div class="priority-indicator">
                                <span class="priority-dot p1"></span>
                                <span class="priority-dot p2"></span>
                                <span class="priority-dot p3"></span>
                                <span class="priority-label">Priority</span>
                            </div>
                            <span class="frequency-pinned-count" id="weeklyPinnedCount">0/15</span>
                        </div>
                    </div>
                    <div class="frequency-pinned-grid" id="weeklyPinnedGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Monthly Pinned Tasks -->
                <div class="frequency-pinned-section monthly" id="monthlyPinnedSection">
                    <div class="frequency-pinned-header">
                        <div class="frequency-pinned-title">
                            <span class="frequency-pinned-icon">🗓️</span>
                            <span>Monthly</span>
                            <span class="frequency-reset-info">Resets 1st</span>
                        </div>
                        <div class="frequency-pinned-header-right">
                            <div class="priority-indicator">
                                <span class="priority-dot p1"></span>
                                <span class="priority-dot p2"></span>
                                <span class="priority-dot p3"></span>
                                <span class="priority-label">Priority</span>
                            </div>
                            <span class="frequency-pinned-count" id="monthlyPinnedCount">0/15</span>
                        </div>
                    </div>
                    <div class="frequency-pinned-grid" id="monthlyPinnedGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Quarterly Pinned Tasks -->
                <div class="frequency-pinned-section quarterly" id="quarterlyPinnedSection">
                    <div class="frequency-pinned-header">
                        <div class="frequency-pinned-title">
                            <span class="frequency-pinned-icon">📊</span>
                            <span>Quarterly</span>
                            <span class="frequency-reset-info">Resets Q1/Q2/Q3/Q4</span>
                        </div>
                        <div class="frequency-pinned-header-right">
                            <div class="priority-indicator">
                                <span class="priority-dot p1"></span>
                                <span class="priority-dot p2"></span>
                                <span class="priority-dot p3"></span>
                                <span class="priority-label">Priority</span>
                            </div>
                            <span class="frequency-pinned-count" id="quarterlyPinnedCount">0/15</span>
                        </div>
                    </div>
                    <div class="frequency-pinned-grid" id="quarterlyPinnedGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Yearly Pinned Tasks -->
                <div class="frequency-pinned-section yearly" id="yearlyPinnedSection">
                    <div class="frequency-pinned-header">
                        <div class="frequency-pinned-title">
                            <span class="frequency-pinned-icon">🎯</span>
                            <span>Yearly</span>
                            <span class="frequency-reset-info">Resets Jan 1</span>
                        </div>
                        <div class="frequency-pinned-header-right">
                            <div class="priority-indicator">
                                <span class="priority-dot p1"></span>
                                <span class="priority-dot p2"></span>
                                <span class="priority-dot p3"></span>
                                <span class="priority-label">Priority</span>
                            </div>
                            <span class="frequency-pinned-count" id="yearlyPinnedCount">0/15</span>
                        </div>
                    </div>
                    <div class="frequency-pinned-grid" id="yearlyPinnedGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Recently Completed Section -->
            <div class="recently-completed-section" id="recentlyCompletedSection">
                <div class="recently-completed-header">
                    <div class="recently-completed-title">✅ Recently Completed</div>
                    <div class="recently-completed-controls">
                        <select class="recently-completed-filter" id="recentlyCompletedFilter">
                            <option value="week">This Week</option>
                            <option value="lastweek">Last Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="coming-up-toggle" id="recentlyCompletedToggle">Hide</button>
                    </div>
                </div>
                <div class="recently-completed-stats" id="recentlyCompletedStats">
                    <!-- Stats populated by JS -->
                </div>
                <div class="recently-completed-list" id="recentlyCompletedList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div class="list-view" id="calendarView">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="prevMonth">‹</button>
                    <h2 class="calendar-title" id="calendarTitle">January 2026</h2>
                    <button class="calendar-nav-btn" id="nextMonth">›</button>
                </div>
                <button class="btn btn-secondary" id="todayBtn">Today</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- Analytics View -->
        <div class="list-view" id="analyticsView">
            <div class="analytics-container">
                <div class="analytics-header">
                    <h1 class="analytics-title">📊 Fan Analytics</h1>
                    <div class="analytics-header-actions">
                        <button class="btn btn-secondary" id="analyticsNotifyBtn" title="Notification Settings">🔔</button>
                        <button class="btn btn-primary" id="updateStatsBtn">+ Update Fans</button>
                        <button class="btn btn-primary paid-btn" id="updatePaidStatsBtn">+ Update Subs</button>
                    </div>
                </div>

                <!-- Analytics Stats - Unified Design -->
                <div class="analytics-overview">
                    <!-- Left Side - Totals -->
                    <div class="analytics-totals">
                        <div class="analytics-total-card fans">
                            <div class="analytics-total-icon">👥</div>
                            <div class="analytics-total-content">
                                <div class="analytics-total-label">Email + SMS</div>
                                <div class="analytics-total-value" id="currentSubscribers">2,161</div>
                            </div>
                        </div>
                        <div class="analytics-total-card subs">
                            <div class="analytics-total-icon">💎</div>
                            <div class="analytics-total-content">
                                <div class="analytics-total-label">Paid Subscribers</div>
                                <div class="analytics-total-value" id="currentPaidSubscribers">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Side - Stats Grid -->
                    <div class="analytics-stats-grid">
                        <!-- Email + SMS Row -->
                        <div class="analytics-stats-label">📧 Email + SMS</div>
                        <div class="analytics-mini-stat">
                            <div class="mini-stat-icon">📈</div>
                            <div class="mini-stat-label">This Week</div>
                            <div class="mini-stat-value" id="weeklyGrowth">+0</div>
                            <div class="mini-stat-sub">new fans</div>
                        </div>
                        <div class="analytics-mini-stat">
                            <div class="mini-stat-icon">📅</div>
                            <div class="mini-stat-label">This Month</div>
                            <div class="mini-stat-value" id="monthlyGrowth">+0</div>
                            <div class="mini-stat-sub">new fans</div>
                        </div>
                        <div class="analytics-mini-stat blank"></div>
                        
                        <!-- Paid Subscribers Row -->
                        <div class="analytics-stats-label purple">💎 Paid Subs</div>
                        <div class="analytics-mini-stat purple">
                            <div class="mini-stat-icon">📈</div>
                            <div class="mini-stat-label">This Week</div>
                            <div class="mini-stat-value" id="paidWeeklyGrowth">+0</div>
                            <div class="mini-stat-sub">new subs</div>
                        </div>
                        <div class="analytics-mini-stat purple">
                            <div class="mini-stat-icon">📅</div>
                            <div class="mini-stat-label">This Month</div>
                            <div class="mini-stat-value" id="paidMonthlyGrowth">+0</div>
                            <div class="mini-stat-sub">new subs</div>
                        </div>
                        <div class="analytics-mini-stat purple">
                            <div class="mini-stat-icon">💰</div>
                            <div class="mini-stat-label">Monthly Rev</div>
                            <div class="mini-stat-value" id="monthlyRevenue">$0</div>
                            <div class="mini-stat-sub">recurring</div>
                        </div>
                    </div>
                </div>

                <!-- Goals Section - Split View -->
                <div class="analytics-goals-split">
                    <div class="analytics-section goals-column">
                        <div class="analytics-section-header">
                            <h2 class="analytics-section-title">👥 Email + SMS Goals</h2>
                        </div>
                        <div class="analytics-goals" id="analyticsGoals">
                            <!-- Goals populated by JS -->
                        </div>
                    </div>
                    <div class="analytics-section goals-column">
                        <div class="analytics-section-header">
                            <h2 class="analytics-section-title">💎 Paid Subscriber Goals</h2>
                        </div>
                        <div class="analytics-goals" id="paidSubscriberGoals">
                            <!-- Paid goals populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Growth Chart -->
                <div class="analytics-section">
                    <div class="analytics-section-header">
                        <h2 class="analytics-section-title">📈 Subscriber Growth</h2>
                    </div>
                    <div class="analytics-chart-container">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>

                <!-- History Log -->
                <div class="analytics-section">
                    <div class="analytics-section-header">
                        <h2 class="analytics-section-title">📋 Update History</h2>
                    </div>
                    <div class="analytics-history" id="analyticsHistory">
                        <!-- History populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Stats Modal -->
        <div class="modal-overlay" id="updateStatsModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">📊 Update Fan Count</h3>
                    <button class="auto-panel-close" id="closeUpdateStats">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Current Total Fans</label>
                        <input type="number" class="form-input" id="newSubscriberCount" placeholder="e.g., 2150">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <input type="text" class="form-input" id="updateNotes" placeholder="e.g., Big push from TikTok">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelUpdateStats">Cancel</button>
                    <button class="btn btn-primary" id="saveUpdateStats">Save Update</button>
                </div>
            </div>
        </div>

        <!-- Update Paid Subscribers Modal -->
        <div class="modal-overlay" id="updatePaidStatsModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">💎 Update Paid Subscribers</h3>
                    <button class="auto-panel-close" id="closePaidStats">✕</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.85rem;">Enter the number of subscribers at each tier:</p>
                    <div class="form-group">
                        <label class="form-label">$0.99/month subscribers</label>
                        <input type="number" class="form-input" id="tier1Count" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">$4.99/month subscribers</label>
                        <input type="number" class="form-input" id="tier2Count" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">$9.99/month subscribers</label>
                        <input type="number" class="form-input" id="tier3Count" placeholder="0" min="0">
                    </div>
                    <div class="paid-stats-preview">
                        <div class="paid-preview-row">
                            <span>Total Subscribers:</span>
                            <span id="paidPreviewTotal">0</span>
                        </div>
                        <div class="paid-preview-row">
                            <span>Monthly Revenue:</span>
                            <span id="paidPreviewRevenue">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelPaidStats">Cancel</button>
                    <button class="btn btn-primary" id="savePaidStats">Save Update</button>
                </div>
            </div>
        </div>

        <!-- Analytics Notification Settings Modal -->
        <div class="modal-overlay" id="analyticsNotifyModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">🔔 Fan Analytics Notifications</h3>
                    <button class="auto-panel-close" id="closeAnalyticsNotify">✕</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Get email notifications for fan growth milestones.</p>
                    
                    <!-- Email Address Field -->
                    <div style="margin-bottom: 1.25rem;">
                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">📧 Notification Email</label>
                        <input type="email" id="analyticsNotifyEmail" class="form-input" placeholder="your@email.com" style="width: 100%;">
                        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.35rem;">Where to send fan growth notifications</p>
                    </div>
                    
                    <div class="notify-option">
                        <label class="notify-toggle">
                            <input type="checkbox" id="notifyDailyGrowth" checked>
                            <span class="notify-toggle-slider"></span>
                        </label>
                        <div class="notify-option-content">
                            <div class="notify-option-title">🔥 Hot Day Alert</div>
                            <div class="notify-option-desc">Notify when you gain 50+ fans in a single update</div>
                        </div>
                    </div>

                    <div class="notify-option">
                        <label class="notify-toggle">
                            <input type="checkbox" id="notifyGoalReached" checked>
                            <span class="notify-toggle-slider"></span>
                        </label>
                        <div class="notify-option-content">
                            <div class="notify-option-title">🎯 Goal Reached</div>
                            <div class="notify-option-desc">Notify when you hit a growth goal milestone</div>
                        </div>
                    </div>

                    <div class="notify-option">
                        <label class="notify-toggle">
                            <input type="checkbox" id="notifyWeeklyRecap" checked>
                            <span class="notify-toggle-slider"></span>
                        </label>
                        <div class="notify-option-content">
                            <div class="notify-option-title">📊 Weekly Recap</div>
                            <div class="notify-option-desc">Sunday summary of your fan growth</div>
                        </div>
                    </div>

                    <div class="notify-option">
                        <label class="notify-toggle">
                            <input type="checkbox" id="notifyMilestone">
                            <span class="notify-toggle-slider"></span>
                        </label>
                        <div class="notify-option-content">
                            <div class="notify-option-title">🏆 Round Number Milestones</div>
                            <div class="notify-option-desc">Notify at 2.5K, 3K, 5K, 10K, etc.</div>
                        </div>
                    </div>

                    <div class="notify-option">
                        <label class="notify-toggle">
                            <input type="checkbox" id="notifyStreak">
                            <span class="notify-toggle-slider"></span>
                        </label>
                        <div class="notify-option-content">
                            <div class="notify-option-title">⚡ Growth Streak</div>
                            <div class="notify-option-desc">Notify when you have 7+ days of consecutive growth</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelAnalyticsNotify">Cancel</button>
                    <button class="btn btn-primary" id="saveAnalyticsNotify">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- To-Do View -->
        <div class="list-view" id="todoView">
            <div class="todo-layout">
                <!-- Main Todo List -->
                <div class="todo-main">
                    <div class="todo-header">
                        <h1 class="todo-title">SLOE JACK</h1>
                        <div class="todo-header-actions">
                            <button class="todo-view-btn active" data-view="list" title="List view">☰</button>
                            <button class="todo-view-btn" data-view="board" title="Board view">▦</button>
                        </div>
                    </div>
                    
                    <!-- To-Do Sections -->
                    <div class="todo-sections" id="todoSections">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Task Detail Side Panel -->
                <div class="todo-detail-panel" id="todoDetailPanel">
                    <div class="todo-detail-header">
                        <div class="todo-detail-actions-left">
                            <button class="todo-detail-complete-btn" id="todoDetailCompleteBtn" title="Complete task">
                                <span class="todo-detail-checkbox"></span>
                            </button>
                        </div>
                        <div class="todo-detail-actions-right">
                            <button class="todo-detail-action" id="todoDetailNotify" title="Send notification">📧</button>
                            <button class="todo-detail-action" id="todoDetailDelete" title="Delete task">🗑️</button>
                            <button class="todo-detail-action" id="todoDetailClose" title="Close">✕</button>
                        </div>
                    </div>
                    <div class="todo-detail-content">
                        <textarea class="todo-detail-title" id="todoDetailTitle" placeholder="Task name" rows="1"></textarea>
                        <textarea class="todo-detail-description" id="todoDetailDescription" placeholder="Description"></textarea>
                        
                        <div class="todo-detail-fields">
                            <div class="todo-detail-field">
                                <span class="todo-detail-field-label">Project</span>
                                <select class="todo-detail-field-value" id="todoDetailSection">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="todo-detail-field">
                                <span class="todo-detail-field-label">Assignee</span>
                                <div class="todo-assignee-wrapper">
                                    <button class="todo-assignee-btn" id="todoAssigneeBtn">
                                        <span class="todo-assignee-avatar" id="todoAssigneeAvatar">👤</span>
                                        <span class="todo-assignee-name" id="todoAssigneeName">Unassigned</span>
                                        <span class="todo-assignee-arrow">▼</span>
                                    </button>
                                    <div class="todo-assignee-dropdown" id="todoAssigneeDropdown">
                                        <input type="text" class="todo-assignee-search" id="todoAssigneeSearch" placeholder="Type an assignee">
                                        <div class="todo-assignee-list" id="todoAssigneeList">
                                            <div class="todo-assignee-option" data-assignee="" data-email="">
                                                <span class="todo-assignee-option-avatar">👤</span>
                                                <span class="todo-assignee-option-name">Unassigned</span>
                                                <span class="todo-assignee-option-check">✓</span>
                                            </div>
                                            <div class="todo-assignee-option" data-assignee="Chad" data-email="hillardc@gmail.com">
                                                <span class="todo-assignee-option-avatar chad">CH</span>
                                                <span class="todo-assignee-option-name">Me (Chad H.)</span>
                                                <span class="todo-assignee-option-check"></span>
                                            </div>
                                            <div class="todo-assignee-option" data-assignee="SLOE" data-email="sloejackmanagement@gmail.com">
                                                <span class="todo-assignee-option-avatar sloe">SJ</span>
                                                <span class="todo-assignee-option-name">SLOE</span>
                                                <span class="todo-assignee-option-check"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="todo-detail-field">
                                <span class="todo-detail-field-label">Due date</span>
                                <input type="date" class="todo-detail-field-value" id="todoDetailDate">
                            </div>
                            <div class="todo-detail-field">
                                <span class="todo-detail-field-label">Priority</span>
                                <div class="todo-priority-selector" id="todoPrioritySelector">
                                    <button class="todo-priority-btn p1" data-priority="1" title="Priority 1">🚩</button>
                                    <button class="todo-priority-btn p2" data-priority="2" title="Priority 2">🚩</button>
                                    <button class="todo-priority-btn p3" data-priority="3" title="Priority 3">🚩</button>
                                    <button class="todo-priority-btn p4 active" data-priority="4" title="Priority 4">🚩</button>
                                </div>
                            </div>
                            <div class="todo-detail-field">
                                <span class="todo-detail-field-label">Labels</span>
                                <input type="text" class="todo-detail-field-value" id="todoDetailLabels" placeholder="Add labels...">
                            </div>
                        </div>
                        
                        <div class="todo-detail-subtasks">
                            <div class="todo-detail-subtasks-header">
                                <span>Sub-tasks</span>
                                <button class="todo-add-subtask-btn" id="addSubtaskBtn">+ Add sub-task</button>
                            </div>
                            <div class="todo-subtasks-list" id="todoSubtasksList">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Ideas Panel -->
    <div class="auto-panel" id="ideasPanel">
        <div class="auto-panel-header">
            <h3 class="auto-panel-title">💡 Content Ideas</h3>
            <button class="auto-panel-close" id="closeIdeas">✕</button>
        </div>
        <div class="auto-panel-content" id="ideasContent"></div>
    </div>

    <!-- Add Section Modal -->
    <div class="modal-overlay" id="addSectionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">📁 Add Section</h3>
                <button class="auto-panel-close" id="closeAddSectionModal">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Section Name</label>
                    <input type="text" class="form-input" id="newSectionName" placeholder="e.g., Marketing, Content, etc.">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddSection">Cancel</button>
                <button class="btn btn-primary" id="saveAddSection">Add Section</button>
            </div>
        </div>
    </div>

    <!-- Add Idea as Task Modal -->
    <div class="modal-overlay" id="addIdeaModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">💡 Add Idea as Task</h3>
                <button class="auto-panel-close" id="closeIdeaModal">✕</button>
            </div>
            <div class="modal-body">
                <div class="idea-preview" id="ideaPreview">
                    <div class="idea-preview-type" id="ideaPreviewType">Stories</div>
                    <div class="idea-preview-title" id="ideaPreviewTitle">Idea Title</div>
                    <div class="idea-preview-desc" id="ideaPreviewDesc">Description</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="ideaTaskTitle" placeholder="e.g., Post BTS story content">
                </div>
                <div class="form-group">
                    <label class="form-label">Frequency</label>
                    <select class="form-input form-select" id="ideaFrequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input form-select" id="ideaCategory">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-input form-textarea" id="ideaDescription" rows="3" placeholder="Add instructions or context..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelIdea">Cancel</button>
                <button class="btn btn-primary" id="saveIdea">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Add Daily Habit Modal -->
    <div class="modal-overlay" id="addDailyHabitModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">☀️ Add Daily Habit</h3>
                <button class="auto-panel-close" id="closeDailyHabitModal">✕</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.25rem;">
                    Daily habits reset automatically at midnight and contribute to your weekly score when completed.
                </p>
                <div class="form-group">
                    <label class="form-label">Habit Title</label>
                    <input type="text" class="form-input" id="dailyHabitTitle" placeholder="e.g., Post a story">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input form-select" id="dailyHabitCategory">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-input form-textarea" id="dailyHabitDescription" rows="2" placeholder="Add notes or instructions..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDailyHabit">Cancel</button>
                <button class="btn btn-primary" id="saveDailyHabit">Add Habit</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Task</h3>
                <button class="auto-panel-close" id="closeModal">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="taskTitle" placeholder="e.g., Post BTS story content">
                </div>
                <div class="form-group">
                    <label class="form-label">Frequency</label>
                    <select class="form-input form-select" id="taskFrequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input form-select" id="taskCategory">
                        <!-- Populated by JS -->
                    </select>
                    <span class="manage-categories-link" onclick="openCategoryManager()">⚙️ Manage Categories</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelTask">Cancel</button>
                <button class="btn btn-primary" id="saveTask">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="modal-overlay" id="dayModal">
        <div class="day-modal">
            <div class="day-modal-header">
                <div class="day-modal-date">
                    <div class="day-modal-number" id="dayModalNumber">1</div>
                    <div class="day-modal-info">
                        <h3 id="dayModalTitle">Monday, January 1</h3>
                        <p id="dayModalSubtitle">Daily tasks + more</p>
                    </div>
                </div>
                <button class="auto-panel-close" id="closeDayModal">✕</button>
            </div>
            <div class="day-modal-body" id="dayModalBody">
                <!-- Tasks will be populated here -->
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal-overlay" id="notificationSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">🔔 Notification Settings</h3>
                <button class="auto-panel-close" id="closeNotificationSettings">✕</button>
            </div>
            <div class="modal-body">
                <p class="notification-settings-desc">Configure when tasks should appear in your "Due Now" notifications:</p>
                
                <div class="notification-setting-item">
                    <div class="notification-setting-info">
                        <div class="notification-setting-icon">📆</div>
                        <div>
                            <div class="notification-setting-title">Weekly Tasks</div>
                            <div class="notification-setting-subtitle">Remind me when there are this many days left in the week</div>
                        </div>
                    </div>
                    <select class="form-input form-select notification-setting-select" id="weeklyReminder">
                        <option value="1">1 day left</option>
                        <option value="2" selected>2 days left</option>
                        <option value="3">3 days left</option>
                        <option value="4">4 days left</option>
                    </select>
                </div>
                
                <div class="notification-setting-item">
                    <div class="notification-setting-info">
                        <div class="notification-setting-icon">🗓️</div>
                        <div>
                            <div class="notification-setting-title">Monthly Tasks</div>
                            <div class="notification-setting-subtitle">Remind me when there are this many days left in the month</div>
                        </div>
                    </div>
                    <select class="form-input form-select notification-setting-select" id="monthlyReminder">
                        <option value="3">3 days left</option>
                        <option value="5">5 days left</option>
                        <option value="7" selected>7 days left</option>
                        <option value="10">10 days left</option>
                        <option value="14">14 days left</option>
                    </select>
                </div>
                
                <div class="notification-setting-item">
                    <div class="notification-setting-info">
                        <div class="notification-setting-icon">📊</div>
                        <div>
                            <div class="notification-setting-title">Quarterly Tasks</div>
                            <div class="notification-setting-subtitle">Remind me when there are this many days left in the quarter</div>
                        </div>
                    </div>
                    <select class="form-input form-select notification-setting-select" id="quarterlyReminder">
                        <option value="7">7 days left</option>
                        <option value="14" selected>14 days left</option>
                        <option value="21">21 days left</option>
                        <option value="30">30 days left</option>
                    </select>
                </div>
                
                <div class="notification-setting-item">
                    <div class="notification-setting-info">
                        <div class="notification-setting-icon">🎯</div>
                        <div>
                            <div class="notification-setting-title">Yearly Tasks</div>
                            <div class="notification-setting-subtitle">Remind me when there are this many days left in the year</div>
                        </div>
                    </div>
                    <select class="form-input form-select notification-setting-select" id="yearlyReminder">
                        <option value="14">14 days left</option>
                        <option value="30" selected>30 days left</option>
                        <option value="60">60 days left</option>
                        <option value="90">90 days left</option>
                    </select>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">

                <h4 style="margin-bottom: 1rem; font-size: 1rem;">📧 Email Notifications</h4>
                
                <div class="notification-setting-item">
                    <div class="notification-setting-info">
                        <div class="notification-setting-icon">✉️</div>
                        <div>
                            <div class="notification-setting-title">Email Addresses</div>
                            <div class="notification-setting-subtitle">Where to send task reminders (one email per line)</div>
                        </div>
                    </div>
                    <textarea class="form-input form-textarea" id="notificationEmail" placeholder="email1@example.com&#10;email2@example.com&#10;email3@example.com" rows="3" style="margin-top: 0.5rem;"></textarea>
                </div>

                <div class="notification-setting-item">
                    <div class="notification-setting-info">
                        <div class="notification-setting-icon">🕐</div>
                        <div>
                            <div class="notification-setting-title">Email Frequency</div>
                            <div class="notification-setting-subtitle">How often to receive email reminders</div>
                        </div>
                    </div>
                    <select class="form-input form-select notification-setting-select" id="emailFrequency">
                        <option value="off">Off - No emails</option>
                        <option value="daily">Daily digest</option>
                        <option value="weekly">Weekly digest (Mondays)</option>
                    </select>
                </div>

                <div class="email-test-section" id="emailTestSection" style="display: none;">
                    <button class="btn btn-secondary" id="sendTestEmail" style="width: 100%; margin-top: 0.5rem;">
                        📤 Send Test Email to All
                    </button>
                    <div class="email-status" id="emailStatus" style="margin-top: 0.5rem; font-size: 0.85rem; text-align: center;"></div>
                </div>

                <div class="email-setup-guide">
                    <h5>📝 EmailJS Setup (One-time)</h5>
                    <ol>
                        <li>Go to <a href="https://www.emailjs.com/" target="_blank" style="color: var(--accent-primary);">emailjs.com</a> and create a free account</li>
                        <li>Add an email service (Gmail, Outlook, etc.)</li>
                        <li>Create an email template with these variables:<br>
                            <code>{{to_email}}</code> <code>{{subject}}</code> <code>{{task_list}}</code> <code>{{weekly_score}}</code></li>
                        <li>Copy your Service ID, Template ID, and Public Key</li>
                        <li>Update the <code>EMAILJS_CONFIG</code> in the code</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveNotificationSettings">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Task Editor Modal -->
    <div class="modal-overlay" id="taskEditorModal">
        <div class="day-modal" style="max-width: 700px;">
            <div class="day-modal-header">
                <div class="day-modal-date">
                    <div class="day-modal-number" id="editorIcon" style="font-size: 1.5rem;">☀️</div>
                    <div class="day-modal-info">
                        <h3 id="editorTitle">Daily Tasks</h3>
                        <p id="editorSubtitle">Tasks that repeat every weekday</p>
                    </div>
                </div>
                <button class="auto-panel-close" id="closeTaskEditor">✕</button>
            </div>
            <div class="day-modal-body" id="taskEditorBody">
                <!-- Tasks will be populated here -->
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button class="btn btn-primary" id="addTaskInEditor">＋ Add Task</button>
            </div>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">⚙️ Manage Categories</h3>
                <button class="auto-panel-close" id="closeCategoryModal">✕</button>
            </div>
            <div class="modal-body">
                <div class="category-list" id="categoryList">
                    <!-- Populated by JS -->
                </div>
                <button class="add-category-btn" id="addCategoryBtn">
                    ＋ Add New Category
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCategories">Cancel</button>
                <button class="btn btn-primary" id="saveCategories">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal-overlay" id="taskDetailModal">
        <div class="task-detail-modal">
            <div class="task-detail-header">
                <div class="task-detail-icon" id="taskDetailIcon">☀️</div>
                <div class="task-detail-info">
                    <div class="task-detail-title" id="taskDetailTitle">Task Title</div>
                    <div class="task-detail-tags" id="taskDetailTags">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <button class="auto-panel-close" id="closeTaskDetail">✕</button>
            </div>
            <div class="task-detail-body">
                <div class="task-detail-section">
                    <div class="task-detail-label">Description & Instructions</div>
                    <div class="task-detail-description" id="taskDetailDescription" contenteditable="true"></div>
                </div>
            </div>
            <div class="task-detail-footer">
                <div class="task-detail-actions">
                    <button class="btn btn-secondary" id="taskDetailComplete">✓ Complete</button>
                </div>
                <button class="btn btn-primary" id="saveTaskDetail">Save</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDuGjOBfjejH8GUYnxT1U5CqZgj-9gKou4",
            authDomain: "sloe-jack-planner.firebaseapp.com",
            projectId: "sloe-jack-planner",
            storageBucket: "sloe-jack-planner.firebasestorage.app",
            messagingSenderId: "818280471316",
            appId: "1:818280471316:web:c1ab1541b677adfa0b4001"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ========== DATA ==========
        const defaultTasks = {
            daily: [
                { id: 1, title: "📱 Post BTS raw footage to Stories", category: "stories", completed: false },
                { id: 2, title: "📱 Share casual update or reminder", category: "stories", completed: false },
                { id: 3, title: "💬 Engage in subscriber group chat", category: "groupchat", completed: false },
                { id: 4, title: "🎤 Drop a voice note or photo in chat", category: "groupchat", completed: false },
                { id: 5, title: "😂 Share a funny filter video", category: "stories", completed: false }
            ],
            weekly: [
                { id: 6, title: "📸 Post subscriber-only Reels content", category: "reels", completed: false },
                { id: 7, title: "🚫 Share 'banned' or exclusive video", category: "reels", completed: false },
                { id: 8, title: "🔴 Go live for subscribers (AMA/hang)", category: "live", completed: false },
                { id: 9, title: "🎬 Post longer BTS footage", category: "reels", completed: false },
                { id: 10, title: "📷 Share exclusive photos", category: "reels", completed: false },
                { id: 11, title: "🎵 Post unreleased music snippet", category: "reels", completed: false }
            ],
            monthly: [
                { id: 12, title: "📊 Run subscriber poll (artwork/single)", category: "polls", completed: false },
                { id: 13, title: "✨ Update IG Highlights", category: "stories", completed: false },
                { id: 14, title: "💭 Share deeper personal content", category: "reels", completed: false },
                { id: 15, title: "🔴 Host special themed IG Live", category: "live", completed: false }
            ],
            quarterly: [
                { id: 16, title: "🎥 Release longform video/documentary", category: "video", completed: false },
                { id: 17, title: "🏷️ Share exclusive merch discount", category: "merch", completed: false },
                { id: 18, title: "👕 Announce new merch drop", category: "merch", completed: false },
                { id: 19, title: "🎁 Give out live-only discount codes", category: "live", completed: false }
            ],
            yearly: [
                { id: 20, title: "📅 Plan content calendar for year", category: "reels", completed: false },
                { id: 21, title: "📈 Review subscriber growth & reelsback", category: "reels", completed: false },
                { id: 22, title: "🎯 Set new subscriber tier goals", category: "merch", completed: false },
                { id: 23, title: "🎬 Plan major documentary project", category: "video", completed: false }
            ]
        };

        const contentIdeas = [
            { type: "Stories", title: "Studio Session Snippets", desc: "Film quick clips during recording sessions - raw, unedited moments" },
            { type: "Stories", title: "Day in the Life", desc: "Document your day from wake up to studio to chill time" },
            { type: "Stories", title: "Gear Tour", desc: "Show off your equipment, instruments, or setup" },
            { type: "Group Chat", title: "Exclusive Listening Party", desc: "Drop an unreleased track and ask for real-time reactions" },
            { type: "Group Chat", title: "Voice Note Q&A", desc: "Answer fan questions via voice notes for personal touch" },
            { type: "Reels Post", title: "Lyric Breakdown", desc: "Deep dive into the meaning behind a song's lyrics" },
            { type: "Reels Post", title: "Before/After", desc: "Show the evolution of a song from demo to final" },
            { type: "IG Live", title: "Writing Session", desc: "Go live while working on new music" },
            { type: "IG Live", title: "Album Listening Party", desc: "React to your own music with subscribers" },
            { type: "Merch", title: "Limited Drop Preview", desc: "Show subscribers new merch 48hrs before public" },
            { type: "Video", title: "Tour Documentary", desc: "Compile tour footage into subscriber-only mini doc" },
            { type: "Polls", title: "Next Single Vote", desc: "Let subscribers pick which song drops next" },
            { type: "Polls", title: "Cover Art Selection", desc: "Give 3 options and let subs decide" }
        ];

        // Default categories configuration
        const defaultCategories = [
            { id: 'stories', name: 'Stories', icon: '📱', color: '#ec4899' },
            { id: 'groupchat', name: 'Group Chat', icon: '💬', color: '#22c55e' },
            { id: 'reels', name: 'Reels', icon: '📸', color: '#3b82f6' },
            { id: 'live', name: 'Live', icon: '🔴', color: '#ef4444' },
            { id: 'shows', name: 'Shows', icon: '🎤', color: '#8b5cf6' },
            { id: 'merch', name: 'Merch', icon: '👕', color: '#f97316' },
            { id: 'video', name: 'Video', icon: '🎬', color: '#a855f7' },
            { id: 'polls', name: 'Polls', icon: '📊', color: '#eab308' }
        ];

        // ========== STATE ==========
        let tasks = {
            daily: [],
            weekly: [],
            monthly: [],
            quarterly: [],
            yearly: []
        };
        let categories = [...defaultCategories];
        let tempCategories = []; // For editing in modal
        let priorityOrder = []; // Stores task IDs in priority order
        let completionHistory = []; // Stores completed task history
        let dailyHabits = []; // Daily habits that reset at midnight
        let dailyHabitsCompletedToday = []; // Track which habits completed today
        let lastHabitResetDate = null; // Track when habits were last reset
        let notificationSettings = {
            weekly: 2,      // Days before end of week
            monthly: 7,     // Days before end of month
            quarterly: 14,  // Days before end of quarter
            yearly: 30,     // Days before end of year
            email: '',      // Email address for notifications
            emailFrequency: 'off', // off, daily, weekly
            lastEmailSent: null    // Track when last email was sent
        };
        
        // EmailJS Configuration
        const EMAILJS_CONFIG = {
            serviceId: 'service_ncguw58',
            templateId: 'template_fhvgztr',
            publicKey: 'wjccslT-_RRAAknfk'
        };
        
        let currentNotificationTab = 'due';
        let currentDate = new Date();
        let currentView = 'home';

        // ========== DOM ELEMENTS ==========
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const viewTabs = document.querySelectorAll('.view-tab');
        const ideasBtn = document.getElementById('ideasBtn');
        const ideasPanel = document.getElementById('ideasPanel');
        const closeIdeas = document.getElementById('closeIdeas');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const addModal = document.getElementById('addModal');
        const closeModal = document.getElementById('closeModal');
        const cancelTask = document.getElementById('cancelTask');
        const saveTask = document.getElementById('saveTask');
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarTitle = document.getElementById('calendarTitle');
        const prevMonth = document.getElementById('prevMonth');
        const nextMonth = document.getElementById('nextMonth');
        const todayBtn = document.getElementById('todayBtn');
        const dayModal = document.getElementById('dayModal');
        const closeDayModal = document.getElementById('closeDayModal');
        const taskEditorModal = document.getElementById('taskEditorModal');
        const closeTaskEditor = document.getElementById('closeTaskEditor');
        const addTaskInEditor = document.getElementById('addTaskInEditor');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationSettingsBtn = document.getElementById('notificationSettingsBtn');
        const notificationSettingsModal = document.getElementById('notificationSettingsModal');
        const closeNotificationSettings = document.getElementById('closeNotificationSettings');
        const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettings');
        const notificationTabs = document.querySelectorAll('.notification-tab');
        const notificationList = document.getElementById('notificationList');
        const notificationEmail = document.getElementById('notificationEmail');
        const emailFrequency = document.getElementById('emailFrequency');
        const emailTestSection = document.getElementById('emailTestSection');
        const sendTestEmail = document.getElementById('sendTestEmail');
        const emailStatus = document.getElementById('emailStatus');
        const comingUpToggle = document.getElementById('comingUpToggle');
        const comingUpSection = document.getElementById('comingUpSection');
        const comingUpGrid = document.getElementById('comingUpGrid');
        const categoryModal = document.getElementById('categoryModal');
        const closeCategoryModal = document.getElementById('closeCategoryModal');
        const cancelCategories = document.getElementById('cancelCategories');
        const saveCategories = document.getElementById('saveCategories');
        const categoryList = document.getElementById('categoryList');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const taskCategorySelect = document.getElementById('taskCategory');
        const recentlyCompletedFilter = document.getElementById('recentlyCompletedFilter');
        const recentlyCompletedToggle = document.getElementById('recentlyCompletedToggle');
        const recentlyCompletedList = document.getElementById('recentlyCompletedList');
        const recentlyCompletedStats = document.getElementById('recentlyCompletedStats');
        const taskDetailModal = document.getElementById('taskDetailModal');
        const closeTaskDetail = document.getElementById('closeTaskDetail');
        const taskDetailIcon = document.getElementById('taskDetailIcon');
        const taskDetailTitle = document.getElementById('taskDetailTitle');
        const taskDetailTags = document.getElementById('taskDetailTags');
        const taskDetailDescription = document.getElementById('taskDetailDescription');
        const saveTaskDetail = document.getElementById('saveTaskDetail');
        const taskDetailComplete = document.getElementById('taskDetailComplete');
        const weeklyHistoryBtn = document.getElementById('weeklyHistoryBtn');
        const weeklyHistoryModal = document.getElementById('weeklyHistoryModal');
        const closeWeeklyHistory = document.getElementById('closeWeeklyHistory');
        const weeklyHistoryContent = document.getElementById('weeklyHistoryContent');
        const weeklyScoreNumber = document.getElementById('weeklyScoreNumber');
        const weeklyScoreMessage = document.getElementById('weeklyScoreMessage');
        const weeklyProgressBar = document.getElementById('weeklyProgressBar');
        const weeklyBreakdown = document.getElementById('weeklyBreakdown');
        const weeklyComparison = document.getElementById('weeklyComparison');
        const addIdeaModal = document.getElementById('addIdeaModal');
        const closeIdeaModal = document.getElementById('closeIdeaModal');
        const cancelIdea = document.getElementById('cancelIdea');
        const saveIdea = document.getElementById('saveIdea');
        const ideaPreviewType = document.getElementById('ideaPreviewType');
        const ideaPreviewTitle = document.getElementById('ideaPreviewTitle');
        const ideaPreviewDesc = document.getElementById('ideaPreviewDesc');
        const ideaTaskTitle = document.getElementById('ideaTaskTitle');
        const ideaFrequency = document.getElementById('ideaFrequency');
        const ideaCategory = document.getElementById('ideaCategory');
        const ideaDescription = document.getElementById('ideaDescription');
        const addDailyHabitBtn = document.getElementById('addDailyHabitBtn');
        const addDailyHabitModal = document.getElementById('addDailyHabitModal');
        const closeDailyHabitModal = document.getElementById('closeDailyHabitModal');
        const cancelDailyHabit = document.getElementById('cancelDailyHabit');
        const saveDailyHabit = document.getElementById('saveDailyHabit');
        const dailyHabitTitle = document.getElementById('dailyHabitTitle');
        const dailyHabitCategory = document.getElementById('dailyHabitCategory');
        const dailyHabitDescription = document.getElementById('dailyHabitDescription');
        const dailyHabitsGrid = document.getElementById('dailyHabitsGrid');
        const weeklyPinnedGrid = document.getElementById('weeklyPinnedGrid');
        const monthlyPinnedGrid = document.getElementById('monthlyPinnedGrid');
        const quarterlyPinnedGrid = document.getElementById('quarterlyPinnedGrid');
        const yearlyPinnedGrid = document.getElementById('yearlyPinnedGrid');
        const weeklyPinnedCount = document.getElementById('weeklyPinnedCount');
        const monthlyPinnedCount = document.getElementById('monthlyPinnedCount');
        const quarterlyPinnedCount = document.getElementById('quarterlyPinnedCount');
        const yearlyPinnedCount = document.getElementById('yearlyPinnedCount');
        // To-Do DOM elements
        const todoSections = document.getElementById('todoSections');
        const addSectionModal = document.getElementById('addSectionModal');
        const closeAddSectionModal = document.getElementById('closeAddSectionModal');
        const cancelAddSection = document.getElementById('cancelAddSection');
        const saveAddSection = document.getElementById('saveAddSection');
        const newSectionName = document.getElementById('newSectionName');
        let currentEditorFrequency = 'daily';
        let currentDetailTask = null; // { frequency, id }
        let currentIdea = null; // { type, title, desc }
        let weeklyScoreHistory = []; // Stores weekly scores
        // To-Do state
        let todoData = {
            sections: [
                { id: 1, name: 'TO-DO', collapsed: false },
                { id: 2, name: 'Chad', collapsed: false },
            ],
            items: []
        };
        let todoNotificationsEnabled = true;
        let editingTodoId = null;
        // Track completed pinned tasks per period (resets automatically)
        let pinnedCompletions = {
            weekly: [],    // Task IDs completed this week
            monthly: [],   // Task IDs completed this month
            quarterly: [], // Task IDs completed this quarter
            yearly: []     // Task IDs completed this year
        };
        let lastPinnedResetDates = {
            weekly: null,
            monthly: null,
            quarterly: null,
            yearly: null
        };
        let pinnedPriorityOrder = {
            weekly: [],
            monthly: [],
            quarterly: [],
            yearly: []
        };
        let comingUpVisible = localStorage.getItem('comingUpVisible') !== 'false';
        let recentlyCompletedVisible = localStorage.getItem('recentlyCompletedVisible') !== 'false';

        // ========== THEME ==========
        function initTheme() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.body.dataset.theme = saved;
            themeIcon.textContent = saved === 'dark' ? '🌙' : '☀️';
        }

        themeToggle.addEventListener('click', () => {
            const current = document.body.dataset.theme;
            const next = current === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = next;
            localStorage.setItem('theme', next);
            themeIcon.textContent = next === 'dark' ? '🌙' : '☀️';
        });

        // ========== VIEW SWITCHING ==========
        viewTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                viewTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentView = tab.dataset.view;
                
                document.querySelectorAll('.list-view').forEach(v => v.classList.remove('active'));
                document.getElementById(currentView + 'View').classList.add('active');
                
                if (currentView === 'calendar') {
                    renderCalendar();
                } else if (currentView === 'todo') {
                    renderTodoList();
                } else if (currentView === 'analytics') {
                    renderAnalytics();
                }
            });
        });

        // ========== TASK DETAIL MODAL ==========
        closeTaskDetail.addEventListener('click', () => taskDetailModal.classList.remove('open'));
        taskDetailModal.addEventListener('click', (e) => {
            if (e.target === taskDetailModal) taskDetailModal.classList.remove('open');
        });

        function openTaskDetail(frequency, id) {
            const task = tasks[frequency].find(t => t.id === id);
            if (!task) return;
            
            currentDetailTask = { frequency, id };
            
            const freqIcons = { daily: '☀️', weekly: '📆', monthly: '🗓️', quarterly: '📊', yearly: '🎯' };
            
            taskDetailIcon.textContent = freqIcons[frequency];
            taskDetailIcon.className = 'task-detail-icon ' + frequency;
            taskDetailTitle.textContent = task.title;
            taskDetailTags.innerHTML = `
                <span class="notification-tag ${frequency}">${frequency}</span>
                <span class="notification-tag ${task.category}">${task.category}</span>
            `;
            taskDetailDescription.textContent = task.description || '';
            
            taskDetailModal.classList.add('open');
        }

        saveTaskDetail.addEventListener('click', () => {
            if (!currentDetailTask) return;
            
            const task = tasks[currentDetailTask.frequency].find(t => t.id === currentDetailTask.id);
            if (task) {
                task.description = taskDetailDescription.textContent.trim();
                saveTasks();
            }
            
            taskDetailModal.classList.remove('open');
            currentDetailTask = null;
        });

        taskDetailComplete.addEventListener('click', () => {
            if (!currentDetailTask) return;
            
            completePinnedTask(currentDetailTask.frequency, currentDetailTask.id);
            taskDetailModal.classList.remove('open');
            currentDetailTask = null;
        });

        window.openTaskDetail = openTaskDetail;

        // ========== WEEKLY PROGRESS ==========
        weeklyHistoryBtn.addEventListener('click', () => {
            renderWeeklyHistory();
            weeklyHistoryModal.classList.add('open');
        });

        closeWeeklyHistory.addEventListener('click', () => weeklyHistoryModal.classList.remove('open'));
        weeklyHistoryModal.addEventListener('click', (e) => {
            if (e.target === weeklyHistoryModal) weeklyHistoryModal.classList.remove('open');
        });

        function getWeekStartDate(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getWeekEndDate(date = new Date()) {
            const start = getWeekStartDate(date);
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            return end;
        }

        function getCompletionsForWeek(weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);
            
            return completionHistory.filter(item => {
                const completedDate = new Date(item.completedAt);
                return completedDate >= weekStart && completedDate < weekEnd;
            });
        }

        function calculateWeeklyScore(completions) {
            /*
             * Scoring Formula (out of 10):
             * - Daily tasks: 0.2 points each (target: ~25 per week = 5 points max from daily)
             * - Weekly tasks: 0.5 points each (target: ~6 per week = 3 points max from weekly)
             * - Monthly tasks: 1.0 points each (target: ~2 per month = 0.5 per week = 0.5 points)
             * - Quarterly tasks: 1.5 points each (bonus points for big tasks)
             * 
             * This rewards consistent daily engagement while giving bonus for bigger tasks.
             * Realistic target: 15-20 daily + 4-6 weekly + occasional monthly = 7-8 score
             */
            
            const dailyCount = completions.filter(c => c.frequency === 'daily').length;
            const weeklyCount = completions.filter(c => c.frequency === 'weekly').length;
            const monthlyCount = completions.filter(c => c.frequency === 'monthly').length;
            const quarterlyCount = completions.filter(c => c.frequency === 'quarterly').length;
            
            const dailyPoints = Math.min(dailyCount * 0.2, 5); // Cap at 5 points
            const weeklyPoints = Math.min(weeklyCount * 0.5, 3); // Cap at 3 points
            const monthlyPoints = Math.min(monthlyCount * 1.0, 1.5); // Cap at 1.5 points
            const quarterlyPoints = Math.min(quarterlyCount * 1.5, 1.5); // Cap at 1.5 points (bonus)
            
            const totalScore = Math.min(dailyPoints + weeklyPoints + monthlyPoints + quarterlyPoints, 10);
            
            return {
                score: Math.round(totalScore * 10) / 10,
                dailyCount,
                weeklyCount,
                monthlyCount,
                quarterlyCount,
                dailyPoints: Math.round(dailyPoints * 10) / 10,
                weeklyPoints: Math.round(weeklyPoints * 10) / 10,
                monthlyPoints: Math.round(monthlyPoints * 10) / 10,
                quarterlyPoints: Math.round(quarterlyPoints * 10) / 10
            };
        }

        function getScoreMessage(score) {
            if (score >= 9) return "🔥 Incredible week! You're crushing it!";
            if (score >= 7) return "💪 Great work! Subscribers are loving it!";
            if (score >= 5) return "👍 Solid progress! Keep the momentum going!";
            if (score >= 3) return "📈 Good start! A few more tasks will level you up!";
            if (score > 0) return "🌱 Getting started! Every task counts!";
            return "🎯 New week, new opportunities! Let's go!";
        }

        function getScoreClass(score) {
            if (score >= 8) return 'excellent';
            if (score >= 5) return 'good';
            if (score >= 3) return 'okay';
            return 'low';
        }

        function updateWeeklyProgress() {
            const thisWeekStart = getWeekStartDate();
            const lastWeekStart = new Date(thisWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            
            const thisWeekCompletions = getCompletionsForWeek(thisWeekStart);
            const lastWeekCompletions = getCompletionsForWeek(lastWeekStart);
            
            const thisWeekData = calculateWeeklyScore(thisWeekCompletions);
            const lastWeekData = calculateWeeklyScore(lastWeekCompletions);
            
            // Update score display
            weeklyScoreNumber.textContent = thisWeekData.score.toFixed(1);
            weeklyScoreMessage.textContent = getScoreMessage(thisWeekData.score);
            
            // Update progress bar
            weeklyProgressBar.style.setProperty('--progress', `${thisWeekData.score * 10}%`);
            
            // Update breakdown
            weeklyBreakdown.innerHTML = `
                <div class="weekly-breakdown-item">
                    <div class="weekly-breakdown-icon">☀️</div>
                    <div class="weekly-breakdown-info">
                        <div class="weekly-breakdown-count">${thisWeekData.dailyCount}</div>
                        <div class="weekly-breakdown-label">Daily</div>
                    </div>
                    <div class="weekly-breakdown-points">+${thisWeekData.dailyPoints}</div>
                </div>
                <div class="weekly-breakdown-item">
                    <div class="weekly-breakdown-icon">📆</div>
                    <div class="weekly-breakdown-info">
                        <div class="weekly-breakdown-count">${thisWeekData.weeklyCount}</div>
                        <div class="weekly-breakdown-label">Weekly</div>
                    </div>
                    <div class="weekly-breakdown-points">+${thisWeekData.weeklyPoints}</div>
                </div>
                <div class="weekly-breakdown-item">
                    <div class="weekly-breakdown-icon">🗓️</div>
                    <div class="weekly-breakdown-info">
                        <div class="weekly-breakdown-count">${thisWeekData.monthlyCount}</div>
                        <div class="weekly-breakdown-label">Monthly</div>
                    </div>
                    <div class="weekly-breakdown-points">+${thisWeekData.monthlyPoints}</div>
                </div>
                <div class="weekly-breakdown-item">
                    <div class="weekly-breakdown-icon">📊</div>
                    <div class="weekly-breakdown-info">
                        <div class="weekly-breakdown-count">${thisWeekData.quarterlyCount}</div>
                        <div class="weekly-breakdown-label">Quarterly</div>
                    </div>
                    <div class="weekly-breakdown-points">+${thisWeekData.quarterlyPoints}</div>
                </div>
            `;
            
            // Update comparison with last week
            const diff = thisWeekData.score - lastWeekData.score;
            let comparisonClass, comparisonIcon, comparisonText;
            
            if (diff > 0) {
                comparisonClass = 'weekly-comparison-positive';
                comparisonIcon = '📈';
                comparisonText = `Up ${diff.toFixed(1)} from last week (${lastWeekData.score.toFixed(1)})`;
            } else if (diff < 0) {
                comparisonClass = 'weekly-comparison-negative';
                comparisonIcon = '📉';
                comparisonText = `Down ${Math.abs(diff).toFixed(1)} from last week (${lastWeekData.score.toFixed(1)})`;
            } else {
                comparisonClass = 'weekly-comparison-neutral';
                comparisonIcon = '➡️';
                comparisonText = `Same as last week (${lastWeekData.score.toFixed(1)})`;
            }
            
            weeklyComparison.innerHTML = `
                <span class="weekly-comparison-icon">${comparisonIcon}</span>
                <span class="${comparisonClass}">${comparisonText}</span>
            `;
            
            // Save this week's score to history (for end of week tracking)
            saveWeeklyScoreIfNeeded(thisWeekStart, thisWeekData);
        }

        function saveWeeklyScoreIfNeeded(weekStart, scoreData) {
            const weekKey = weekStart.toISOString().split('T')[0];
            
            // Update or add the current week's score
            const existingIndex = weeklyScoreHistory.findIndex(w => w.weekKey === weekKey);
            const weekRecord = {
                weekKey,
                weekStart: weekStart.toISOString(),
                score: scoreData.score,
                dailyCount: scoreData.dailyCount,
                weeklyCount: scoreData.weeklyCount,
                monthlyCount: scoreData.monthlyCount,
                quarterlyCount: scoreData.quarterlyCount,
                lastUpdated: new Date().toISOString()
            };
            
            if (existingIndex >= 0) {
                weeklyScoreHistory[existingIndex] = weekRecord;
            } else {
                weeklyScoreHistory.push(weekRecord);
            }
            
            // Keep only last 12 weeks
            weeklyScoreHistory = weeklyScoreHistory
                .sort((a, b) => new Date(b.weekStart) - new Date(a.weekStart))
                .slice(0, 12);
            
            saveWeeklyScoreHistory();
        }

        function renderWeeklyHistory() {
            // Recalculate all historical weeks from completion history
            const weeks = [];
            const now = new Date();
            
            for (let i = 0; i < 12; i++) {
                const weekStart = getWeekStartDate(now);
                weekStart.setDate(weekStart.getDate() - (i * 7));
                
                const completions = getCompletionsForWeek(weekStart);
                const scoreData = calculateWeeklyScore(completions);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                weeks.push({
                    weekStart,
                    weekEnd,
                    ...scoreData,
                    label: i === 0 ? 'This Week' : i === 1 ? 'Last Week' : formatWeekRange(weekStart, weekEnd)
                });
            }
            
            if (weeks.every(w => w.score === 0)) {
                weeklyHistoryContent.innerHTML = `
                    <div class="weekly-history-empty">
                        <p>📊 No score history yet.</p>
                        <p>Complete tasks to start tracking your weekly progress!</p>
                    </div>
                `;
                return;
            }
            
            weeklyHistoryContent.innerHTML = weeks.map(week => `
                <div class="weekly-history-item">
                    <div class="weekly-history-score ${getScoreClass(week.score)}">${week.score.toFixed(1)}</div>
                    <div class="weekly-history-info">
                        <div class="weekly-history-date">${week.label}</div>
                        <div class="weekly-history-breakdown">
                            ${week.dailyCount} daily · ${week.weeklyCount} weekly · ${week.monthlyCount} monthly · ${week.quarterlyCount} quarterly
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatWeekRange(start, end) {
            const options = { month: 'short', day: 'numeric' };
            return `${start.toLocaleDateString('en-US', options)} - ${end.toLocaleDateString('en-US', options)}`;
        }

        function saveWeeklyScoreHistory() {
            db.collection('planner').doc('weeklyScores').set({
                history: weeklyScoreHistory,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving weekly scores:", error);
            });
        }

        function loadWeeklyScoreHistory() {
            return db.collection('planner').doc('weeklyScores').get()
                .then(doc => {
                    if (doc.exists) {
                        weeklyScoreHistory = doc.data().history || [];
                    }
                })
                .catch(error => {
                    console.error("Error loading weekly scores:", error);
                });
        }

        // ========== CALENDAR ==========
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            calendarTitle.textContent = `${months[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            
            let html = `
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            `;
            
            // Previous month days
            const prevMonthDate = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthDate.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && day === today.getDate();
                const dayOfWeek = new Date(year, month, day).getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                html += `<div class="calendar-day${isToday ? ' today' : ''}${isWeekend ? ' weekend' : ''}" data-day="${day}" onclick="openDayModal(${day}, ${month}, ${year})">
                    <div class="day-number">${day}</div>
                    <div class="day-tasks">
                        ${getTasksForDay(day, dayOfWeek, month)}
                    </div>
                </div>`;
            }
            
            // Next month days
            const totalCells = startDay + daysInMonth;
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remaining; i++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
            }
            
            calendarGrid.innerHTML = html;
        }

        function getTasksForDay(day, dayOfWeek, month) {
            // No tasks on weekends
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return '<div style="font-size:0.65rem;color:var(--text-muted);opacity:0.5;">OFF</div>';
            }
            
            let pills = [];
            
            // Daily tasks on weekdays
            if (tasks.daily.length > 0) {
                pills.push(`<div class="task-pill daily">${tasks.daily.length} daily</div>`);
            }
            
            // Weekly tasks spread across Mon-Fri
            if (tasks.weekly.length > 0) {
                const weekdayIndex = dayOfWeek - 1;
                const weeklyCount = tasks.weekly.filter((t, i) => (i % 5) === weekdayIndex).length;
                if (weeklyCount > 0) {
                    pills.push(`<div class="task-pill weekly">${weeklyCount} weekly</div>`);
                }
            }
            
            // Monthly tasks spread across weeks
            if (tasks.monthly.length > 0) {
                const weekOfMonth = Math.ceil(day / 7);
                const monthlyCount = tasks.monthly.filter((t, i) => {
                    const targetWeek = (i % 4) + 1;
                    const targetDay = (i % 5) + 1;
                    return weekOfMonth === targetWeek && dayOfWeek === targetDay;
                }).length;
                if (monthlyCount > 0) {
                    pills.push(`<div class="task-pill monthly">${monthlyCount} monthly</div>`);
                }
            }
            
            // Quarterly on first Monday of quarter months
            if (day <= 7 && dayOfWeek === 1 && [0, 3, 6, 9].includes(month) && tasks.quarterly.length > 0) {
                pills.push(`<div class="task-pill quarterly">Quarterly</div>`);
            }
            
            return pills.slice(0, 3).join('');
        }

        prevMonth.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonth.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        todayBtn.addEventListener('click', () => {
            currentDate = new Date();
            renderCalendar();
        });

        // ========== DAY MODAL ==========
        closeDayModal.addEventListener('click', () => dayModal.classList.remove('open'));
        dayModal.addEventListener('click', (e) => {
            if (e.target === dayModal) dayModal.classList.remove('open');
        });

        function openDayModal(day, month, year) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            
            // Skip weekends (0 = Sunday, 6 = Saturday)
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return; // Don't open modal for weekends
            }
            
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('dayModalNumber').textContent = day;
            document.getElementById('dayModalTitle').textContent = `${dayNames[dayOfWeek]}, ${monthNames[month]} ${day}`;
            
            // Determine which task categories apply to this day
            const sections = [];
            
            // Daily tasks on weekdays only
            if (tasks.daily.length > 0) {
                sections.push({ type: 'daily', title: 'Daily Tasks', tasks: tasks.daily });
            }
            
            // Weekly tasks spread across weekdays (Mon-Fri based on task index)
            if (tasks.weekly.length > 0) {
                const weekdayIndex = dayOfWeek - 1; // 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri
                const weeklyForDay = tasks.weekly.filter((t, i) => (i % 5) === weekdayIndex);
                if (weeklyForDay.length > 0) {
                    sections.push({ type: 'weekly', title: 'Weekly Tasks', tasks: weeklyForDay });
                }
            }
            
            // Monthly tasks on specific weekdays of the month
            if (tasks.monthly.length > 0) {
                const weekOfMonth = Math.ceil(day / 7);
                const monthlyForDay = tasks.monthly.filter((t, i) => {
                    const targetWeek = (i % 4) + 1;
                    const targetDay = (i % 5) + 1;
                    return weekOfMonth === targetWeek && dayOfWeek === targetDay;
                });
                if (monthlyForDay.length > 0) {
                    sections.push({ type: 'monthly', title: 'Monthly Tasks', tasks: monthlyForDay });
                }
            }
            
            // Quarterly on 1st weekday of Jan, Apr, Jul, Oct
            if (day <= 7 && dayOfWeek === 1 && [0, 3, 6, 9].includes(month) && tasks.quarterly.length > 0) {
                sections.push({ type: 'quarterly', title: 'Quarterly Tasks', tasks: tasks.quarterly });
            }
            
            // Update subtitle
            const sectionNames = sections.map(s => s.title.replace(' Tasks', '')).join(' + ');
            document.getElementById('dayModalSubtitle').textContent = sectionNames || 'No scheduled tasks';
            
            // Render tasks
            const modalBody = document.getElementById('dayModalBody');
            
            if (sections.length === 0) {
                modalBody.innerHTML = `<div class="no-tasks-message">No tasks scheduled for this day.<br>Daily tasks appear every day!</div>`;
            } else {
                modalBody.innerHTML = sections.map(section => `
                    <div class="day-section">
                        <div class="day-section-header">
                            <div class="day-section-dot ${section.type}"></div>
                            <span class="day-section-title">${section.title}</span>
                            <span class="day-section-count">${section.tasks.length} tasks</span>
                        </div>
                        <div class="day-task-list">
                            ${section.tasks.map(task => `
                                <div class="day-task-item">
                                    <div class="day-task-checkbox ${task.completed ? 'checked' : ''}" 
                                         onclick="toggleTaskFromModal('${section.type}', ${task.id})"></div>
                                    <div class="day-task-content">
                                        <div class="day-task-title ${task.completed ? 'completed' : ''}">${task.title}</div>
                                        <div class="day-task-category">${task.category}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            dayModal.classList.add('open');
        }

        function toggleTaskFromModal(frequency, id) {
            const task = tasks[frequency].find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
                // Re-render the modal with updated state
                const day = parseInt(document.getElementById('dayModalNumber').textContent);
                openDayModal(day, currentDate.getMonth(), currentDate.getFullYear());
                renderCurrentView();
            }
        }

        window.openDayModal = openDayModal;
        window.toggleTaskFromModal = toggleTaskFromModal;

        // ========== TASK EDITOR MODAL ==========
        closeTaskEditor.addEventListener('click', () => taskEditorModal.classList.remove('open'));
        taskEditorModal.addEventListener('click', (e) => {
            if (e.target === taskEditorModal) taskEditorModal.classList.remove('open');
        });

        const frequencyConfig = {
            daily: { icon: '☀️', title: 'Daily Tasks', subtitle: 'Tasks that repeat every weekday (Mon-Fri)', color: '#22c55e' },
            weekly: { icon: '📆', title: 'Weekly Tasks', subtitle: 'Spread across weekdays throughout the week', color: '#3b82f6' },
            monthly: { icon: '🗓️', title: 'Monthly Tasks', subtitle: 'Distributed across different weeks of the month', color: '#a855f7' },
            quarterly: { icon: '📊', title: 'Quarterly Tasks', subtitle: 'Appear on first Monday of Jan, Apr, Jul, Oct', color: '#f97316' },
            yearly: { icon: '🎯', title: 'Yearly Goals', subtitle: 'Annual milestones and planning tasks', color: '#ec4899' }
        };

        function openTaskEditor(frequency) {
            currentEditorFrequency = frequency;
            const config = frequencyConfig[frequency];
            
            document.getElementById('editorIcon').textContent = config.icon;
            document.getElementById('editorIcon').style.background = config.color;
            document.getElementById('editorTitle').textContent = config.title;
            document.getElementById('editorSubtitle').textContent = config.subtitle;
            
            renderTaskEditor(frequency);
            taskEditorModal.classList.add('open');
        }

        function renderTaskEditor(frequency) {
            const container = document.getElementById('taskEditorBody');
            const taskList = tasks[frequency];
            
            if (taskList.length === 0) {
                container.innerHTML = `
                    <div class="editor-empty">
                        <div class="editor-empty-icon">${frequencyConfig[frequency].icon}</div>
                        <p>No ${frequency} tasks yet</p>
                        <button class="btn btn-primary" onclick="addNewTaskInEditor()">＋ Add your first task</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = taskList.map(task => {
                // Times per week selector (only for weekly tasks)
                const timesPerWeekHtml = frequency === 'weekly' ? `
                    <select class="editor-times-select" onchange="updateEditorTaskTimesPerWeek(${task.id}, this.value)" title="Times per week">
                        <option value="1" ${(task.timesPerWeek || 1) === 1 ? 'selected' : ''}>1x/week</option>
                        <option value="2" ${task.timesPerWeek === 2 ? 'selected' : ''}>2x/week</option>
                        <option value="3" ${task.timesPerWeek === 3 ? 'selected' : ''}>3x/week</option>
                        <option value="4" ${task.timesPerWeek === 4 ? 'selected' : ''}>4x/week</option>
                        <option value="5" ${task.timesPerWeek === 5 ? 'selected' : ''}>5x/week</option>
                    </select>
                ` : '';
                
                return `
                    <div class="editor-task-item" data-id="${task.id}">
                        <div class="editor-task-drag">⋮⋮</div>
                        <div class="editor-task-content">
                            <span class="editor-task-title" contenteditable="true" 
                                  onblur="updateEditorTaskTitle(${task.id}, this.textContent)"
                                  onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${task.title}</span>
                            <div class="editor-task-meta">
                                <select class="editor-category-select" onchange="updateEditorTaskCategory(${task.id}, this.value)">
                                    ${getCategoryOptionsHtml(task.category)}
                                </select>
                                ${timesPerWeekHtml}
                            </div>
                        </div>
                        <button class="editor-pin-btn ${task.pinned ? 'pinned' : ''}" onclick="togglePinTaskInEditor(${task.id})" title="${task.pinned ? 'Unpin from Coming Up' : 'Pin to Coming Up'}">📌</button>
                        <button class="editor-delete-btn" onclick="deleteEditorTask(${task.id})" title="Delete task">🗑️</button>
                    </div>
                `;
            }).join('');
        }

        function updateEditorTaskTitle(id, newTitle) {
            const task = tasks[currentEditorFrequency].find(t => t.id === id);
            if (task && newTitle.trim()) {
                task.title = newTitle.trim();
                saveTasks();
                renderCurrentView();
                updateStats();
            }
        }

        function updateEditorTaskCategory(id, newCategory) {
            const task = tasks[currentEditorFrequency].find(t => t.id === id);
            if (task) {
                task.category = newCategory;
                saveTasks();
                renderCurrentView();
            }
        }

        function updateEditorTaskTimesPerWeek(id, times) {
            const task = tasks['weekly'].find(t => t.id === id);
            if (task) {
                task.timesPerWeek = parseInt(times) || 1;
                saveTasks();
                renderFrequencyPinnedTasks();
            }
        }

        function deleteEditorTask(id) {
            tasks[currentEditorFrequency] = tasks[currentEditorFrequency].filter(t => t.id !== id);
            saveTasks();
            renderTaskEditor(currentEditorFrequency);
            renderCurrentView();
            updateStats();
        }

        function togglePinTaskInEditor(id) {
            const task = tasks[currentEditorFrequency].find(t => t.id === id);
            if (task) {
                task.pinned = !task.pinned;
                saveTasks();
                renderTaskEditor(currentEditorFrequency);
                renderAllTaskLists();
                renderDailyHabits(); // Explicitly render daily habits for daily tasks
                updateComingUp();
            }
        }

        function addNewTaskInEditor() {
            const newId = Math.max(...Object.values(tasks).flat().map(t => t.id), 0) + 1;
            tasks[currentEditorFrequency].push({
                id: newId,
                title: 'New task - click to edit',
                category: 'stories',
                completed: false,
                pinned: false
            });
            saveTasks();
            renderTaskEditor(currentEditorFrequency);
            renderCurrentView();
            updateStats();
            
            // Focus on the new task title
            setTimeout(() => {
                const newTaskEl = document.querySelector(`[data-id="${newId}"] .editor-task-title`);
                if (newTaskEl) {
                    newTaskEl.focus();
                    // Select all text
                    const range = document.createRange();
                    range.selectNodeContents(newTaskEl);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }, 100);
        }

        addTaskInEditor.addEventListener('click', addNewTaskInEditor);

        window.openTaskEditor = openTaskEditor;
        window.updateEditorTaskTitle = updateEditorTaskTitle;
        window.updateEditorTaskCategory = updateEditorTaskCategory;
        window.updateEditorTaskTimesPerWeek = updateEditorTaskTimesPerWeek;
        window.deleteEditorTask = deleteEditorTask;
        window.togglePinTaskInEditor = togglePinTaskInEditor;
        window.addNewTaskInEditor = addNewTaskInEditor;

        // ========== CATEGORY MANAGEMENT ==========
        function openCategoryManager() {
            tempCategories = JSON.parse(JSON.stringify(categories));
            renderCategoryList();
            categoryModal.classList.add('open');
        }

        function closeCategoryManagerModal() {
            categoryModal.classList.remove('open');
        }

        function renderCategoryList() {
            categoryList.innerHTML = tempCategories.map((cat, index) => `
                <div class="category-item ${index < 8 ? 'default' : ''}" data-id="${cat.id}">
                    <input type="text" class="category-icon-input" value="${cat.icon}" 
                           maxlength="2" onchange="updateTempCategory('${cat.id}', 'icon', this.value)">
                    <input type="text" class="category-name-input" value="${cat.name}" 
                           placeholder="Category name" onchange="updateTempCategory('${cat.id}', 'name', this.value)">
                    <input type="color" class="category-color-picker" value="${cat.color}" 
                           onchange="updateTempCategory('${cat.id}', 'color', this.value)">
                    <button class="category-delete-btn" onclick="deleteTempCategory('${cat.id}')" title="Delete">🗑️</button>
                </div>
            `).join('');
        }

        function updateTempCategory(id, field, value) {
            const cat = tempCategories.find(c => c.id === id);
            if (cat) {
                cat[field] = value;
                if (field === 'name') {
                    // Update the id to match the name (lowercase, no spaces)
                    const newId = value.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
                    if (newId && !tempCategories.some(c => c.id === newId && c !== cat)) {
                        cat.id = newId;
                    }
                }
            }
        }

        function deleteTempCategory(id) {
            // Don't allow deleting default categories
            const index = tempCategories.findIndex(c => c.id === id);
            if (index >= 8) {
                tempCategories = tempCategories.filter(c => c.id !== id);
                renderCategoryList();
            }
        }

        function addNewCategory() {
            const newId = 'custom_' + Date.now();
            tempCategories.push({
                id: newId,
                name: 'New Category',
                icon: '📌',
                color: '#6b7280'
            });
            renderCategoryList();
            // Focus on the new category name input
            setTimeout(() => {
                const inputs = categoryList.querySelectorAll('.category-name-input');
                if (inputs.length > 0) {
                    inputs[inputs.length - 1].focus();
                    inputs[inputs.length - 1].select();
                }
            }, 50);
        }

        function saveAllCategories() {
            categories = JSON.parse(JSON.stringify(tempCategories));
            saveCategoriestoFirebase();
            updateCategoryStyles();
            populateCategoryDropdowns();
            closeCategoryManagerModal();
            
            // Re-render task lists to apply new category styles
            renderAllTaskLists();
            if (taskEditorModal.classList.contains('open')) {
                renderTaskEditor(currentEditorFrequency);
            }
        }

        function updateCategoryStyles() {
            // Create dynamic styles for custom categories
            let styleEl = document.getElementById('dynamic-category-styles');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamic-category-styles';
                document.head.appendChild(styleEl);
            }
            
            const styles = categories.map(cat => {
                const rgbColor = hexToRgb(cat.color);
                return `
                    .task-category.${cat.id} { 
                        background: rgba(${rgbColor.r}, ${rgbColor.g}, ${rgbColor.b}, 0.2); 
                        color: ${cat.color}; 
                    }
                `;
            }).join('\n');
            
            styleEl.textContent = styles;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 107, g: 114, b: 128 };
        }

        function populateCategoryDropdowns() {
            // Populate the main add task modal dropdown
            const optionsHtml = categories.map(cat => 
                `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`
            ).join('');
            
            taskCategorySelect.innerHTML = optionsHtml;
        }

        function getCategoryOptionsHtml(selectedCategory) {
            return categories.map(cat => 
                `<option value="${cat.id}" ${selectedCategory === cat.id ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
            ).join('');
        }

        function saveCategoriestoFirebase() {
            db.collection('planner').doc('categories').set({
                list: categories,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving categories to Firebase:", error);
            });
        }

        function loadCategories() {
            return db.collection('planner').doc('categories').get()
                .then(doc => {
                    if (doc.exists && doc.data().list) {
                        categories = doc.data().list;
                    } else {
                        // First time - save default categories to Firebase
                        categories = [...defaultCategories];
                        saveCategoriestoFirebase();
                    }
                })
                .catch(error => {
                    console.error("Error loading categories from Firebase:", error);
                    categories = [...defaultCategories];
                });
        }

        function listenForCategoryUpdates() {
            db.collection('planner').doc('categories').onSnapshot(doc => {
                if (doc.exists && doc.data().list) {
                    categories = doc.data().list;
                    updateCategoryStyles();
                    populateCategoryDropdowns();
                    renderAllTaskLists();
                }
            }, error => {
                console.error("Error listening to category updates:", error);
            });
        }

        // Category modal event listeners
        closeCategoryModal.addEventListener('click', closeCategoryManagerModal);
        cancelCategories.addEventListener('click', closeCategoryManagerModal);
        saveCategories.addEventListener('click', saveAllCategories);
        addCategoryBtn.addEventListener('click', addNewCategory);
        categoryModal.addEventListener('click', (e) => {
            if (e.target === categoryModal) closeCategoryManagerModal();
        });

        window.openCategoryManager = openCategoryManager;
        window.updateTempCategory = updateTempCategory;
        window.deleteTempCategory = deleteTempCategory;

        // ========== TASK LISTS ==========
        function renderTaskList(frequency) {
            const container = document.getElementById(frequency + 'Tasks');
            if (!container) return; // Skip if container doesn't exist
            
            const taskList = tasks[frequency];
            
            if (taskList.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    No ${frequency} tasks yet. Click "Add Task" to get started!
                </div>`;
                return;
            }
            
            container.innerHTML = taskList.map(task => `
                <div class="task-item" data-id="${task.id}" data-frequency="${frequency}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${frequency}', ${task.id})"></div>
                    <div class="task-content">
                        <div class="task-title" contenteditable="true" onblur="updateTaskTitle('${frequency}', ${task.id}, this.textContent)">${task.title}</div>
                        <div class="task-meta">
                            <span class="task-category ${task.category}">${task.category}</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-pin-btn ${task.pinned ? 'pinned' : ''}" onclick="togglePinTask('${frequency}', ${task.id})" title="${task.pinned ? 'Unpin from Coming Up' : 'Pin to Coming Up'}">📌</button>
                        <button class="task-action-btn" onclick="deleteTask('${frequency}', ${task.id})" title="Delete">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleTask(frequency, id) {
            const task = tasks[frequency].find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                
                // Record completion in history
                if (task.completed) {
                    completionHistory.push({
                        id: Date.now(),
                        taskId: task.id,
                        title: task.title,
                        category: task.category,
                        frequency: frequency,
                        completedAt: new Date().toISOString()
                    });
                    saveCompletionHistory();
                }
                
                saveTasks();
                renderCurrentView();
                updateRecentlyCompleted();
            }
        }

        function updateTaskTitle(frequency, id, newTitle) {
            const task = tasks[frequency].find(t => t.id === id);
            if (task && newTitle.trim()) {
                task.title = newTitle.trim();
                saveTasks();
            }
        }

        function deleteTask(frequency, id) {
            tasks[frequency] = tasks[frequency].filter(t => t.id !== id);
            saveTasks();
            renderCurrentView();
            updateStats();
        }

        function togglePinTask(frequency, id) {
            const task = tasks[frequency].find(t => t.id === id);
            if (task) {
                task.pinned = !task.pinned;
                saveTasks();
                renderAllTaskLists();
                updateComingUp();
            }
        }

        function unpinTask(frequency, id) {
            const task = tasks[frequency].find(t => t.id === id);
            if (task) {
                task.pinned = false;
                saveTasks();
                renderAllTaskLists();
                updateComingUp();
            }
        }

        function completePinnedTask(frequency, id) {
            const task = tasks[frequency].find(t => t.id === id);
            if (task) {
                // Record completion in history
                completionHistory.push({
                    id: Date.now(),
                    taskId: task.id,
                    title: task.title,
                    category: task.category,
                    frequency: frequency,
                    completedAt: new Date().toISOString()
                });
                saveCompletionHistory();
                
                // Unpin but don't mark as completed (so it stays in the task list for next time)
                task.pinned = false;
                saveTasks();
                
                renderAllTaskLists();
                updateComingUp();
                updateRecentlyCompleted();
                updateWeeklyProgress();
                updateStats();
            }
        }

        window.toggleTask = toggleTask;
        window.updateTaskTitle = updateTaskTitle;
        window.deleteTask = deleteTask;
        window.togglePinTask = togglePinTask;
        window.unpinTask = unpinTask;
        window.completePinnedTask = completePinnedTask;

        // ========== ADD TASK ==========
        addTaskBtn.addEventListener('click', () => addModal.classList.add('open'));
        closeModal.addEventListener('click', () => addModal.classList.remove('open'));
        cancelTask.addEventListener('click', () => addModal.classList.remove('open'));

        saveTask.addEventListener('click', () => {
            const title = document.getElementById('taskTitle').value.trim();
            const frequency = document.getElementById('taskFrequency').value;
            const category = document.getElementById('taskCategory').value;
            
            if (!title) return;
            
            const newId = Math.max(...Object.values(tasks).flat().map(t => t.id), 0) + 1;
            tasks[frequency].push({ id: newId, title, category, completed: false });
            
            saveTasks();
            renderCurrentView();
            updateStats();
            
            document.getElementById('taskTitle').value = '';
            addModal.classList.remove('open');
        });

        // ========== IDEAS PANEL ==========
        ideasBtn.addEventListener('click', () => ideasPanel.classList.add('open'));
        closeIdeas.addEventListener('click', () => ideasPanel.classList.remove('open'));

        function renderIdeas() {
            const container = document.getElementById('ideasContent');
            container.innerHTML = contentIdeas.map((idea, index) => `
                <div class="idea-card" onclick="openIdeaModal(${index})">
                    <div class="idea-type">${idea.type}</div>
                    <div class="idea-title">${idea.title}</div>
                    <div class="idea-desc">${idea.desc}</div>
                </div>
            `).join('');
        }

        function openIdeaModal(index) {
            const idea = contentIdeas[index];
            if (!idea) return;
            
            currentIdea = idea;
            
            // Set default mappings
            const categoryMap = {
                'Stories': 'stories',
                'Group Chat': 'groupchat',
                'Reels Post': 'reels',
                'IG Live': 'live',
                'Merch': 'merch',
                'Video': 'video',
                'Polls': 'polls'
            };
            
            const frequencyMap = {
                'Stories': 'daily',
                'Group Chat': 'daily',
                'Reels Post': 'weekly',
                'IG Live': 'weekly',
                'Merch': 'quarterly',
                'Video': 'quarterly',
                'Polls': 'monthly'
            };
            
            // Populate the preview
            ideaPreviewType.textContent = idea.type;
            ideaPreviewTitle.textContent = idea.title;
            ideaPreviewDesc.textContent = idea.desc;
            
            // Pre-fill the form
            ideaTaskTitle.value = idea.title;
            ideaFrequency.value = frequencyMap[idea.type] || 'weekly';
            ideaDescription.value = idea.desc;
            
            // Populate category dropdown
            ideaCategory.innerHTML = getCategoryOptionsHtml(categoryMap[idea.type] || 'reels');
            
            // Close ideas panel and open modal
            ideasPanel.classList.remove('open');
            addIdeaModal.classList.add('open');
        }

        closeIdeaModal.addEventListener('click', () => {
            addIdeaModal.classList.remove('open');
            currentIdea = null;
        });

        cancelIdea.addEventListener('click', () => {
            addIdeaModal.classList.remove('open');
            currentIdea = null;
        });

        addIdeaModal.addEventListener('click', (e) => {
            if (e.target === addIdeaModal) {
                addIdeaModal.classList.remove('open');
                currentIdea = null;
            }
        });

        saveIdea.addEventListener('click', () => {
            const title = ideaTaskTitle.value.trim();
            const frequency = ideaFrequency.value;
            const category = ideaCategory.value;
            const description = ideaDescription.value.trim();
            
            if (!title) return;
            
            const newId = Math.max(...Object.values(tasks).flat().map(t => t.id), 0) + 1;
            
            tasks[frequency].push({ 
                id: newId, 
                title, 
                category, 
                completed: false,
                pinned: false,
                description: description
            });
            
            saveTasks();
            renderCurrentView();
            updateStats();
            
            addIdeaModal.classList.remove('open');
            currentIdea = null;
            
            // Clear form
            ideaTaskTitle.value = '';
            ideaDescription.value = '';
        });

        window.openIdeaModal = openIdeaModal;

        // ========== STATS ==========
        function updateStats() {
            ['daily', 'weekly', 'monthly', 'quarterly', 'yearly'].forEach(freq => {
                const total = tasks[freq].length;
                const completed = tasks[freq].filter(t => t.completed).length;
                const remaining = total - completed;
                const percent = total > 0 ? (completed / total) * 100 : 0;
                
                document.getElementById(`${freq}Count`).textContent = total;
                document.getElementById(`${freq}Progress`).style.width = `${percent}%`;
                document.getElementById(`${freq}Completed`).textContent = `${completed} done`;
                document.getElementById(`${freq}Remaining`).textContent = `${remaining} left`;
            });
            
            updateNotifications();
            updateComingUp();
        }

        // ========== NOTIFICATIONS ==========
        notificationBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationDropdown.classList.toggle('open');
        });

        // Mobile close button for notifications
        const notificationCloseMobile = document.getElementById('notificationCloseMobile');
        notificationCloseMobile?.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationDropdown.classList.remove('open');
        });

        document.addEventListener('click', (e) => {
            if (!notificationDropdown.contains(e.target) && e.target !== notificationBtn) {
                notificationDropdown.classList.remove('open');
            }
        });

        // Notification tabs
        notificationTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                notificationTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentNotificationTab = tab.dataset.tab;
                renderNotificationList();
            });
        });

        // Notification settings
        notificationSettingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationDropdown.classList.remove('open');
            
            // Load current settings into form
            document.getElementById('weeklyReminder').value = notificationSettings.weekly;
            document.getElementById('monthlyReminder').value = notificationSettings.monthly;
            document.getElementById('quarterlyReminder').value = notificationSettings.quarterly;
            document.getElementById('yearlyReminder').value = notificationSettings.yearly;
            notificationEmail.value = notificationSettings.email || '';
            emailFrequency.value = notificationSettings.emailFrequency || 'off';
            
            // Show/hide test button based on email
            updateEmailTestVisibility();
            
            notificationSettingsModal.classList.add('open');
        });

        // Update test email visibility when email changes
        notificationEmail.addEventListener('input', updateEmailTestVisibility);
        emailFrequency.addEventListener('change', updateEmailTestVisibility);

        function updateEmailTestVisibility() {
            const hasEmail = notificationEmail.value.trim() !== '';
            const isEnabled = emailFrequency.value !== 'off';
            emailTestSection.style.display = (hasEmail && isEnabled) ? 'block' : 'none';
            emailStatus.textContent = '';
            emailStatus.className = 'email-status';
        }

        // Send test email
        sendTestEmail.addEventListener('click', async () => {
            const emails = parseEmails(notificationEmail.value);
            if (emails.length === 0) {
                emailStatus.textContent = '❌ Please enter at least one valid email address';
                emailStatus.className = 'email-status error';
                return;
            }
            
            emailStatus.textContent = `📤 Sending test to ${emails.length} email${emails.length > 1 ? 's' : ''}...`;
            emailStatus.className = 'email-status info';
            
            try {
                const result = await sendEmailToAll(true);
                if (result.failed === 0) {
                    emailStatus.textContent = `✅ Test sent to ${result.successful} email${result.successful > 1 ? 's' : ''}! Check inbox.`;
                    emailStatus.className = 'email-status success';
                } else {
                    emailStatus.textContent = `⚠️ Sent ${result.successful}/${result.total}. ${result.failed} failed.`;
                    emailStatus.className = 'email-status error';
                }
            } catch (error) {
                console.error('Email error:', error);
                emailStatus.textContent = '❌ Failed to send. Check EmailJS setup.';
                emailStatus.className = 'email-status error';
            }
        });

        closeNotificationSettings.addEventListener('click', () => {
            notificationSettingsModal.classList.remove('open');
        });

        notificationSettingsModal.addEventListener('click', (e) => {
            if (e.target === notificationSettingsModal) {
                notificationSettingsModal.classList.remove('open');
            }
        });

        saveNotificationSettingsBtn.addEventListener('click', () => {
            notificationSettings.weekly = parseInt(document.getElementById('weeklyReminder').value);
            notificationSettings.monthly = parseInt(document.getElementById('monthlyReminder').value);
            notificationSettings.quarterly = parseInt(document.getElementById('quarterlyReminder').value);
            notificationSettings.yearly = parseInt(document.getElementById('yearlyReminder').value);
            notificationSettings.email = notificationEmail.value.trim();
            notificationSettings.emailFrequency = emailFrequency.value;
            
            saveNotificationSettings();
            notificationSettingsModal.classList.remove('open');
            updateNotifications();
            
            // Check if we should send email now
            checkAndSendScheduledEmail();
        });

        // Helper to parse multiple emails from textarea
        function parseEmails(emailString) {
            if (!emailString) return [];
            return emailString
                .split(/[\n,;]+/)  // Split by newline, comma, or semicolon
                .map(e => e.trim())
                .filter(e => e && e.includes('@'));  // Basic validation
        }

        // Email notification functions
        async function sendEmailNotification(toEmail, isTest = false) {
            const dueTasks = getDueTasks();
            
            // Get weekly score
            const thisWeekStart = getWeekStartDate();
            const thisWeekCompletions = getCompletionsForWeek(thisWeekStart);
            const scoreData = calculateWeeklyScore(thisWeekCompletions);
            
            // Build HTML task list for email
            let taskListHtml = '';
            if (dueTasks.length > 0) {
                taskListHtml = dueTasks.map(task => {
                    const freqColors = {
                        daily: '#f59e0b',
                        weekly: '#3b82f6',
                        monthly: '#8b5cf6',
                        quarterly: '#f97316',
                        yearly: '#22c55e'
                    };
                    const color = freqColors[task.frequency] || '#6b7280';
                    return `
                        <tr>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                <div style="font-weight: 500; color: #1f2937; margin-bottom: 4px;">${task.title}</div>
                                <div>
                                    <span style="display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${color}; color: white; text-transform: uppercase;">${task.frequency}</span>
                                    <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">${task.timeText}</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                taskListHtml = `
                    <tr>
                        <td style="padding: 24px; text-align: center; color: #6b7280;">
                            ✨ No tasks due right now. Great job staying on top of things!
                        </td>
                    </tr>
                `;
            }
            
            // Build full HTML email
            const emailHtml = `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 32px; border-radius: 16px 16px 0 0; text-align: center;">
                        <div style="display: inline-block; background: linear-gradient(135deg, #f97316, #ea580c); padding: 12px 20px; border-radius: 12px; margin-bottom: 16px;">
                            <span style="color: white; font-weight: 700; font-size: 18px;">SJ</span>
                        </div>
                        <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 700;">SLOE JACK</h1>
                        <p style="color: #9ca3af; margin: 4px 0 0 0; font-size: 14px;">Subscriber Content Planner</p>
                    </div>
                    
                    <!-- Score Card -->
                    <div style="background: linear-gradient(135deg, #f97316, #ea580c); padding: 24px; text-align: center;">
                        <p style="color: rgba(255,255,255,0.8); margin: 0 0 8px 0; font-size: 14px;">Weekly Progress</p>
                        <div style="font-size: 48px; font-weight: 700; color: white;">${scoreData.score.toFixed(1)}</div>
                        <p style="color: rgba(255,255,255,0.8); margin: 8px 0 0 0; font-size: 14px;">out of 10</p>
                    </div>
                    
                    <!-- Message -->
                    <div style="background: #f9fafb; padding: 20px 24px; border-left: 4px solid #f97316;">
                        <p style="margin: 0; color: #374151; font-size: 15px;">
                            ${isTest ? '🧪 This is a test email from your SLOE JACK planner.' : '👋 Hey Creator! Here\'s your task update:'}
                        </p>
                    </div>
                    
                    <!-- Tasks -->
                    <div style="background: white; padding: 0;">
                        <div style="padding: 16px 24px; border-bottom: 2px solid #f3f4f6;">
                            <h2 style="margin: 0; font-size: 16px; color: #1f2937;">📋 ${dueTasks.length > 0 ? `Tasks Due (${dueTasks.length})` : 'All Caught Up!'}</h2>
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            ${taskListHtml}
                        </table>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #1f2937; padding: 24px; border-radius: 0 0 16px 16px; text-align: center;">
                        <p style="color: #9ca3af; margin: 0; font-size: 13px;">
                            📅 ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                        </p>
                        <p style="color: #6b7280; margin: 12px 0 0 0; font-size: 12px;">
                            Keep creating amazing content for your subscribers! 🚀
                        </p>
                    </div>
                </div>
            `;
            
            const templateParams = {
                to_email: toEmail,
                to_name: 'Creator',
                subject: isTest ? '🧪 Test: SLOE JACK Task Reminder' : '🔔 SLOE JACK Task Reminder',
                message_html: emailHtml,
                message_type: isTest ? 'This is a test email from your SLOE JACK Subscriber Content Planner.' : 'Here are your upcoming tasks:',
                task_list: dueTasks.map(t => `• ${t.title} (${t.frequency})`).join('\n'),
                task_count: dueTasks.length,
                weekly_score: scoreData.score.toFixed(1),
                date: new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
            };
            
            // Check if EmailJS is configured
            if (EMAILJS_CONFIG.serviceId === 'YOUR_SERVICE_ID') {
                throw new Error('EmailJS not configured');
            }
            
            return emailjs.send(
                EMAILJS_CONFIG.serviceId,
                EMAILJS_CONFIG.templateId,
                templateParams,
                EMAILJS_CONFIG.publicKey
            );
        }

        // Send to all emails
        async function sendEmailToAll(isTest = false) {
            const emails = parseEmails(notificationSettings.email);
            if (emails.length === 0) {
                throw new Error('No valid email addresses');
            }
            
            const results = await Promise.allSettled(
                emails.map(email => sendEmailNotification(email, isTest))
            );
            
            const successful = results.filter(r => r.status === 'fulfilled').length;
            const failed = results.filter(r => r.status === 'rejected').length;
            
            return { successful, failed, total: emails.length };
        }

        function checkAndSendScheduledEmail() {
            const emails = parseEmails(notificationSettings.email);
            if (notificationSettings.emailFrequency === 'off' || emails.length === 0) {
                return;
            }
            
            const now = new Date();
            const lastSent = notificationSettings.lastEmailSent ? new Date(notificationSettings.lastEmailSent) : null;
            
            let shouldSend = false;
            
            if (notificationSettings.emailFrequency === 'daily') {
                // Send if never sent or last sent was yesterday or earlier
                if (!lastSent || now.toDateString() !== lastSent.toDateString()) {
                    shouldSend = true;
                }
            } else if (notificationSettings.emailFrequency === 'weekly') {
                // Send on Monday if not sent this week
                const isMonday = now.getDay() === 1;
                const thisWeekStart = getWeekStartDate(now);
                if (isMonday && (!lastSent || lastSent < thisWeekStart)) {
                    shouldSend = true;
                }
            }
            
            if (shouldSend) {
                sendEmailToAll(false).then((result) => {
                    notificationSettings.lastEmailSent = now.toISOString();
                    saveNotificationSettings();
                    console.log(`Scheduled emails sent: ${result.successful}/${result.total} successful`);
                }).catch(error => {
                    console.error('Failed to send scheduled emails:', error);
                });
            }
        }

        function getDueTasks() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentDay = now.getDate();
            const currentDayOfWeek = now.getDay();
            const daysInMonth = new Date(now.getFullYear(), currentMonth + 1, 0).getDate();
            const daysLeftInMonth = daysInMonth - currentDay;
            const daysLeftInWeek = currentDayOfWeek === 0 ? 0 : 7 - currentDayOfWeek;
            
            // Calculate days left in quarter
            const quarterEndMonth = Math.ceil((currentMonth + 1) / 3) * 3 - 1;
            const quarterEndDate = new Date(now.getFullYear(), quarterEndMonth + 1, 0);
            const daysLeftInQuarter = Math.ceil((quarterEndDate - now) / (1000 * 60 * 60 * 24));
            
            // Calculate days left in year
            const yearEnd = new Date(now.getFullYear(), 11, 31);
            const daysLeftInYear = Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24));
            
            const dueTasks = [];
            
            // Weekly tasks due
            if (daysLeftInWeek <= notificationSettings.weekly) {
                tasks.weekly.filter(t => !t.completed).forEach(task => {
                    dueTasks.push({
                        ...task,
                        frequency: 'weekly',
                        daysLeft: daysLeftInWeek,
                        timeText: daysLeftInWeek === 0 ? 'Due today!' : `${daysLeftInWeek} day${daysLeftInWeek > 1 ? 's' : ''} left`,
                        icon: '📆'
                    });
                });
            }
            
            // Monthly tasks due
            if (daysLeftInMonth <= notificationSettings.monthly) {
                tasks.monthly.filter(t => !t.completed).forEach(task => {
                    dueTasks.push({
                        ...task,
                        frequency: 'monthly',
                        daysLeft: daysLeftInMonth,
                        timeText: `${daysLeftInMonth} day${daysLeftInMonth > 1 ? 's' : ''} left`,
                        icon: '🗓️'
                    });
                });
            }
            
            // Quarterly tasks due
            if (daysLeftInQuarter <= notificationSettings.quarterly) {
                tasks.quarterly.filter(t => !t.completed).forEach(task => {
                    dueTasks.push({
                        ...task,
                        frequency: 'quarterly',
                        daysLeft: daysLeftInQuarter,
                        timeText: `${daysLeftInQuarter} day${daysLeftInQuarter > 1 ? 's' : ''} left`,
                        icon: '📊'
                    });
                });
            }
            
            // Yearly tasks due
            if (daysLeftInYear <= notificationSettings.yearly) {
                tasks.yearly.filter(t => !t.completed).forEach(task => {
                    dueTasks.push({
                        ...task,
                        frequency: 'yearly',
                        daysLeft: daysLeftInYear,
                        timeText: `${daysLeftInYear} day${daysLeftInYear > 1 ? 's' : ''} left`,
                        icon: '🎯'
                    });
                });
            }
            
            // Sort by days left (most urgent first)
            dueTasks.sort((a, b) => a.daysLeft - b.daysLeft);
            
            return dueTasks;
        }

        function getUpcomingTasks() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentDay = now.getDate();
            const currentDayOfWeek = now.getDay();
            const daysInMonth = new Date(now.getFullYear(), currentMonth + 1, 0).getDate();
            const daysLeft = daysInMonth - currentDay;
            const daysLeftInWeek = currentDayOfWeek === 0 ? 0 : 7 - currentDayOfWeek;
            
            const upcoming = [];
            
            // Weekly tasks
            tasks.weekly.filter(t => !t.completed).forEach(task => {
                let urgency = 'upcoming';
                let timeText = 'This week';
                
                if (daysLeftInWeek <= 1) {
                    urgency = 'urgent';
                    timeText = daysLeftInWeek === 0 ? 'Due today' : '1 day left';
                } else if (daysLeftInWeek <= 3) {
                    urgency = 'soon';
                    timeText = `${daysLeftInWeek} days left`;
                }
                
                upcoming.push({
                    ...task,
                    frequency: 'weekly',
                    urgency,
                    timeText,
                    icon: '📆'
                });
            });
            
            // Monthly tasks
            tasks.monthly.filter(t => !t.completed).forEach(task => {
                let urgency = 'upcoming';
                let timeText = 'This month';
                
                if (daysLeft <= 3) {
                    urgency = 'urgent';
                    timeText = `${daysLeft} days left`;
                } else if (daysLeft <= 7) {
                    urgency = 'soon';
                    timeText = `${daysLeft} days left`;
                }
                
                upcoming.push({
                    ...task,
                    frequency: 'monthly',
                    urgency,
                    timeText,
                    icon: '🗓️'
                });
            });
            
            // Quarterly tasks
            tasks.quarterly.filter(t => !t.completed).forEach(task => {
                upcoming.push({
                    ...task,
                    frequency: 'quarterly',
                    urgency: 'upcoming',
                    timeText: 'This quarter',
                    icon: '📊'
                });
            });
            
            // Yearly tasks
            tasks.yearly.filter(t => !t.completed).forEach(task => {
                upcoming.push({
                    ...task,
                    frequency: 'yearly',
                    urgency: 'upcoming',
                    timeText: 'This year',
                    icon: '🎯'
                });
            });
            
            // Sort by urgency
            const urgencyOrder = { urgent: 0, soon: 1, upcoming: 2 };
            upcoming.sort((a, b) => urgencyOrder[a.urgency] - urgencyOrder[b.urgency]);
            
            return upcoming;
        }

        function renderNotificationList() {
            if (currentNotificationTab === 'due') {
                const dueTasks = getDueTasks();
                
                if (dueTasks.length === 0) {
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <div class="notification-empty-icon">✅</div>
                            <p>No tasks due right now!<br>You're all caught up.</p>
                        </div>
                    `;
                    return;
                }
                
                notificationList.innerHTML = dueTasks.map(task => `
                    <div class="notification-item due">
                        <div class="notification-icon ${task.frequency}">${task.icon}</div>
                        <div class="notification-content">
                            <div class="notification-title">${task.title}</div>
                            <div class="notification-meta">
                                <span class="notification-tag ${task.frequency}">${task.frequency}</span>
                                <span class="notification-due-badge">${task.timeText}</span>
                            </div>
                        </div>
                        <button class="notification-pin-btn" onclick="event.stopPropagation(); quickPinTask('${task.frequency}', ${task.id})" title="Pin to focus">📌</button>
                    </div>
                `).join('');
            } else {
                const upcoming = getUpcomingTasks();
                
                if (upcoming.length === 0) {
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <div class="notification-empty-icon">📋</div>
                            <p>No upcoming tasks.<br>Add some tasks to get started!</p>
                        </div>
                    `;
                    return;
                }
                
                notificationList.innerHTML = upcoming.map(task => `
                    <div class="notification-item" onclick="openTaskEditor('${task.frequency}')">
                        <div class="notification-icon ${task.frequency}">${task.icon}</div>
                        <div class="notification-content">
                            <div class="notification-title">${task.title}</div>
                            <div class="notification-meta">
                                <span class="notification-tag ${task.frequency}">${task.frequency}</span>
                                <span class="notification-tag ${task.urgency}">${task.timeText}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function quickPinTask(frequency, id) {
            const task = tasks[frequency].find(t => t.id === id);
            if (task) {
                task.pinned = true;
                saveTasks();
                updateComingUp();
                renderNotificationList();
            }
        }

        window.quickPinTask = quickPinTask;

        function updateNotifications() {
            const dueTasks = getDueTasks();
            const dueCount = dueTasks.length;
            
            notificationBadge.textContent = dueCount;
            notificationBadge.style.display = dueCount > 0 ? 'flex' : 'none';
            
            renderNotificationList();
        }

        function saveNotificationSettings() {
            db.collection('planner').doc('notificationSettings').set({
                settings: notificationSettings,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving notification settings:", error);
            });
        }

        function loadNotificationSettings() {
            return db.collection('planner').doc('notificationSettings').get()
                .then(doc => {
                    if (doc.exists && doc.data().settings) {
                        notificationSettings = { ...notificationSettings, ...doc.data().settings };
                    }
                })
                .catch(error => {
                    console.error("Error loading notification settings:", error);
                });
        }

        // ========== DAILY HABITS ==========
        addDailyHabitBtn.addEventListener('click', () => {
            dailyHabitTitle.value = '';
            dailyHabitDescription.value = '';
            dailyHabitCategory.innerHTML = getCategoryOptionsHtml('stories');
            addDailyHabitModal.classList.add('open');
        });

        closeDailyHabitModal.addEventListener('click', () => addDailyHabitModal.classList.remove('open'));
        cancelDailyHabit.addEventListener('click', () => addDailyHabitModal.classList.remove('open'));
        addDailyHabitModal.addEventListener('click', (e) => {
            if (e.target === addDailyHabitModal) addDailyHabitModal.classList.remove('open');
        });

        saveDailyHabit.addEventListener('click', () => {
            const title = dailyHabitTitle.value.trim();
            if (!title) return;
            
            const newHabit = {
                id: Date.now(),
                title: title,
                category: dailyHabitCategory.value,
                description: dailyHabitDescription.value.trim()
            };
            
            dailyHabits.push(newHabit);
            saveDailyHabits();
            renderDailyHabits();
            addDailyHabitModal.classList.remove('open');
        });

        function checkAndResetDailyHabits() {
            const today = new Date().toDateString();
            
            if (lastHabitResetDate !== today) {
                // It's a new day - reset all habits
                dailyHabitsCompletedToday = [];
                lastHabitResetDate = today;
                saveDailyHabitsState();
                renderDailyHabits();
                
                // Also check if it's a new week (Sunday) to reset weekly data
                checkAndResetPinnedCompletions();
                updateWeeklyProgress();
                updateRecentlyCompleted();
            }
        }

        function toggleDailyHabit(itemKey, isPinnedTask = false) {
            const index = dailyHabitsCompletedToday.indexOf(itemKey);
            
            // Get the item details
            let item;
            if (isPinnedTask) {
                const taskId = parseInt(itemKey.replace('task-', ''));
                item = tasks.daily.find(t => t.id === taskId);
            } else {
                item = dailyHabits.find(h => h.id === itemKey);
            }
            
            if (index === -1) {
                // Mark as completed
                dailyHabitsCompletedToday.push(itemKey);
                
                // Record completion in history for weekly score
                if (item) {
                    completionHistory.push({
                        id: Date.now(),
                        taskId: itemKey,
                        title: item.title,
                        category: item.category,
                        frequency: 'daily',
                        completedAt: new Date().toISOString(),
                        isDailyHabit: true
                    });
                    saveCompletionHistory();
                }
            } else {
                // Unmark - remove from completed today
                dailyHabitsCompletedToday.splice(index, 1);
                
                // Remove the completion from history (today only)
                const today = new Date().toDateString();
                const completionIndex = completionHistory.findIndex(c => 
                    c.taskId === itemKey && 
                    c.isDailyHabit && 
                    new Date(c.completedAt).toDateString() === today
                );
                if (completionIndex !== -1) {
                    completionHistory.splice(completionIndex, 1);
                    saveCompletionHistory();
                }
            }
            
            saveDailyHabitsState();
            renderDailyHabits();
            updateWeeklyProgress();
            updateRecentlyCompleted();
        }

        function removeDailyHabit(habitId) {
            dailyHabits = dailyHabits.filter(h => h.id !== habitId);
            dailyHabitsCompletedToday = dailyHabitsCompletedToday.filter(id => id !== habitId);
            saveDailyHabits();
            saveDailyHabitsState();
            renderDailyHabits();
        }

        function renderDailyHabits() {
            // Get pinned daily tasks from the task library
            const pinnedDailyTasks = tasks.daily.filter(t => t.pinned && !t.completed).map(task => ({
                ...task,
                isPinnedTask: true  // Flag to distinguish from custom habits
            }));
            
            // Combine custom habits + pinned daily tasks
            const allDailyItems = [...dailyHabits, ...pinnedDailyTasks];
            
            if (allDailyItems.length === 0) {
                dailyHabitsGrid.innerHTML = `
                    <div class="daily-habits-empty">
                        Click ＋ to add habits, or pin daily tasks from the task library
                    </div>
                `;
                return;
            }
            
            dailyHabitsGrid.innerHTML = allDailyItems.map(item => {
                const isCompleted = item.isPinnedTask 
                    ? dailyHabitsCompletedToday.includes(`task-${item.id}`)
                    : dailyHabitsCompletedToday.includes(item.id);
                const category = categories.find(c => c.id === item.category);
                const itemKey = item.isPinnedTask ? `task-${item.id}` : item.id;
                
                return `
                    <div class="daily-habit-item ${isCompleted ? 'completed' : ''}">
                        <div class="daily-habit-checkbox" onclick="toggleDailyHabit('${itemKey}', ${item.isPinnedTask || false})">
                            ${isCompleted ? '✓' : ''}
                        </div>
                        <div class="daily-habit-content" onclick="toggleDailyHabit('${itemKey}', ${item.isPinnedTask || false})">
                            <div class="daily-habit-title">${item.title}</div>
                            <div class="daily-habit-category">${category ? category.name : item.category}</div>
                        </div>
                        <button class="daily-habit-remove" onclick="event.stopPropagation(); ${item.isPinnedTask ? `unpinDailyTask(${item.id})` : `removeDailyHabit(${item.id})`}" title="${item.isPinnedTask ? 'Unpin' : 'Remove'}">✕</button>
                    </div>
                `;
            }).join('');
        }

        function unpinDailyTask(taskId) {
            const task = tasks.daily.find(t => t.id === taskId);
            if (task) {
                task.pinned = false;
                saveTasks();
                renderDailyHabits();
                updateComingUp();
            }
        }

        window.toggleDailyHabit = toggleDailyHabit;
        window.removeDailyHabit = removeDailyHabit;
        window.unpinDailyTask = unpinDailyTask;

        function saveDailyHabits() {
            db.collection('planner').doc('dailyHabits').set({
                habits: dailyHabits,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving daily habits:", error);
            });
        }

        function saveDailyHabitsState() {
            db.collection('planner').doc('dailyHabitsState').set({
                completedToday: dailyHabitsCompletedToday,
                lastResetDate: lastHabitResetDate,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving daily habits state:", error);
            });
        }

        function loadDailyHabits() {
            return db.collection('planner').doc('dailyHabits').get()
                .then(doc => {
                    if (doc.exists) {
                        dailyHabits = doc.data().habits || [];
                    }
                })
                .catch(error => {
                    console.error("Error loading daily habits:", error);
                });
        }

        function loadDailyHabitsState() {
            return db.collection('planner').doc('dailyHabitsState').get()
                .then(doc => {
                    if (doc.exists) {
                        dailyHabitsCompletedToday = doc.data().completedToday || [];
                        lastHabitResetDate = doc.data().lastResetDate || null;
                    }
                })
                .catch(error => {
                    console.error("Error loading daily habits state:", error);
                });
        }

        // ========== COMING UP SECTION ==========
        comingUpToggle.addEventListener('click', () => {
            comingUpVisible = !comingUpVisible;
            localStorage.setItem('comingUpVisible', comingUpVisible);
            updateComingUpVisibility();
        });

        function updateComingUpVisibility() {
            const sections = document.querySelectorAll('.frequency-pinned-section');
            sections.forEach(s => s.style.display = comingUpVisible ? 'block' : 'none');
            document.getElementById('dailyHabitsSection').style.display = comingUpVisible ? 'block' : 'none';
            comingUpToggle.textContent = comingUpVisible ? 'Hide' : 'Show';
        }

        function checkAndResetPinnedCompletions() {
            const now = new Date();
            
            // Check weekly reset (Sunday)
            const weekStart = getWeekStartDate(now).toDateString();
            if (lastPinnedResetDates.weekly !== weekStart) {
                pinnedCompletions.weekly = [];
                lastPinnedResetDates.weekly = weekStart;
            }
            
            // Check monthly reset (1st of month)
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            if (lastPinnedResetDates.monthly !== monthKey) {
                pinnedCompletions.monthly = [];
                lastPinnedResetDates.monthly = monthKey;
            }
            
            // Check quarterly reset
            const quarter = Math.floor(now.getMonth() / 3);
            const quarterKey = `${now.getFullYear()}-Q${quarter}`;
            if (lastPinnedResetDates.quarterly !== quarterKey) {
                pinnedCompletions.quarterly = [];
                lastPinnedResetDates.quarterly = quarterKey;
            }
            
            // Check yearly reset
            const yearKey = `${now.getFullYear()}`;
            if (lastPinnedResetDates.yearly !== yearKey) {
                pinnedCompletions.yearly = [];
                lastPinnedResetDates.yearly = yearKey;
            }
            
            savePinnedCompletions();
        }

        function togglePinnedCompletion(frequency, taskId) {
            const key = `${frequency}-${taskId}`;
            const task = tasks[frequency].find(t => t.id === taskId);
            const timesNeeded = (frequency === 'weekly' && task?.timesPerWeek) ? task.timesPerWeek : 1;
            
            // Count how many times this task has been completed this period
            const completionCount = pinnedCompletions[frequency].filter(k => k === key).length;
            
            if (completionCount < timesNeeded) {
                // Add another completion
                pinnedCompletions[frequency].push(key);
                
                // Record in completion history for score
                if (task) {
                    completionHistory.push({
                        id: Date.now(),
                        taskId: taskId,
                        title: task.title,
                        category: task.category,
                        frequency: frequency,
                        completedAt: new Date().toISOString()
                    });
                    saveCompletionHistory();
                }
            } else {
                // Remove one completion (unchecking)
                const indexToRemove = pinnedCompletions[frequency].lastIndexOf(key);
                if (indexToRemove !== -1) {
                    pinnedCompletions[frequency].splice(indexToRemove, 1);
                }
                
                // Remove from completion history (most recent for this task today)
                const today = new Date().toDateString();
                const completionIndex = completionHistory.findIndex(c => 
                    c.taskId === taskId && 
                    c.frequency === frequency &&
                    new Date(c.completedAt).toDateString() === today
                );
                if (completionIndex !== -1) {
                    completionHistory.splice(completionIndex, 1);
                    saveCompletionHistory();
                }
            }
            
            savePinnedCompletions();
            renderFrequencyPinnedTasks();
            updateWeeklyProgress();
            updateRecentlyCompleted();
        }

        function unpinFrequencyTask(frequency, taskId) {
            const task = tasks[frequency].find(t => t.id === taskId);
            if (task) {
                task.pinned = false;
                saveTasks();
                renderFrequencyPinnedTasks();
            }
        }

        window.togglePinnedCompletion = togglePinnedCompletion;
        window.unpinFrequencyTask = unpinFrequencyTask;

        function renderFrequencyPinnedTasks() {
            const frequencies = ['weekly', 'monthly', 'quarterly', 'yearly'];
            const grids = {
                weekly: weeklyPinnedGrid,
                monthly: monthlyPinnedGrid,
                quarterly: quarterlyPinnedGrid,
                yearly: yearlyPinnedGrid
            };
            const counts = {
                weekly: weeklyPinnedCount,
                monthly: monthlyPinnedCount,
                quarterly: quarterlyPinnedCount,
                yearly: yearlyPinnedCount
            };
            
            frequencies.forEach(freq => {
                // Get pinned tasks and sort by priority order
                let pinnedTasks = tasks[freq].filter(t => t.pinned);
                
                // Sort by priority order if exists
                const orderKey = `${freq}PinnedOrder`;
                if (pinnedPriorityOrder[freq] && pinnedPriorityOrder[freq].length > 0) {
                    pinnedTasks.sort((a, b) => {
                        const aIndex = pinnedPriorityOrder[freq].indexOf(a.id);
                        const bIndex = pinnedPriorityOrder[freq].indexOf(b.id);
                        if (aIndex === -1 && bIndex === -1) return 0;
                        if (aIndex === -1) return 1;
                        if (bIndex === -1) return -1;
                        return aIndex - bIndex;
                    });
                }
                
                pinnedTasks = pinnedTasks.slice(0, 15);
                const grid = grids[freq];
                const countEl = counts[freq];
                
                // Calculate total completions needed and done for this frequency
                let totalNeeded = 0;
                let totalDone = 0;
                pinnedTasks.forEach(task => {
                    const key = `${freq}-${task.id}`;
                    const timesNeeded = (freq === 'weekly' && task.timesPerWeek) ? task.timesPerWeek : 1;
                    const completionCount = pinnedCompletions[freq].filter(k => k === key).length;
                    totalNeeded += timesNeeded;
                    totalDone += Math.min(completionCount, timesNeeded);
                });
                
                countEl.textContent = `${totalDone}/${totalNeeded}`;
                
                if (pinnedTasks.length === 0) {
                    grid.innerHTML = `
                        <div class="frequency-pinned-empty">
                            Pin ${freq} tasks from the task library
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = pinnedTasks.map((task, index) => {
                    const key = `${freq}-${task.id}`;
                    const timesNeeded = (freq === 'weekly' && task.timesPerWeek) ? task.timesPerWeek : 1;
                    const completionCount = pinnedCompletions[freq].filter(k => k === key).length;
                    const isFullyCompleted = completionCount >= timesNeeded;
                    const category = categories.find(c => c.id === task.category);
                    
                    // Show remaining badge for multi-completion tasks
                    const remainingBadgeHtml = timesNeeded > 1 ? `
                        <span class="frequency-pinned-remaining ${isFullyCompleted ? 'done' : (completionCount > 0 ? 'partial' : '')}">
                            ${completionCount}/${timesNeeded}
                        </span>
                    ` : '';
                    
                    return `
                        <div class="frequency-pinned-item ${isFullyCompleted ? 'completed' : ''}"
                             draggable="true"
                             data-freq="${freq}"
                             data-task-id="${task.id}"
                             data-index="${index}"
                             ondragstart="handleFreqDragStart(event)"
                             ondragend="handleFreqDragEnd(event)"
                             ondragover="handleFreqDragOver(event)"
                             ondrop="handleFreqDrop(event)"
                             ondragleave="handleFreqDragLeave(event)">
                            <div class="frequency-pinned-drag">⋮⋮</div>
                            <div class="frequency-pinned-priority p${index + 1}">${index + 1}</div>
                            <div class="frequency-pinned-checkbox" onclick="event.stopPropagation(); togglePinnedCompletion('${freq}', ${task.id})">
                                ${isFullyCompleted ? '✓' : (completionCount > 0 ? completionCount : '')}
                            </div>
                            <div class="frequency-pinned-content" onclick="openTaskDetail('${freq}', ${task.id})">
                                <div class="frequency-pinned-task">${task.title}${remainingBadgeHtml}</div>
                                <div class="frequency-pinned-category">${category ? category.name : task.category}</div>
                            </div>
                            <button class="frequency-pinned-remove" onclick="event.stopPropagation(); unpinFrequencyTask('${freq}', ${task.id})" title="Unpin">✕</button>
                        </div>
                    `;
                }).join('');
            });
        }

        // Drag and drop for frequency pinned tasks
        let freqDraggedItem = null;

        function handleFreqDragStart(e) {
            freqDraggedItem = e.target.closest('.frequency-pinned-item');
            freqDraggedItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleFreqDragEnd(e) {
            if (freqDraggedItem) {
                freqDraggedItem.classList.remove('dragging');
            }
            document.querySelectorAll('.frequency-pinned-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            freqDraggedItem = null;
        }

        function handleFreqDragOver(e) {
            e.preventDefault();
            const item = e.target.closest('.frequency-pinned-item');
            if (item && item !== freqDraggedItem) {
                item.classList.add('drag-over');
            }
        }

        function handleFreqDragLeave(e) {
            const item = e.target.closest('.frequency-pinned-item');
            if (item) {
                item.classList.remove('drag-over');
            }
        }

        function handleFreqDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.frequency-pinned-item');
            
            if (!dropTarget || !freqDraggedItem || dropTarget === freqDraggedItem) return;
            
            const freq = freqDraggedItem.dataset.freq;
            const draggedId = parseInt(freqDraggedItem.dataset.taskId);
            const targetId = parseInt(dropTarget.dataset.taskId);
            
            // Get current order or create from current pinned tasks
            if (!pinnedPriorityOrder[freq] || pinnedPriorityOrder[freq].length === 0) {
                pinnedPriorityOrder[freq] = tasks[freq].filter(t => t.pinned).map(t => t.id);
            }
            
            // Reorder
            const order = pinnedPriorityOrder[freq];
            const draggedIndex = order.indexOf(draggedId);
            const targetIndex = order.indexOf(targetId);
            
            if (draggedIndex !== -1) {
                order.splice(draggedIndex, 1);
            }
            
            const newTargetIndex = order.indexOf(targetId);
            order.splice(newTargetIndex, 0, draggedId);
            
            pinnedPriorityOrder[freq] = order;
            savePinnedPriorityOrder();
            renderFrequencyPinnedTasks();
            
            dropTarget.classList.remove('drag-over');
        }

        window.handleFreqDragStart = handleFreqDragStart;
        window.handleFreqDragEnd = handleFreqDragEnd;
        window.handleFreqDragOver = handleFreqDragOver;
        window.handleFreqDragLeave = handleFreqDragLeave;
        window.handleFreqDrop = handleFreqDrop;

        function savePinnedPriorityOrder() {
            db.collection('planner').doc('pinnedPriorityOrder').set({
                order: pinnedPriorityOrder,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving pinned priority order:", error);
            });
        }

        function loadPinnedPriorityOrder() {
            return db.collection('planner').doc('pinnedPriorityOrder').get()
                .then(doc => {
                    if (doc.exists) {
                        pinnedPriorityOrder = doc.data().order || { weekly: [], monthly: [], quarterly: [], yearly: [] };
                    }
                })
                .catch(error => {
                    console.error("Error loading pinned priority order:", error);
                });
        }

        function savePinnedCompletions() {
            db.collection('planner').doc('pinnedCompletions').set({
                completions: pinnedCompletions,
                resetDates: lastPinnedResetDates,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving pinned completions:", error);
            });
        }

        function loadPinnedCompletions() {
            return db.collection('planner').doc('pinnedCompletions').get()
                .then(doc => {
                    if (doc.exists) {
                        pinnedCompletions = doc.data().completions || { weekly: [], monthly: [], quarterly: [], yearly: [] };
                        lastPinnedResetDates = doc.data().resetDates || { weekly: null, monthly: null, quarterly: null, yearly: null };
                    }
                })
                .catch(error => {
                    console.error("Error loading pinned completions:", error);
                });
        }

        function updateComingUp() {
            updateComingUpVisibility();
            renderDailyHabits();
            checkAndResetPinnedCompletions();
            renderFrequencyPinnedTasks();
        }

        // ========== DRAG AND DROP FOR PRIORITY ==========
        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = e.target.closest('.coming-up-item');
            draggedItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedItem.innerHTML);
        }

        function handleDragEnd(e) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            document.querySelectorAll('.coming-up-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const item = e.target.closest('.coming-up-item');
            if (item && item !== draggedItem) {
                item.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const item = e.target.closest('.coming-up-item');
            if (item) {
                item.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.coming-up-item');
            
            if (dropTarget && draggedItem && dropTarget !== draggedItem) {
                // Get all items and their IDs
                const items = Array.from(comingUpGrid.querySelectorAll('.coming-up-item'));
                const draggedId = draggedItem.dataset.taskId;
                const dropId = dropTarget.dataset.taskId;
                
                // Build new priority order
                const currentOrder = items.map(item => item.dataset.taskId);
                const draggedIndex = currentOrder.indexOf(draggedId);
                const dropIndex = currentOrder.indexOf(dropId);
                
                // Remove dragged item and insert at new position
                currentOrder.splice(draggedIndex, 1);
                currentOrder.splice(dropIndex, 0, draggedId);
                
                // Save to state and Firebase
                priorityOrder = currentOrder;
                savePriorityOrder();
                
                // Re-render
                updateComingUp();
            }
            
            dropTarget?.classList.remove('drag-over');
        }

        function savePriorityOrder() {
            db.collection('planner').doc('priorityOrder').set({
                order: priorityOrder,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving priority order:", error);
            });
        }

        function loadPriorityOrder() {
            return db.collection('planner').doc('priorityOrder').get()
                .then(doc => {
                    if (doc.exists) {
                        priorityOrder = doc.data().order || [];
                    }
                })
                .catch(error => {
                    console.error("Error loading priority order:", error);
                });
        }

        // Listen for priority order updates
        function listenForPriorityUpdates() {
            db.collection('planner').doc('priorityOrder').onSnapshot(doc => {
                if (doc.exists) {
                    priorityOrder = doc.data().order || [];
                    updateComingUp();
                }
            }, error => {
                console.error("Error listening to priority updates:", error);
            });
        }

        window.handleDragStart = handleDragStart;
        window.handleDragEnd = handleDragEnd;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;

        // ========== TO-DO LIST (Todoist-style) ==========
        let selectedTodoId = null;
        let addingTaskInSection = null;
        
        // Team members configuration with emails
        const TEAM_MEMBERS = {
            '': { name: 'Unassigned', avatar: '👤', avatarClass: '', email: '' },
            'Chad': { name: 'Me (Chad H.)', avatar: 'CH', avatarClass: 'chad', email: 'hillardc@gmail.com' },
            'SLOE': { name: 'SLOE', avatar: 'SJ', avatarClass: 'sloe', email: 'sloejackmanagement@gmail.com' }
        };
        
        const todoDetailPanel = document.getElementById('todoDetailPanel');
        const todoDetailTitle = document.getElementById('todoDetailTitle');
        const todoDetailDescription = document.getElementById('todoDetailDescription');
        const todoDetailSection = document.getElementById('todoDetailSection');
        const todoDetailDate = document.getElementById('todoDetailDate');
        const todoDetailClose = document.getElementById('todoDetailClose');
        const todoDetailDelete = document.getElementById('todoDetailDelete');
        const todoDetailCompleteBtn = document.getElementById('todoDetailCompleteBtn');
        const todoPrioritySelector = document.getElementById('todoPrioritySelector');
        const todoSubtasksList = document.getElementById('todoSubtasksList');
        const addSubtaskBtn = document.getElementById('addSubtaskBtn');
        const todoAssigneeBtn = document.getElementById('todoAssigneeBtn');
        const todoAssigneeDropdown = document.getElementById('todoAssigneeDropdown');
        const todoAssigneeAvatar = document.getElementById('todoAssigneeAvatar');
        const todoAssigneeName = document.getElementById('todoAssigneeName');
        const todoAssigneeList = document.getElementById('todoAssigneeList');
        const todoDetailNotify = document.getElementById('todoDetailNotify');
        const headerTodoBadge = document.getElementById('headerTodoBadge');
        
        // Render Priority To-Dos on homepage (items with priority 1, 2, or 3)
        function renderPriorityTodos() {
            const section = document.getElementById('priorityTodosSection');
            const list = document.getElementById('priorityTodosList');
            
            if (!section || !list) return;
            
            // Get incomplete items with priority 1, 2, or 3
            const priorityItems = todoData.items
                .filter(item => !item.completed && item.priority && item.priority <= 3)
                .sort((a, b) => (a.priority || 4) - (b.priority || 4));
            
            // Hide section if no priority items
            if (priorityItems.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            const priorityLabels = { 1: 'P1', 2: 'P2', 3: 'P3' };
            
            list.innerHTML = priorityItems.map(item => {
                const sectionName = todoData.sections.find(s => s.id === item.sectionId)?.name || '';
                return `
                    <div class="priority-todo-item ${item.completed ? 'completed' : ''}" 
                         data-id="${item.id}"
                         onclick="openPriorityTodoDetail(${item.id})">
                        <div class="priority-todo-checkbox p${item.priority}" 
                             onclick="event.stopPropagation(); togglePriorityTodo(${item.id})">
                            ${item.completed ? '✓' : ''}
                        </div>
                        <div class="priority-todo-content">
                            <div class="priority-todo-title">${item.title}</div>
                            <div class="priority-todo-meta">
                                <span class="priority-todo-badge p${item.priority}">${priorityLabels[item.priority]}</span>
                                <span>${sectionName}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function togglePriorityTodo(itemId) {
            const item = todoData.items.find(i => i.id === itemId);
            if (item) {
                item.completed = !item.completed;
                saveTodoData();
                renderPriorityTodos();
                renderTodoList();
            }
        }
        
        function openPriorityTodoDetail(itemId) {
            // Switch to To-Do view and open the item detail
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.view-tab[data-view="todo"]').classList.add('active');
            document.querySelectorAll('.list-view').forEach(v => v.classList.remove('active'));
            document.getElementById('todoView').classList.add('active');
            
            // Open the detail panel for this item
            openTodoDetail(itemId);
        }
        
        window.togglePriorityTodo = togglePriorityTodo;
        window.openPriorityTodoDetail = openPriorityTodoDetail;
        
        function renderTodoList() {
            if (!todoData.sections || todoData.sections.length === 0) {
                todoData.sections = [{ id: 1, name: 'TO-DO', collapsed: false }];
            }
            
            // Update header badge
            const incompleteTotal = todoData.items.filter(i => !i.completed).length;
            headerTodoBadge.textContent = incompleteTotal;
            headerTodoBadge.style.display = incompleteTotal > 0 ? 'inline-block' : 'none';
            
            let html = '';
            
            todoData.sections.forEach(section => {
                const sectionItems = todoData.items.filter(item => item.sectionId === section.id);
                const incompleteCount = sectionItems.filter(i => !i.completed).length;
                
                html += `
                    <div class="todo-section ${section.collapsed ? 'collapsed' : ''}" data-section-id="${section.id}">
                        <div class="todo-section-header">
                            <span class="todo-section-toggle" onclick="toggleTodoSection(${section.id})">▼</span>
                            <span class="todo-section-name" onclick="toggleTodoSection(${section.id})">${section.name}</span>
                            <span class="todo-section-count">${incompleteCount}</span>
                            <div class="todo-section-actions">
                                <button class="todo-section-action" onclick="event.stopPropagation(); startAddingTask(${section.id})" title="Add task">+</button>
                                <button class="todo-section-action" onclick="event.stopPropagation(); deleteSection(${section.id})" title="Delete section">🗑️</button>
                            </div>
                        </div>
                        <div class="todo-section-items">
                            ${sectionItems.filter(i => !i.completed).map(item => renderTodoItem(item)).join('')}
                            
                            <!-- Inline Add Task -->
                            <div class="todo-add-inline ${addingTaskInSection === section.id ? 'active' : ''}" id="addInline-${section.id}">
                                <div class="todo-add-checkbox-placeholder"></div>
                                <div class="todo-add-input-wrapper">
                                    <input type="text" class="todo-add-input" id="addInput-${section.id}" placeholder="Task name" onkeydown="handleAddInputKeydown(event, ${section.id})">
                                    <div class="todo-add-toolbar">
                                        <button class="todo-add-toolbar-btn" onclick="showDatePicker(${section.id})">📅 Due date</button>
                                        <button class="todo-add-toolbar-btn" onclick="cyclePriority(${section.id})">🚩 Priority</button>
                                        <div class="todo-add-actions">
                                            <button class="todo-add-cancel" onclick="cancelAddingTask()">Cancel</button>
                                            <button class="todo-add-submit" onclick="submitInlineTask(${section.id})">Add task</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add Task Button -->
                            <button class="todo-add-btn ${addingTaskInSection === section.id ? 'hidden' : ''}" onclick="startAddingTask(${section.id})">
                                <span class="todo-add-icon">+</span>
                                <span>Add task</span>
                            </button>
                            
                            <!-- Completed items -->
                            ${sectionItems.filter(i => i.completed).length > 0 ? `
                                <div class="todo-completed-toggle" onclick="toggleCompletedVisibility(${section.id})">
                                    <span>✓ ${sectionItems.filter(i => i.completed).length} completed</span>
                                </div>
                                <div class="todo-completed-items" id="completed-${section.id}" style="display: none;">
                                    ${sectionItems.filter(i => i.completed).map(item => renderTodoItem(item)).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            // Add section button
            html += `
                <button class="todo-add-section-btn" onclick="openAddSectionModal()">
                    <span>+</span>
                    <span>Add section</span>
                </button>
            `;
            
            todoSections.innerHTML = html;
            
            // Focus on input if adding task
            if (addingTaskInSection) {
                const input = document.getElementById(`addInput-${addingTaskInSection}`);
                if (input) input.focus();
            }
            
            // Update priority todos on homepage
            renderPriorityTodos();
        }
        
        function renderTodoItem(item) {
            const priorityClass = item.priority ? `priority-${item.priority}` : '';
            const dateHtml = item.dueDate ? `
                <div class="todo-item-date ${getDateClass(item.dueDate)}">
                    📅 ${formatTodoDate(item.dueDate)}
                </div>
            ` : '';
            
            const labelsHtml = item.labels && item.labels.length > 0 ? `
                <div class="todo-item-labels">
                    ${item.labels.map(l => `<span class="todo-item-label">${l}</span>`).join('')}
                </div>
            ` : '';
            
            // Assignee avatar
            const assignee = item.assignee || '';
            const member = TEAM_MEMBERS[assignee] || TEAM_MEMBERS[''];
            const assigneeHtml = assignee ? `
                <div class="todo-item-assignee-avatar ${member.avatarClass}" title="${member.name}">
                    ${member.avatar}
                </div>
            ` : '';
            
            return `
                <div class="todo-item ${item.completed ? 'completed' : ''} ${priorityClass} ${selectedTodoId === item.id ? 'selected' : ''}" 
                     data-item-id="${item.id}"
                     onclick="selectTodoItem(${item.id})">
                    <div class="todo-item-checkbox" onclick="event.stopPropagation(); toggleTodoItem(${item.id})">
                        ${item.completed ? '✓' : ''}
                    </div>
                    <div class="todo-item-content">
                        <div class="todo-item-title">${item.title}</div>
                        <div class="todo-item-meta">
                            ${dateHtml}
                            ${labelsHtml}
                        </div>
                    </div>
                    ${assigneeHtml}
                    <div class="todo-item-actions">
                        <button class="todo-item-action" onclick="event.stopPropagation(); selectTodoItem(${item.id})" title="Edit">✏️</button>
                        <button class="todo-item-action" onclick="event.stopPropagation(); deleteTodoItem(${item.id})" title="Delete">🗑️</button>
                    </div>
                </div>
            `;
        }
        
        function getDateClass(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            
            if (date < today) return 'overdue';
            if (date.getTime() === today.getTime()) return 'today';
            return '';
        }
        
        function formatTodoDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            date.setHours(0, 0, 0, 0);
            
            if (date.getTime() === today.getTime()) return 'Today';
            if (date.getTime() === tomorrow.getTime()) return 'Tomorrow';
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function toggleTodoSection(sectionId) {
            const section = todoData.sections.find(s => s.id === sectionId);
            if (section) {
                section.collapsed = !section.collapsed;
                saveTodoData();
                renderTodoList();
            }
        }
        
        function toggleCompletedVisibility(sectionId) {
            const el = document.getElementById(`completed-${sectionId}`);
            if (el) {
                el.style.display = el.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function toggleTodoItem(itemId) {
            const item = todoData.items.find(i => i.id === itemId);
            if (item) {
                item.completed = !item.completed;
                item.completedAt = item.completed ? new Date().toISOString() : null;
                saveTodoData();
                renderTodoList();
                
                // Update detail panel if open
                if (selectedTodoId === itemId) {
                    updateDetailPanel(item);
                }
            }
        }
        
        function deleteTodoItem(itemId) {
            todoData.items = todoData.items.filter(i => i.id !== itemId);
            saveTodoData();
            
            if (selectedTodoId === itemId) {
                closeDetailPanel();
            }
            
            renderTodoList();
        }
        
        function deleteSection(sectionId) {
            if (todoData.sections.length <= 1) {
                alert('You need at least one section.');
                return;
            }
            
            if (confirm('Delete this section and all its tasks?')) {
                todoData.items = todoData.items.filter(i => i.sectionId !== sectionId);
                todoData.sections = todoData.sections.filter(s => s.id !== sectionId);
                saveTodoData();
                renderTodoList();
            }
        }
        
        // Inline task adding
        function startAddingTask(sectionId) {
            addingTaskInSection = sectionId;
            renderTodoList();
        }
        
        function cancelAddingTask() {
            addingTaskInSection = null;
            renderTodoList();
        }
        
        function handleAddInputKeydown(event, sectionId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitInlineTask(sectionId);
            } else if (event.key === 'Escape') {
                cancelAddingTask();
            }
        }
        
        function submitInlineTask(sectionId) {
            const input = document.getElementById(`addInput-${sectionId}`);
            const title = input?.value.trim();
            
            if (!title) return;
            
            const newId = Math.max(...todoData.items.map(i => i.id), 0) + 1;
            todoData.items.push({
                id: newId,
                title: title,
                sectionId: sectionId,
                priority: 4,
                completed: false,
                createdAt: new Date().toISOString()
            });
            
            saveTodoData();
            
            // Keep adding mode active for quick entry
            renderTodoList();
        }
        
        // Task detail side panel
        function selectTodoItem(itemId) {
            const item = todoData.items.find(i => i.id === itemId);
            if (!item) return;
            
            selectedTodoId = itemId;
            updateDetailPanel(item);
            todoDetailPanel.classList.add('open');
            renderTodoList(); // Update selection highlight
        }
        
        function updateDetailPanel(item) {
            todoDetailTitle.value = item.title;
            todoDetailDescription.value = item.description || '';
            todoDetailDate.value = item.dueDate || '';
            
            // Update section dropdown
            todoDetailSection.innerHTML = todoData.sections.map(s => 
                `<option value="${s.id}" ${s.id === item.sectionId ? 'selected' : ''}>${s.name}</option>`
            ).join('');
            
            // Update assignee
            const assignee = item.assignee || '';
            const member = TEAM_MEMBERS[assignee] || TEAM_MEMBERS[''];
            todoAssigneeAvatar.textContent = member.avatar;
            todoAssigneeAvatar.className = `todo-assignee-avatar ${member.avatarClass}`;
            todoAssigneeName.textContent = member.name;
            
            // Update assignee dropdown selection
            todoAssigneeList.querySelectorAll('.todo-assignee-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.assignee === assignee);
                opt.querySelector('.todo-assignee-option-check').textContent = opt.dataset.assignee === assignee ? '✓' : '';
            });
            
            // Update priority buttons
            const priority = item.priority || 4;
            todoPrioritySelector.querySelectorAll('.todo-priority-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.priority) === priority);
            });
            
            // Update checkbox visual
            const checkbox = document.querySelector('.todo-detail-checkbox');
            if (checkbox) {
                checkbox.style.background = item.completed ? '#22c55e' : 'transparent';
                checkbox.style.borderColor = item.completed ? '#22c55e' : 'var(--border-color)';
            }
            
            // Render subtasks
            renderSubtasks(item);
        }
        
        function renderSubtasks(item) {
            if (!item.subtasks || item.subtasks.length === 0) {
                todoSubtasksList.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem;">No sub-tasks yet</p>';
                return;
            }
            
            todoSubtasksList.innerHTML = item.subtasks.map((sub, idx) => `
                <div class="todo-subtask-item ${sub.completed ? 'completed' : ''}">
                    <div class="todo-subtask-checkbox" onclick="toggleSubtask(${item.id}, ${idx})">
                        ${sub.completed ? '✓' : ''}
                    </div>
                    <span class="todo-subtask-title">${sub.title}</span>
                    <button class="todo-subtask-delete" onclick="deleteSubtask(${item.id}, ${idx})">✕</button>
                </div>
            `).join('');
        }
        
        function closeDetailPanel() {
            selectedTodoId = null;
            todoDetailPanel.classList.remove('open');
            renderTodoList();
        }
        
        function saveDetailChanges() {
            if (!selectedTodoId) return;
            
            const item = todoData.items.find(i => i.id === selectedTodoId);
            if (item) {
                item.title = todoDetailTitle.value.trim() || item.title;
                item.description = todoDetailDescription.value.trim();
                item.dueDate = todoDetailDate.value || null;
                item.sectionId = parseInt(todoDetailSection.value);
                
                saveTodoData();
                renderTodoList();
            }
        }
        
        // Event listeners for detail panel
        todoDetailClose.addEventListener('click', closeDetailPanel);
        
        todoDetailDelete.addEventListener('click', () => {
            if (selectedTodoId) {
                deleteTodoItem(selectedTodoId);
            }
        });
        
        todoDetailCompleteBtn.addEventListener('click', () => {
            if (selectedTodoId) {
                toggleTodoItem(selectedTodoId);
            }
        });
        
        todoDetailTitle.addEventListener('blur', saveDetailChanges);
        todoDetailDescription.addEventListener('blur', saveDetailChanges);
        todoDetailDate.addEventListener('change', saveDetailChanges);
        todoDetailSection.addEventListener('change', saveDetailChanges);
        
        // Assignee dropdown functionality
        todoAssigneeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            todoAssigneeDropdown.classList.toggle('open');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!todoAssigneeDropdown.contains(e.target) && !todoAssigneeBtn.contains(e.target)) {
                todoAssigneeDropdown.classList.remove('open');
            }
        });
        
        // Handle assignee selection
        todoAssigneeList.addEventListener('click', (e) => {
            const option = e.target.closest('.todo-assignee-option');
            if (option && selectedTodoId) {
                const assignee = option.dataset.assignee;
                const item = todoData.items.find(i => i.id === selectedTodoId);
                if (item) {
                    item.assignee = assignee;
                    saveTodoData();
                    updateDetailPanel(item);
                    renderTodoList();
                }
                todoAssigneeDropdown.classList.remove('open');
            }
        });
        
        // Send notification email to assignee
        todoDetailNotify.addEventListener('click', async () => {
            if (!selectedTodoId) return;
            
            const item = todoData.items.find(i => i.id === selectedTodoId);
            if (!item) return;
            
            const assignee = item.assignee || '';
            const member = TEAM_MEMBERS[assignee];
            
            if (!member || !member.email) {
                alert('Please assign this task to someone before sending a notification.');
                return;
            }
            
            try {
                todoDetailNotify.textContent = '⏳';
                await sendTodoNotificationEmail(item, member);
                todoDetailNotify.textContent = '✓';
                setTimeout(() => { todoDetailNotify.textContent = '📧'; }, 2000);
            } catch (error) {
                console.error('Failed to send notification:', error);
                todoDetailNotify.textContent = '❌';
                setTimeout(() => { todoDetailNotify.textContent = '📧'; }, 2000);
                alert('Failed to send notification. Please try again.');
            }
        });
        
        // Send styled email notification for a todo task
        async function sendTodoNotificationEmail(item, member) {
            const priorityLabels = { 1: 'Urgent', 2: 'High', 3: 'Medium', 4: 'Low' };
            const priorityColors = { 1: '#ef4444', 2: '#f97316', 3: '#3b82f6', 4: '#6b7280' };
            const priority = item.priority || 4;
            
            const section = todoData.sections.find(s => s.id === item.sectionId);
            const sectionName = section ? section.name : 'To-Do';
            
            const dueDateStr = item.dueDate ? formatTodoDate(item.dueDate) : 'No due date';
            
            const emailHtml = `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 32px; border-radius: 16px 16px 0 0; text-align: center;">
                        <div style="display: inline-block; background: linear-gradient(135deg, #f97316, #ea580c); padding: 12px 20px; border-radius: 12px; margin-bottom: 16px;">
                            <span style="color: white; font-weight: 700; font-size: 18px;">SJ</span>
                        </div>
                        <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 700;">Task Assigned to You</h1>
                        <p style="color: #9ca3af; margin: 8px 0 0 0; font-size: 14px;">SLOE JACK Subscriber Content Planner</p>
                    </div>
                    
                    <!-- Task Card -->
                    <div style="background: #ffffff; padding: 24px; border-left: 4px solid ${priorityColors[priority]};">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <span style="background: ${priorityColors[priority]}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${priorityLabels[priority]} Priority</span>
                            <span style="background: #f3f4f6; color: #6b7280; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${sectionName}</span>
                        </div>
                        <h2 style="margin: 0 0 12px 0; font-size: 20px; color: #1f2937;">${item.title}</h2>
                        ${item.description ? `<p style="color: #6b7280; margin: 0 0 16px 0; font-size: 14px; line-height: 1.5;">${item.description}</p>` : ''}
                        <div style="display: flex; gap: 24px; color: #6b7280; font-size: 13px;">
                            <div>📅 <strong>Due:</strong> ${dueDateStr}</div>
                            <div>👤 <strong>Assigned to:</strong> ${member.name}</div>
                        </div>
                    </div>
                    
                    ${item.subtasks && item.subtasks.length > 0 ? `
                    <!-- Subtasks -->
                    <div style="background: #f9fafb; padding: 20px 24px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #374151;">Sub-tasks (${item.subtasks.filter(s => s.completed).length}/${item.subtasks.length} completed)</h3>
                        ${item.subtasks.map(sub => `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: ${sub.completed ? '#22c55e' : '#d1d5db'};">${sub.completed ? '✓' : '○'}</span>
                                <span style="color: ${sub.completed ? '#9ca3af' : '#374151'}; ${sub.completed ? 'text-decoration: line-through;' : ''}">${sub.title}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- Footer -->
                    <div style="background: #1f2937; padding: 24px; border-radius: 0 0 16px 16px; text-align: center;">
                        <p style="color: #9ca3af; margin: 0; font-size: 13px;">
                            📅 ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                        </p>
                        <p style="color: #6b7280; margin: 12px 0 0 0; font-size: 12px;">
                            Keep up the great work! 🚀
                        </p>
                    </div>
                </div>
            `;
            
            const templateParams = {
                to_email: member.email,
                subject: `📋 Task Assigned: ${item.title}`,
                message_html: emailHtml
            };
            
            return emailjs.send(
                EMAILJS_CONFIG.serviceId,
                EMAILJS_CONFIG.templateId,
                templateParams,
                EMAILJS_CONFIG.publicKey
            );
        }
        
        // Priority selector
        todoPrioritySelector.addEventListener('click', (e) => {
            const btn = e.target.closest('.todo-priority-btn');
            if (btn && selectedTodoId) {
                const priority = parseInt(btn.dataset.priority);
                const item = todoData.items.find(i => i.id === selectedTodoId);
                if (item) {
                    item.priority = priority;
                    saveTodoData();
                    updateDetailPanel(item);
                    renderTodoList();
                }
            }
        });
        
        // Subtask functionality
        addSubtaskBtn.addEventListener('click', () => {
            if (!selectedTodoId) return;
            
            const title = prompt('Sub-task name:');
            if (!title?.trim()) return;
            
            const item = todoData.items.find(i => i.id === selectedTodoId);
            if (item) {
                if (!item.subtasks) item.subtasks = [];
                item.subtasks.push({ title: title.trim(), completed: false });
                saveTodoData();
                renderSubtasks(item);
            }
        });
        
        function toggleSubtask(itemId, subtaskIndex) {
            const item = todoData.items.find(i => i.id === itemId);
            if (item && item.subtasks && item.subtasks[subtaskIndex]) {
                item.subtasks[subtaskIndex].completed = !item.subtasks[subtaskIndex].completed;
                saveTodoData();
                renderSubtasks(item);
            }
        }
        
        function deleteSubtask(itemId, subtaskIndex) {
            const item = todoData.items.find(i => i.id === itemId);
            if (item && item.subtasks) {
                item.subtasks.splice(subtaskIndex, 1);
                saveTodoData();
                renderSubtasks(item);
            }
        }
        
        window.toggleSubtask = toggleSubtask;
        window.deleteSubtask = deleteSubtask;
        
        function openAddSectionModal() {
            newSectionName.value = '';
            addSectionModal.classList.add('open');
            newSectionName.focus();
        }
        
        function saveNewSection() {
            const name = newSectionName.value.trim();
            if (!name) {
                newSectionName.focus();
                return;
            }
            
            const newId = Math.max(...todoData.sections.map(s => s.id), 0) + 1;
            todoData.sections.push({
                id: newId,
                name: name,
                collapsed: false
            });
            
            saveTodoData();
            renderTodoList();
            addSectionModal.classList.remove('open');
        }
        
        // Event listeners
        closeAddSectionModal.addEventListener('click', () => addSectionModal.classList.remove('open'));
        cancelAddSection.addEventListener('click', () => addSectionModal.classList.remove('open'));
        saveAddSection.addEventListener('click', saveNewSection);
        
        // Save/load todo data
        function saveTodoData() {
            db.collection('planner').doc('todoList').set({
                sections: todoData.sections,
                items: todoData.items,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving todo data:", error);
            });
        }
        
        function loadTodoData() {
            return db.collection('planner').doc('todoList').get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        todoData.sections = data.sections || [
                            { id: 1, name: 'TO-DO', collapsed: false },
                            { id: 2, name: 'Chad', collapsed: false }
                        ];
                        todoData.items = data.items || [];
                        
                        // Ensure Chad section exists for existing users
                        if (!todoData.sections.find(s => s.name === 'Chad')) {
                            const maxId = Math.max(...todoData.sections.map(s => s.id), 0);
                            todoData.sections.push({ id: maxId + 1, name: 'Chad', collapsed: false });
                            saveTodoData();
                        }
                    }
                })
                .catch(error => {
                    console.error("Error loading todo data:", error);
                });
        }
        
        window.toggleTodoSection = toggleTodoSection;
        window.toggleTodoItem = toggleTodoItem;
        window.deleteTodoItem = deleteTodoItem;
        window.selectTodoItem = selectTodoItem;
        window.startAddingTask = startAddingTask;
        window.cancelAddingTask = cancelAddingTask;
        window.submitInlineTask = submitInlineTask;
        window.handleAddInputKeydown = handleAddInputKeydown;
        window.deleteSection = deleteSection;
        window.openAddSectionModal = openAddSectionModal;
        window.toggleCompletedVisibility = toggleCompletedVisibility;

        // ========== RECENTLY COMPLETED ==========
        recentlyCompletedToggle.addEventListener('click', () => {
            recentlyCompletedVisible = !recentlyCompletedVisible;
            localStorage.setItem('recentlyCompletedVisible', recentlyCompletedVisible);
            updateRecentlyCompletedVisibility();
        });

        recentlyCompletedFilter.addEventListener('change', () => {
            updateRecentlyCompleted();
        });

        function updateRecentlyCompletedVisibility() {
            recentlyCompletedList.style.display = recentlyCompletedVisible ? 'flex' : 'none';
            recentlyCompletedStats.style.display = recentlyCompletedVisible ? 'flex' : 'none';
            recentlyCompletedToggle.textContent = recentlyCompletedVisible ? 'Hide' : 'Show';
        }

        function getFilteredCompletions() {
            const now = new Date();
            const filter = recentlyCompletedFilter.value;
            
            return completionHistory.filter(item => {
                const completedDate = new Date(item.completedAt);
                
                switch(filter) {
                    case 'week':
                        // This week (Sunday to Saturday)
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        startOfWeek.setHours(0, 0, 0, 0);
                        return completedDate >= startOfWeek;
                    
                    case 'lastweek':
                        // Last week
                        const lastWeekStart = new Date(now);
                        lastWeekStart.setDate(now.getDate() - now.getDay() - 7);
                        lastWeekStart.setHours(0, 0, 0, 0);
                        const lastWeekEnd = new Date(now);
                        lastWeekEnd.setDate(now.getDate() - now.getDay());
                        lastWeekEnd.setHours(0, 0, 0, 0);
                        return completedDate >= lastWeekStart && completedDate < lastWeekEnd;
                    
                    case 'month':
                        // This month
                        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                        return completedDate >= startOfMonth;
                    
                    case 'all':
                    default:
                        return true;
                }
            }).sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
        }

        function updateRecentlyCompleted() {
            updateRecentlyCompletedVisibility();
            
            const filtered = getFilteredCompletions();
            
            // Calculate stats
            const stats = {
                total: filtered.length,
                daily: filtered.filter(i => i.frequency === 'daily').length,
                weekly: filtered.filter(i => i.frequency === 'weekly').length,
                monthly: filtered.filter(i => i.frequency === 'monthly').length,
                quarterly: filtered.filter(i => i.frequency === 'quarterly').length
            };
            
            recentlyCompletedStats.innerHTML = `
                <div class="rc-stat">
                    <div class="rc-stat-icon total">✅</div>
                    <div class="rc-stat-info">
                        <div class="rc-stat-value">${stats.total}</div>
                        <div class="rc-stat-label">Total</div>
                    </div>
                </div>
                <div class="rc-stat">
                    <div class="rc-stat-icon daily">☀️</div>
                    <div class="rc-stat-info">
                        <div class="rc-stat-value">${stats.daily}</div>
                        <div class="rc-stat-label">Daily</div>
                    </div>
                </div>
                <div class="rc-stat">
                    <div class="rc-stat-icon weekly">📆</div>
                    <div class="rc-stat-info">
                        <div class="rc-stat-value">${stats.weekly}</div>
                        <div class="rc-stat-label">Weekly</div>
                    </div>
                </div>
                <div class="rc-stat">
                    <div class="rc-stat-icon monthly">🗓️</div>
                    <div class="rc-stat-info">
                        <div class="rc-stat-value">${stats.monthly}</div>
                        <div class="rc-stat-label">Monthly</div>
                    </div>
                </div>
            `;
            
            if (filtered.length === 0) {
                recentlyCompletedList.innerHTML = `
                    <div class="rc-empty">
                        <div class="rc-empty-icon">📋</div>
                        <p>No completed tasks in this time period.<br>Check off tasks to track your progress!</p>
                    </div>
                `;
                return;
            }
            
            recentlyCompletedList.innerHTML = filtered.slice(0, 20).map(item => {
                const completedDate = new Date(item.completedAt);
                const dateStr = formatCompletedDate(completedDate);
                
                return `
                    <div class="rc-item">
                        <div class="rc-item-check">✓</div>
                        <div class="rc-item-content">
                            <div class="rc-item-title">${item.title}</div>
                            <div class="rc-item-meta">
                                <span class="notification-tag ${item.frequency}">${item.frequency}</span>
                                <span class="notification-tag ${item.category}">${item.category}</span>
                            </div>
                        </div>
                        <div class="rc-item-date">${dateStr}</div>
                        <button class="rc-item-delete" onclick="deleteCompletedItem(${item.id})" title="Remove">🗑️</button>
                    </div>
                `;
            }).join('');
        }

        function formatCompletedDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            // Format time as 12-hour format
            const timeStr = date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            if (days === 0) {
                return `Today, ${timeStr}`;
            } else if (days === 1) {
                return `Yesterday, ${timeStr}`;
            } else if (days < 7) {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                return `${dayName}, ${timeStr}`;
            } else {
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return `${dateStr}, ${timeStr}`;
            }
        }

        function repeatTask(frequency, title, category) {
            // Reset the task's completed status so it can be done again
            const task = tasks[frequency].find(t => t.title === title);
            if (task) {
                task.completed = false;
                saveTasks();
                renderAllTaskLists();
                updateStats();
            }
        }

        function deleteCompletedItem(id) {
            completionHistory = completionHistory.filter(item => item.id !== id);
            saveCompletionHistory();
            updateRecentlyCompleted();
            updateWeeklyProgress();
        }

        window.deleteCompletedItem = deleteCompletedItem;

        function saveCompletionHistory() {
            db.collection('planner').doc('completionHistory').set({
                history: completionHistory,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving completion history:", error);
            });
        }

        function loadCompletionHistory() {
            return db.collection('planner').doc('completionHistory').get()
                .then(doc => {
                    if (doc.exists) {
                        completionHistory = doc.data().history || [];
                    }
                })
                .catch(error => {
                    console.error("Error loading completion history:", error);
                });
        }

        function listenForCompletionHistoryUpdates() {
            db.collection('planner').doc('completionHistory').onSnapshot(doc => {
                if (doc.exists) {
                    completionHistory = doc.data().history || [];
                    updateRecentlyCompleted();
                }
            }, error => {
                console.error("Error listening to completion history updates:", error);
            });
        }

        window.repeatTask = repeatTask;

        // ========== FIREBASE SAVE/LOAD ==========
        function saveTasks() {
            // Save to Firebase
            db.collection('planner').doc('tasks').set({
                daily: tasks.daily,
                weekly: tasks.weekly,
                monthly: tasks.monthly,
                quarterly: tasks.quarterly,
                yearly: tasks.yearly,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving to Firebase:", error);
            });
        }

        function loadTasks() {
            return db.collection('planner').doc('tasks').get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        tasks = {
                            daily: data.daily || defaultTasks.daily,
                            weekly: data.weekly || defaultTasks.weekly,
                            monthly: data.monthly || defaultTasks.monthly,
                            quarterly: data.quarterly || defaultTasks.quarterly,
                            yearly: data.yearly || defaultTasks.yearly
                        };
                    } else {
                        // First time - save default tasks to Firebase
                        tasks = JSON.parse(JSON.stringify(defaultTasks));
                        saveTasks();
                    }
                })
                .catch(error => {
                    console.error("Error loading from Firebase:", error);
                    tasks = JSON.parse(JSON.stringify(defaultTasks));
                });
        }

        // Listen for real-time updates
        function listenForUpdates() {
            db.collection('planner').doc('tasks').onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    tasks = {
                        daily: data.daily || [],
                        weekly: data.weekly || [],
                        monthly: data.monthly || [],
                        quarterly: data.quarterly || [],
                        yearly: data.yearly || []
                    };
                    renderAllTaskLists();
                    renderDailyHabits();
                    renderFrequencyPinnedTasks();
                    updateStats();
                    if (currentView === 'calendar') {
                        renderCalendar();
                    }
                }
            }, error => {
                console.error("Error listening to updates:", error);
            });
        }

        // ========== RENDER ==========
        function renderCurrentView() {
            renderCalendar();
            renderAllTaskLists();
        }

        function renderAllTaskLists() {
            ['daily', 'weekly', 'monthly', 'quarterly', 'yearly'].forEach(freq => {
                renderTaskList(freq);
            });
        }

        // ========== ANALYTICS ==========
        let analyticsData = {
            currentCount: 1971,
            history: [],
            goals: [
                { id: 1, label: '1 Week', target: 100, deadline: '1 week', icon: '🎯' },
                { id: 2, label: '1 Month', target: 500, deadline: '1 month', icon: '📅' },
                { id: 3, label: '6 Months', target: 6000, deadline: '6 months', icon: '🚀' },
                { id: 4, label: '1 Year', target: 12000, deadline: '1 year', icon: '⭐' },
                { id: 5, label: '2 Years', target: 26000, deadline: '2 years', icon: '💎' },
                { id: 6, label: '3 Years', target: 52000, deadline: '3 years', icon: '👑' }
            ],
            startDate: '2026-01-07',
            startCount: 1971
        };

        // ========== PAID SUBSCRIBERS ==========
        let paidSubscriberData = {
            tier1: 0,  // $0.99/month
            tier2: 0,  // $4.99/month
            tier3: 0,  // $9.99/month
            history: [],
            startDate: '2026-01-12',
            startCount: 0
        };

        const paidSubscriberGoals = [
            { id: 1, label: '1 Week', targetSubs: 20, targetRevenue: 200, deadline: '1 week', icon: '🎯' },
            { id: 2, label: '1 Month', targetSubs: 50, targetRevenue: 500, deadline: '1 month', icon: '📅' },
            { id: 3, label: '6 Months', targetSubs: 600, targetRevenue: 6000, deadline: '6 months', icon: '🚀' },
            { id: 4, label: '1 Year', targetSubs: 1350, targetRevenue: 13500, deadline: '1 year', icon: '⭐' },
            { id: 5, label: '2 Years', targetSubs: 4000, targetRevenue: 40000, deadline: '2 years', icon: '💎' },
            { id: 6, label: '3 Years', targetSubs: 9000, targetRevenue: 90000, deadline: '3 years', icon: '👑' }
        ];

        // Pricing tiers
        const TIER_PRICES = {
            tier1: 0.99,
            tier2: 4.99,
            tier3: 9.99
        };

        function getTotalPaidSubscribers() {
            return paidSubscriberData.tier1 + paidSubscriberData.tier2 + paidSubscriberData.tier3;
        }

        function getMonthlyRevenue() {
            return (paidSubscriberData.tier1 * TIER_PRICES.tier1) +
                   (paidSubscriberData.tier2 * TIER_PRICES.tier2) +
                   (paidSubscriberData.tier3 * TIER_PRICES.tier3);
        }

        let analyticsNotifySettings = {
            dailyGrowth: true,      // 50+ fans in one update
            goalReached: true,      // Hit a goal milestone
            weeklyRecap: true,      // Weekly summary
            milestone: false,       // Round numbers (2.5K, 3K, etc.)
            streak: false,          // 7+ days growth streak
            email: ''               // Email address for notifications
        };

        // Round number milestones to check
        const ROUND_MILESTONES = [2500, 3000, 4000, 5000, 7500, 10000, 15000, 20000, 25000, 30000, 40000, 50000, 75000, 100000];

        const updateStatsBtn = document.getElementById('updateStatsBtn');
        const updateStatsModal = document.getElementById('updateStatsModal');
        const closeUpdateStats = document.getElementById('closeUpdateStats');
        const cancelUpdateStats = document.getElementById('cancelUpdateStats');
        const saveUpdateStats = document.getElementById('saveUpdateStats');
        const newSubscriberCount = document.getElementById('newSubscriberCount');
        const updateNotes = document.getElementById('updateNotes');
        
        // Notification settings modal elements
        const analyticsNotifyBtn = document.getElementById('analyticsNotifyBtn');
        const analyticsNotifyModal = document.getElementById('analyticsNotifyModal');
        const closeAnalyticsNotify = document.getElementById('closeAnalyticsNotify');
        const cancelAnalyticsNotify = document.getElementById('cancelAnalyticsNotify');
        const saveAnalyticsNotify = document.getElementById('saveAnalyticsNotify');

        function renderAnalytics() {
            renderAnalyticsStats();
            renderAnalyticsGoals();
            renderPaidSubscriberGoals();
            renderAnalyticsHistory();
            renderGrowthChart();
        }

        function renderAnalyticsStats() {
            const currentEl = document.getElementById('currentSubscribers');
            const weeklyEl = document.getElementById('weeklyGrowth');
            const monthlyEl = document.getElementById('monthlyGrowth');

            if (currentEl) currentEl.textContent = analyticsData.currentCount.toLocaleString();

            // Calculate weekly growth (resets Sunday at midnight)
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay()); // Go back to Sunday
            startOfWeek.setHours(0, 0, 0, 0);
            
            // Get the fan count at the start of this week
            // Find the most recent history entry BEFORE this week started
            const historyBeforeWeek = analyticsData.history
                .filter(h => new Date(h.date) < startOfWeek)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // The count at start of week is either the last entry before the week, or the starting count
            const countAtWeekStart = historyBeforeWeek.length > 0 
                ? historyBeforeWeek[0].count 
                : analyticsData.startCount;
            
            const weeklyGrowth = analyticsData.currentCount - countAtWeekStart;
            if (weeklyEl) weeklyEl.textContent = (weeklyGrowth >= 0 ? '+' : '') + weeklyGrowth.toLocaleString();

            // Calculate monthly growth (resets 1st of month at midnight)
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);
            
            // Get the fan count at the start of this month
            const historyBeforeMonth = analyticsData.history
                .filter(h => new Date(h.date) < startOfMonth)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const countAtMonthStart = historyBeforeMonth.length > 0 
                ? historyBeforeMonth[0].count 
                : analyticsData.startCount;
            
            const monthlyGrowth = analyticsData.currentCount - countAtMonthStart;
            if (monthlyEl) monthlyEl.textContent = (monthlyGrowth >= 0 ? '+' : '') + monthlyGrowth.toLocaleString();

            // Render paid subscriber stats
            renderPaidSubscriberStats();
        }

        function renderPaidSubscriberStats() {
            const totalEl = document.getElementById('currentPaidSubscribers');
            const revenueEl = document.getElementById('monthlyRevenue');
            const weeklyEl = document.getElementById('paidWeeklyGrowth');
            const monthlyEl = document.getElementById('paidMonthlyGrowth');
            
            const totalSubs = getTotalPaidSubscribers();
            const revenue = getMonthlyRevenue();
            
            if (totalEl) totalEl.textContent = totalSubs.toLocaleString();
            if (revenueEl) revenueEl.textContent = '$' + revenue.toFixed(0);
            
            // Calculate weekly growth for paid subscribers
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const historyBeforeWeek = paidSubscriberData.history
                .filter(h => new Date(h.date) < startOfWeek)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const countAtWeekStart = historyBeforeWeek.length > 0 
                ? historyBeforeWeek[0].total 
                : paidSubscriberData.startCount;
            
            const weeklyGrowth = totalSubs - countAtWeekStart;
            if (weeklyEl) weeklyEl.textContent = (weeklyGrowth >= 0 ? '+' : '') + weeklyGrowth.toLocaleString();

            // Calculate monthly growth for paid subscribers
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);
            
            const historyBeforeMonth = paidSubscriberData.history
                .filter(h => new Date(h.date) < startOfMonth)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const countAtMonthStart = historyBeforeMonth.length > 0 
                ? historyBeforeMonth[0].total 
                : paidSubscriberData.startCount;
            
            const monthlyGrowth = totalSubs - countAtMonthStart;
            if (monthlyEl) monthlyEl.textContent = (monthlyGrowth >= 0 ? '+' : '') + monthlyGrowth.toLocaleString();
        }

        function renderAnalyticsGoals() {
            const container = document.getElementById('analyticsGoals');
            if (!container) return;

            const current = analyticsData.currentCount;
            const now = new Date();
            
            // Get count at start of this week (Sunday midnight)
            function getWeekStartCount() {
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                weekStart.setHours(0, 0, 0, 0);
                
                // Find the last history entry before this week started
                const historyBeforeWeek = analyticsData.history
                    .filter(h => new Date(h.date) < weekStart)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (historyBeforeWeek.length > 0) {
                    return historyBeforeWeek[0].count;
                }
                
                // If no history before week, use current count (0% progress)
                return current;
            }

            container.innerHTML = analyticsData.goals.map(goal => {
                let progress, achieved, remaining, targetDisplay;
                
                // For goals, we track progress from startCount (initial fans don't count)
                const fansGainedSinceStart = current - analyticsData.startCount;
                
                if (goal.deadline === '1 week') {
                    // Weekly goal: +100 fans from week start
                    const weekStartCount = getWeekStartCount();
                    const gainedThisWeek = current - weekStartCount;
                    
                    progress = Math.max(0, Math.min((gainedThisWeek / goal.target) * 100, 100));
                    achieved = gainedThisWeek >= goal.target;
                    remaining = goal.target - gainedThisWeek;
                    targetDisplay = `+${goal.target}`;
                } else {
                    // Other goals: track fans gained since start (not total fans)
                    progress = Math.max(0, Math.min((fansGainedSinceStart / goal.target) * 100, 100));
                    achieved = fansGainedSinceStart >= goal.target;
                    remaining = goal.target - fansGainedSinceStart;
                    targetDisplay = `+${goal.target.toLocaleString()}`;
                }

                return `
                    <div class="analytics-goal ${achieved ? 'achieved' : ''}">
                        <div class="analytics-goal-header">
                            <div class="analytics-goal-label">
                                <span class="goal-icon">${achieved ? '✅' : goal.icon}</span>
                                ${goal.label} Goal
                            </div>
                            <div class="analytics-goal-target">
                                Target: <span>${targetDisplay}</span> fans
                            </div>
                        </div>
                        <div class="analytics-goal-progress">
                            <div class="analytics-goal-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div class="analytics-goal-stats">
                            <span>${achieved ? '🎉 Goal achieved!' : `${Math.abs(remaining).toLocaleString()} to go`}</span>
                            <span class="analytics-goal-percent">${progress.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPaidSubscriberGoals() {
            const container = document.getElementById('paidSubscriberGoals');
            if (!container) return;

            const currentSubs = getTotalPaidSubscribers();
            const currentRevenue = getMonthlyRevenue();
            const now = new Date();
            
            // Get count at start of this week (Sunday midnight)
            function getWeekStartCount() {
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                weekStart.setHours(0, 0, 0, 0);
                
                const historyBeforeWeek = paidSubscriberData.history
                    .filter(h => new Date(h.date) < weekStart)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (historyBeforeWeek.length > 0) {
                    return historyBeforeWeek[0].total;
                }
                // No history before week - use startCount as baseline
                return paidSubscriberData.startCount;
            }

            container.innerHTML = paidSubscriberGoals.map(goal => {
                let progress, achieved, remaining, targetDisplay;
                
                // For goals, we track progress from startCount (initial subs don't count)
                const subsGainedSinceStart = currentSubs - paidSubscriberData.startCount;
                
                if (goal.deadline === '1 week') {
                    // Weekly goal: +20 subscribers from week start
                    const weekStartCount = getWeekStartCount();
                    const gainedThisWeek = currentSubs - weekStartCount;
                    
                    progress = Math.max(0, Math.min((gainedThisWeek / goal.targetSubs) * 100, 100));
                    achieved = gainedThisWeek >= goal.targetSubs;
                    remaining = goal.targetSubs - gainedThisWeek;
                    targetDisplay = `+${goal.targetSubs} subs / $${goal.targetRevenue}`;
                } else {
                    // Other goals: track subs gained since start (not total subs)
                    progress = Math.max(0, Math.min((subsGainedSinceStart / goal.targetSubs) * 100, 100));
                    achieved = subsGainedSinceStart >= goal.targetSubs;
                    remaining = goal.targetSubs - subsGainedSinceStart;
                    targetDisplay = `+${goal.targetSubs.toLocaleString()} subs / $${goal.targetRevenue.toLocaleString()}`;
                }

                return `
                    <div class="analytics-goal ${achieved ? 'achieved' : ''}" style="border-color: rgba(139, 92, 246, 0.3);">
                        <div class="analytics-goal-header">
                            <div class="analytics-goal-label">
                                <span class="goal-icon">${achieved ? '✅' : goal.icon}</span>
                                ${goal.label} Goal
                            </div>
                            <div class="analytics-goal-target">
                                <span style="color: #8b5cf6;">${targetDisplay}</span>
                            </div>
                        </div>
                        <div class="analytics-goal-progress">
                            <div class="analytics-goal-progress-bar" style="width: ${progress}%; background: linear-gradient(90deg, #8b5cf6, #a78bfa);"></div>
                        </div>
                        <div class="analytics-goal-stats">
                            <span>${achieved ? '🎉 Goal achieved!' : `${Math.abs(remaining).toLocaleString()} subs to go`}</span>
                            <span class="analytics-goal-percent">${progress.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAnalyticsHistory() {
            const container = document.getElementById('analyticsHistory');
            if (!container) return;

            const hasEmailHistory = analyticsData.history.length > 0;
            const hasPaidHistory = paidSubscriberData.history.length > 0;

            if (!hasEmailHistory && !hasPaidHistory) {
                container.innerHTML = `
                    <div class="analytics-empty">
                        <p>No updates yet. Click "Update Fans" or "Update Subs" to log your first update!</p>
                    </div>
                `;
                return;
            }

            // Combine both histories with type indicator
            let combinedHistory = [];
            
            // Add email+SMS history
            analyticsData.history.forEach(entry => {
                combinedHistory.push({
                    ...entry,
                    type: 'fans',
                    change: entry.count - (entry.previousCount || analyticsData.startCount)
                });
            });
            
            // Add paid subscriber history
            paidSubscriberData.history.forEach(entry => {
                combinedHistory.push({
                    date: entry.date,
                    count: entry.total,
                    type: 'subs',
                    change: entry.total - (entry.previousTotal || paidSubscriberData.startCount),
                    revenue: entry.revenue
                });
            });

            // Sort by date descending (most recent first)
            combinedHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = combinedHistory.map(entry => {
                const changeClass = entry.change >= 0 ? 'positive' : 'negative';
                const changeText = entry.change >= 0 ? `+${entry.change}` : entry.change;
                const isSubs = entry.type === 'subs';
                const typeIcon = isSubs ? '💎' : '👥';
                const typeClass = isSubs ? 'subs-entry' : 'fans-entry';

                return `
                    <div class="analytics-history-item ${typeClass}">
                        <div class="analytics-history-type">${typeIcon}</div>
                        <div class="analytics-history-date">${formatHistoryDate(entry.date)}</div>
                        <div class="analytics-history-value">${entry.count.toLocaleString()}</div>
                        <div class="analytics-history-change ${changeClass}">${changeText}</div>
                        ${isSubs && entry.revenue ? `<div class="analytics-history-revenue">$${entry.revenue.toFixed(0)}/mo</div>` : ''}
                        ${entry.note ? `<div class="analytics-history-note">${entry.note}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function formatHistoryDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function renderGrowthChart() {
            const canvas = document.getElementById('growthChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = 280;

            // Prepare data points from history
            let dataPoints = [{ date: new Date(analyticsData.startDate), count: analyticsData.startCount }];
            analyticsData.history.forEach(h => {
                dataPoints.push({ date: new Date(h.date), count: h.count });
            });
            
            // Add current count as latest point
            dataPoints.push({ date: new Date(), count: analyticsData.currentCount });
            dataPoints.sort((a, b) => a.date - b.date);
            
            // Remove duplicates (keep latest for each day)
            const uniqueByDay = {};
            dataPoints.forEach(p => {
                const dayKey = p.date.toISOString().split('T')[0];
                uniqueByDay[dayKey] = p;
            });
            dataPoints = Object.values(uniqueByDay).sort((a, b) => a.date - b.date);

            // Chart dimensions
            const padding = { top: 30, right: 30, bottom: 50, left: 70 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;

            // Calculate scales - focus on actual data range
            const counts = dataPoints.map(d => d.count);
            const minCount = Math.min(...counts);
            const maxCount = Math.max(...counts);
            const countRange = maxCount - minCount || 100;
            const yMin = Math.max(0, minCount - countRange * 0.1);
            const yMax = maxCount + countRange * 0.1;
            
            const minDate = dataPoints[0].date;
            const maxDate = dataPoints[dataPoints.length - 1].date;
            const dateRange = maxDate - minDate || 1;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw background
            const isDark = document.body.dataset.theme !== 'light';
            ctx.fillStyle = isDark ? '#1a1a1e' : '#fafafa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw subtle grid lines
            ctx.strokeStyle = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines (5 lines)
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(canvas.width - padding.right, y);
                ctx.stroke();

                // Y-axis labels
                const value = yMax - ((yMax - yMin) / 4) * i;
                ctx.fillStyle = isDark ? '#71717a' : '#9ca3af';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(value).toLocaleString(), padding.left - 15, y + 4);
            }

            // X-axis labels (show months)
            ctx.fillStyle = isDark ? '#71717a' : '#9ca3af';
            ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            
            // Calculate month labels
            const months = [];
            let currentMonth = new Date(minDate);
            currentMonth.setDate(1);
            while (currentMonth <= maxDate) {
                months.push(new Date(currentMonth));
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
            if (months.length === 0) months.push(minDate);
            
            months.forEach(monthDate => {
                const x = padding.left + ((monthDate - minDate) / dateRange) * chartWidth;
                if (x >= padding.left && x <= canvas.width - padding.right) {
                    const label = monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    ctx.fillText(label, x, canvas.height - padding.bottom + 25);
                }
            });

            // Draw gradient fill under line first
            const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartHeight);
            gradient.addColorStop(0, isDark ? 'rgba(249, 115, 22, 0.25)' : 'rgba(249, 115, 22, 0.15)');
            gradient.addColorStop(1, 'rgba(249, 115, 22, 0)');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            dataPoints.forEach((point, i) => {
                const x = padding.left + ((point.date - minDate) / dateRange) * chartWidth;
                const y = padding.top + chartHeight - ((point.count - yMin) / (yMax - yMin)) * chartHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.lineTo(padding.left + ((dataPoints[dataPoints.length-1].date - minDate) / dateRange) * chartWidth, padding.top + chartHeight);
            ctx.lineTo(padding.left + ((dataPoints[0].date - minDate) / dateRange) * chartWidth, padding.top + chartHeight);
            ctx.closePath();
            ctx.fill();

            // Draw smooth line
            ctx.strokeStyle = '#f97316';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();

            dataPoints.forEach((point, i) => {
                const x = padding.left + ((point.date - minDate) / dateRange) * chartWidth;
                const y = padding.top + chartHeight - ((point.count - yMin) / (yMax - yMin)) * chartHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // Draw data points (small dots)
            dataPoints.forEach((point, i) => {
                const x = padding.left + ((point.date - minDate) / dateRange) * chartWidth;
                const y = padding.top + chartHeight - ((point.count - yMin) / (yMax - yMin)) * chartHeight;
                
                // Outer circle
                ctx.fillStyle = '#f97316';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Inner circle (white/dark center)
                ctx.fillStyle = isDark ? '#1a1a1e' : '#fafafa';
                ctx.beginPath();
                ctx.arc(x, y, 2.5, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw current value label at the end
            const lastPoint = dataPoints[dataPoints.length - 1];
            const lastX = padding.left + ((lastPoint.date - minDate) / dateRange) * chartWidth;
            const lastY = padding.top + chartHeight - ((lastPoint.count - yMin) / (yMax - yMin)) * chartHeight;
            
            // Value badge
            ctx.fillStyle = '#f97316';
            const valueText = lastPoint.count.toLocaleString();
            ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, sans-serif';
            const textWidth = ctx.measureText(valueText).width;
            const badgePadding = 8;
            const badgeX = Math.min(lastX + 10, canvas.width - padding.right - textWidth - badgePadding * 2);
            const badgeY = Math.max(lastY - 12, padding.top + 15);
            
            // Draw badge background (rounded rectangle - compatible version)
            const badgeRadius = 6;
            const badgeWidth = textWidth + badgePadding * 2;
            const badgeHeight = 22;
            const badgeTop = badgeY - 10;
            
            ctx.beginPath();
            ctx.moveTo(badgeX + badgeRadius, badgeTop);
            ctx.lineTo(badgeX + badgeWidth - badgeRadius, badgeTop);
            ctx.quadraticCurveTo(badgeX + badgeWidth, badgeTop, badgeX + badgeWidth, badgeTop + badgeRadius);
            ctx.lineTo(badgeX + badgeWidth, badgeTop + badgeHeight - badgeRadius);
            ctx.quadraticCurveTo(badgeX + badgeWidth, badgeTop + badgeHeight, badgeX + badgeWidth - badgeRadius, badgeTop + badgeHeight);
            ctx.lineTo(badgeX + badgeRadius, badgeTop + badgeHeight);
            ctx.quadraticCurveTo(badgeX, badgeTop + badgeHeight, badgeX, badgeTop + badgeHeight - badgeRadius);
            ctx.lineTo(badgeX, badgeTop + badgeRadius);
            ctx.quadraticCurveTo(badgeX, badgeTop, badgeX + badgeRadius, badgeTop);
            ctx.closePath();
            ctx.fill();
            
            // Draw badge text
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'left';
            ctx.fillText(valueText, badgeX + badgePadding, badgeY + 5);
        }

        // Event listeners
        updateStatsBtn?.addEventListener('click', () => {
            newSubscriberCount.value = '';
            updateNotes.value = '';
            updateStatsModal.classList.add('open');
            newSubscriberCount.focus();
        });

        closeUpdateStats?.addEventListener('click', () => updateStatsModal.classList.remove('open'));
        cancelUpdateStats?.addEventListener('click', () => updateStatsModal.classList.remove('open'));

        saveUpdateStats?.addEventListener('click', () => {
            const newCount = parseInt(newSubscriberCount.value);
            if (isNaN(newCount) || newCount < 0) {
                alert('Please enter a valid fan count');
                return;
            }

            const previousCount = analyticsData.currentCount;
            const dailyGrowth = newCount - previousCount;
            
            analyticsData.currentCount = newCount;
            analyticsData.history.push({
                date: new Date().toISOString(),
                count: newCount,
                previousCount: previousCount,
                note: updateNotes.value.trim()
            });

            saveAnalyticsData();
            renderAnalytics();
            updateStatsModal.classList.remove('open');

            // Check for goal achievements (if enabled)
            if (analyticsNotifySettings.goalReached) {
                checkGoalAchievements(previousCount, newCount);
            }
            
            // Check for daily growth milestone (50+ in an update)
            if (analyticsNotifySettings.dailyGrowth && dailyGrowth >= 50) {
                sendDailyGrowthNotification(dailyGrowth, newCount);
            }
            
            // Check for round number milestones
            if (analyticsNotifySettings.milestone) {
                checkRoundMilestones(previousCount, newCount);
            }
        });

        // ========== PAID SUBSCRIBERS MODAL ==========
        const updatePaidStatsBtn = document.getElementById('updatePaidStatsBtn');
        const updatePaidStatsModal = document.getElementById('updatePaidStatsModal');
        const closePaidStats = document.getElementById('closePaidStats');
        const cancelPaidStats = document.getElementById('cancelPaidStats');
        const savePaidStats = document.getElementById('savePaidStats');
        const tier1Input = document.getElementById('tier1Count');
        const tier2Input = document.getElementById('tier2Count');
        const tier3Input = document.getElementById('tier3Count');
        const paidPreviewTotal = document.getElementById('paidPreviewTotal');
        const paidPreviewRevenue = document.getElementById('paidPreviewRevenue');

        function updatePaidPreview() {
            const t1 = parseInt(tier1Input.value) || 0;
            const t2 = parseInt(tier2Input.value) || 0;
            const t3 = parseInt(tier3Input.value) || 0;
            const total = t1 + t2 + t3;
            const revenue = (t1 * 0.99) + (t2 * 4.99) + (t3 * 9.99);
            
            if (paidPreviewTotal) paidPreviewTotal.textContent = total.toLocaleString();
            if (paidPreviewRevenue) paidPreviewRevenue.textContent = '$' + revenue.toFixed(2);
        }

        tier1Input?.addEventListener('input', updatePaidPreview);
        tier2Input?.addEventListener('input', updatePaidPreview);
        tier3Input?.addEventListener('input', updatePaidPreview);

        updatePaidStatsBtn?.addEventListener('click', () => {
            tier1Input.value = paidSubscriberData.tier1 || '';
            tier2Input.value = paidSubscriberData.tier2 || '';
            tier3Input.value = paidSubscriberData.tier3 || '';
            updatePaidPreview();
            updatePaidStatsModal.classList.add('open');
            tier1Input.focus();
        });

        closePaidStats?.addEventListener('click', () => updatePaidStatsModal.classList.remove('open'));
        cancelPaidStats?.addEventListener('click', () => updatePaidStatsModal.classList.remove('open'));

        savePaidStats?.addEventListener('click', () => {
            const t1 = parseInt(tier1Input.value) || 0;
            const t2 = parseInt(tier2Input.value) || 0;
            const t3 = parseInt(tier3Input.value) || 0;
            
            const previousTotal = getTotalPaidSubscribers();
            
            paidSubscriberData.tier1 = t1;
            paidSubscriberData.tier2 = t2;
            paidSubscriberData.tier3 = t3;
            
            const newTotal = getTotalPaidSubscribers();
            const newRevenue = getMonthlyRevenue();
            
            // If this is the first save (startCount is 0), set startCount to current total
            // This means the initial subs won't count toward goals
            if (paidSubscriberData.startCount === 0 && newTotal > 0) {
                paidSubscriberData.startCount = newTotal;
            }
            
            // Add to history
            paidSubscriberData.history.push({
                date: new Date().toISOString(),
                tier1: t1,
                tier2: t2,
                tier3: t3,
                total: newTotal,
                revenue: newRevenue,
                previousTotal: previousTotal
            });

            savePaidSubscriberData();
            renderAnalytics();
            updatePaidStatsModal.classList.remove('open');
            
            // Check for paid subscriber goal achievements
            if (analyticsNotifySettings.goalReached) {
                checkPaidSubscriberGoalAchievements(previousTotal, newTotal, newRevenue);
            }
        });

        function savePaidSubscriberData() {
            db.collection('planner').doc('paidSubscribers').set({
                tier1: paidSubscriberData.tier1,
                tier2: paidSubscriberData.tier2,
                tier3: paidSubscriberData.tier3,
                history: paidSubscriberData.history,
                startDate: paidSubscriberData.startDate,
                startCount: paidSubscriberData.startCount,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving paid subscriber data:", error);
            });
        }

        function loadPaidSubscriberData() {
            return db.collection('planner').doc('paidSubscribers').get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        paidSubscriberData.tier1 = data.tier1 || 0;
                        paidSubscriberData.tier2 = data.tier2 || 0;
                        paidSubscriberData.tier3 = data.tier3 || 0;
                        paidSubscriberData.history = data.history || [];
                        paidSubscriberData.startDate = data.startDate || '2026-01-12';
                        paidSubscriberData.startCount = data.startCount || 0;
                        
                        // Fix: If startCount is 0 but we have subs, set startCount to current total
                        // This ensures initial subs don't count toward goals
                        const currentTotal = paidSubscriberData.tier1 + paidSubscriberData.tier2 + paidSubscriberData.tier3;
                        if (paidSubscriberData.startCount === 0 && currentTotal > 0) {
                            paidSubscriberData.startCount = currentTotal;
                            savePaidSubscriberData(); // Save the corrected startCount
                        }
                    }
                })
                .catch(error => {
                    console.error("Error loading paid subscriber data:", error);
                });
        }

        // ========== SHOPIFY FUNCTIONS (DISABLED FOR NOW) ==========
        // Shopify integration will be re-enabled later
        
        // Notification settings modal handlers
        analyticsNotifyBtn?.addEventListener('click', () => {
            // Load current settings into checkboxes
            document.getElementById('notifyDailyGrowth').checked = analyticsNotifySettings.dailyGrowth;
            document.getElementById('notifyGoalReached').checked = analyticsNotifySettings.goalReached;
            document.getElementById('notifyWeeklyRecap').checked = analyticsNotifySettings.weeklyRecap;
            document.getElementById('notifyMilestone').checked = analyticsNotifySettings.milestone;
            document.getElementById('notifyStreak').checked = analyticsNotifySettings.streak;
            document.getElementById('analyticsNotifyEmail').value = analyticsNotifySettings.email || '';
            analyticsNotifyModal.classList.add('open');
        });
        
        closeAnalyticsNotify?.addEventListener('click', () => analyticsNotifyModal.classList.remove('open'));
        cancelAnalyticsNotify?.addEventListener('click', () => analyticsNotifyModal.classList.remove('open'));
        
        saveAnalyticsNotify?.addEventListener('click', () => {
            analyticsNotifySettings.dailyGrowth = document.getElementById('notifyDailyGrowth').checked;
            analyticsNotifySettings.goalReached = document.getElementById('notifyGoalReached').checked;
            analyticsNotifySettings.weeklyRecap = document.getElementById('notifyWeeklyRecap').checked;
            analyticsNotifySettings.milestone = document.getElementById('notifyMilestone').checked;
            analyticsNotifySettings.streak = document.getElementById('notifyStreak').checked;
            analyticsNotifySettings.email = document.getElementById('analyticsNotifyEmail').value.trim();
            
            saveAnalyticsNotifySettings();
            analyticsNotifyModal.classList.remove('open');
        });
        
        function saveAnalyticsNotifySettings() {
            db.collection('planner').doc('analyticsNotifySettings').set({
                ...analyticsNotifySettings,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving analytics notify settings:", error);
            });
        }
        
        function loadAnalyticsNotifySettings() {
            return db.collection('planner').doc('analyticsNotifySettings').get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        analyticsNotifySettings.dailyGrowth = data.dailyGrowth ?? true;
                        analyticsNotifySettings.goalReached = data.goalReached ?? true;
                        analyticsNotifySettings.weeklyRecap = data.weeklyRecap ?? true;
                        analyticsNotifySettings.milestone = data.milestone ?? false;
                        analyticsNotifySettings.streak = data.streak ?? false;
                        analyticsNotifySettings.email = data.email || '';
                    }
                })
                .catch(error => {
                    console.error("Error loading analytics notify settings:", error);
                });
        }
        
        function checkRoundMilestones(previousCount, newCount) {
            ROUND_MILESTONES.forEach(milestone => {
                if (previousCount < milestone && newCount >= milestone) {
                    sendMilestoneNotification(milestone, newCount);
                }
            });
        }
        
        async function sendMilestoneNotification(milestone, totalCount) {
            const milestoneLabel = milestone >= 1000 ? `${(milestone/1000).toFixed(milestone % 1000 === 0 ? 0 : 1)}K` : milestone;
            
            const emailHtml = `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 32px; border-radius: 16px 16px 0 0; text-align: center;">
                        <div style="display: inline-block; background: linear-gradient(135deg, #f97316, #ea580c); padding: 12px 20px; border-radius: 12px; margin-bottom: 16px;">
                            <span style="color: white; font-weight: 700; font-size: 18px;">SJ</span>
                        </div>
                        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">🏆 Milestone Reached!</h1>
                        <p style="color: #9ca3af; margin: 8px 0 0 0; font-size: 14px;">SLOE JACK Fan Analytics</p>
                    </div>
                    
                    <!-- Milestone Card -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 32px; text-align: center;">
                        <div style="font-size: 64px; font-weight: 800; color: white; margin-bottom: 8px;">${milestoneLabel}</div>
                        <div style="font-size: 18px; color: rgba(255,255,255,0.9);">Fans Milestone!</div>
                    </div>
                    
                    <!-- Details -->
                    <div style="background: #ffffff; padding: 24px; text-align: center;">
                        <p style="color: #1f2937; margin: 0; font-size: 16px;">
                            You've reached <strong style="color: #8b5cf6;">${milestone.toLocaleString()} fans</strong>!
                        </p>
                        <p style="color: #6b7280; margin: 12px 0 0 0; font-size: 14px;">
                            Current total: ${totalCount.toLocaleString()} fans
                        </p>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #1f2937; padding: 24px; border-radius: 0 0 16px 16px; text-align: center;">
                        <p style="color: #9ca3af; margin: 0; font-size: 13px;">
                            📅 ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                        </p>
                    </div>
                </div>
            `;
            
            const templateParams = {
                to_email: analyticsNotifySettings.email || 'hillardc@gmail.com',
                subject: `🏆 ${milestoneLabel} Fans Milestone Reached!`,
                message_html: emailHtml
            };
            
            try {
                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams,
                    EMAILJS_CONFIG.publicKey
                );
                console.log('Milestone notification sent!');
            } catch (error) {
                console.error('Failed to send milestone notification:', error);
            }
        }

        async function sendDailyGrowthNotification(dailyGrowth, totalCount) {
            const emailHtml = `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 32px; border-radius: 16px 16px 0 0; text-align: center;">
                        <div style="display: inline-block; background: linear-gradient(135deg, #f97316, #ea580c); padding: 12px 20px; border-radius: 12px; margin-bottom: 16px;">
                            <span style="color: white; font-weight: 700; font-size: 18px;">SJ</span>
                        </div>
                        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">🔥 Amazing Growth Day!</h1>
                        <p style="color: #9ca3af; margin: 8px 0 0 0; font-size: 14px;">SLOE JACK Fan Analytics</p>
                    </div>
                    
                    <!-- Stats Card -->
                    <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 32px; text-align: center;">
                        <div style="font-size: 64px; font-weight: 800; color: white; margin-bottom: 8px;">+${dailyGrowth}</div>
                        <div style="font-size: 18px; color: rgba(255,255,255,0.9);">New Fans Today!</div>
                    </div>
                    
                    <!-- Details -->
                    <div style="background: #ffffff; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 16px;">
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${totalCount.toLocaleString()}</div>
                                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">Total Fans</div>
                            </div>
                            <div style="width: 1px; background: #e5e7eb;"></div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 24px; font-weight: 700; color: #22c55e;">+${dailyGrowth}</div>
                                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">Today's Growth</div>
                            </div>
                        </div>
                        <p style="color: #6b7280; text-align: center; margin: 0; font-size: 14px;">
                            You gained <strong>${dailyGrowth} new fans</strong> today! Keep up the amazing work! 🚀
                        </p>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #1f2937; padding: 24px; border-radius: 0 0 16px 16px; text-align: center;">
                        <p style="color: #9ca3af; margin: 0; font-size: 13px;">
                            📅 ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                        </p>
                        <p style="color: #6b7280; margin: 12px 0 0 0; font-size: 12px;">
                            The fans are loving it! 🎸
                        </p>
                    </div>
                </div>
            `;
            
            const templateParams = {
                to_email: analyticsNotifySettings.email || 'hillardc@gmail.com',
                subject: `🔥 +${dailyGrowth} New Fans Today! (${totalCount.toLocaleString()} total)`,
                message_html: emailHtml
            };
            
            try {
                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams,
                    EMAILJS_CONFIG.publicKey
                );
                console.log('Daily growth notification sent!');
            } catch (error) {
                console.error('Failed to send daily growth notification:', error);
            }
        }

        function checkGoalAchievements(previousCount, newCount) {
            analyticsData.goals.forEach(goal => {
                if (previousCount < goal.target && newCount >= goal.target) {
                    // Goal just achieved!
                    setTimeout(() => {
                        alert(`🎉 Congratulations! You've reached your ${goal.label} goal of ${goal.target.toLocaleString()} fans!`);
                    }, 500);
                    
                    // Send goal achievement email
                    sendGoalAchievementNotification(goal, newCount);
                }
            });
        }
        
        async function sendGoalAchievementNotification(goal, totalCount) {
            const emailHtml = `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 32px; border-radius: 16px 16px 0 0; text-align: center;">
                        <div style="display: inline-block; background: linear-gradient(135deg, #f97316, #ea580c); padding: 12px 20px; border-radius: 12px; margin-bottom: 16px;">
                            <span style="color: white; font-weight: 700; font-size: 18px;">SJ</span>
                        </div>
                        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">🎉 Goal Achieved!</h1>
                        <p style="color: #9ca3af; margin: 8px 0 0 0; font-size: 14px;">SLOE JACK Fan Analytics</p>
                    </div>
                    
                    <!-- Goal Card -->
                    <div style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 32px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 8px;">${goal.icon}</div>
                        <div style="font-size: 24px; font-weight: 700; color: white; margin-bottom: 4px;">${goal.label} Goal</div>
                        <div style="font-size: 36px; font-weight: 800; color: white;">${goal.target.toLocaleString()} Fans</div>
                    </div>
                    
                    <!-- Details -->
                    <div style="background: #ffffff; padding: 24px; text-align: center;">
                        <div style="font-size: 18px; color: #1f2937; margin-bottom: 16px;">
                            You now have <strong style="color: #f97316;">${totalCount.toLocaleString()}</strong> total fans!
                        </div>
                        <p style="color: #6b7280; margin: 0; font-size: 14px;">
                            You crushed your ${goal.label.toLowerCase()} goal! Time to set your sights even higher! 🚀
                        </p>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #1f2937; padding: 24px; border-radius: 0 0 16px 16px; text-align: center;">
                        <p style="color: #9ca3af; margin: 0; font-size: 13px;">
                            📅 ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                        </p>
                        <p style="color: #6b7280; margin: 12px 0 0 0; font-size: 12px;">
                            Keep building that fanbase! 🎸
                        </p>
                    </div>
                </div>
            `;
            
            const templateParams = {
                to_email: analyticsNotifySettings.email || 'hillardc@gmail.com',
                subject: `🎉 Goal Achieved: ${goal.target.toLocaleString()} Fans! (${goal.label})`,
                message_html: emailHtml
            };
            
            try {
                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams,
                    EMAILJS_CONFIG.publicKey
                );
                console.log('Goal achievement notification sent!');
            } catch (error) {
                console.error('Failed to send goal achievement notification:', error);
            }
        }

        // ========== PAID SUBSCRIBER GOAL NOTIFICATIONS ==========
        function checkPaidSubscriberGoalAchievements(previousTotal, newTotal, newRevenue) {
            // Calculate gains from startCount
            const previousGain = previousTotal - paidSubscriberData.startCount;
            const newGain = newTotal - paidSubscriberData.startCount;
            
            paidSubscriberGoals.forEach(goal => {
                // Check if we just crossed the threshold
                if (previousGain < goal.targetSubs && newGain >= goal.targetSubs) {
                    // Goal just achieved!
                    setTimeout(() => {
                        alert(`🎉 Congratulations! You've reached your ${goal.label} Paid Subscriber goal of +${goal.targetSubs} subscribers!`);
                    }, 500);
                    
                    // Send goal achievement email
                    sendPaidSubscriberGoalNotification(goal, newTotal, newRevenue);
                }
            });
        }
        
        async function sendPaidSubscriberGoalNotification(goal, totalSubs, monthlyRevenue) {
            const emailHtml = `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 32px; border-radius: 16px 16px 0 0; text-align: center;">
                        <div style="display: inline-block; background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 12px 20px; border-radius: 12px; margin-bottom: 16px;">
                            <span style="color: white; font-weight: 700; font-size: 18px;">💎</span>
                        </div>
                        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">🎉 Paid Subscriber Goal Achieved!</h1>
                        <p style="color: #9ca3af; margin: 8px 0 0 0; font-size: 14px;">SLOE JACK Fan Analytics</p>
                    </div>
                    
                    <!-- Goal Card -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 32px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 8px;">${goal.icon}</div>
                        <div style="font-size: 24px; font-weight: 700; color: white; margin-bottom: 4px;">${goal.label} Goal</div>
                        <div style="font-size: 36px; font-weight: 800; color: white;">+${goal.targetSubs} Subscribers</div>
                        <div style="font-size: 18px; color: rgba(255,255,255,0.9); margin-top: 8px;">$${goal.targetRevenue.toLocaleString()}/month target</div>
                    </div>
                    
                    <!-- Details -->
                    <div style="background: #ffffff; padding: 24px; text-align: center;">
                        <div style="font-size: 18px; color: #1f2937; margin-bottom: 16px;">
                            You now have <strong style="color: #8b5cf6;">${totalSubs.toLocaleString()}</strong> paid subscribers!
                        </div>
                        <div style="font-size: 16px; color: #4b5563; margin-bottom: 16px;">
                            Monthly recurring revenue: <strong style="color: #8b5cf6;">$${monthlyRevenue.toFixed(2)}</strong>
                        </div>
                        <p style="color: #6b7280; margin: 0; font-size: 14px;">
                            You crushed your ${goal.label.toLowerCase()} paid subscriber goal! The fan support is real! 💜
                        </p>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #1f2937; padding: 24px; border-radius: 0 0 16px 16px; text-align: center;">
                        <p style="color: #9ca3af; margin: 0; font-size: 13px;">
                            📅 ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                        </p>
                        <p style="color: #6b7280; margin: 12px 0 0 0; font-size: 12px;">
                            Keep building that paid community! 🎸💎
                        </p>
                    </div>
                </div>
            `;
            
            const templateParams = {
                to_email: analyticsNotifySettings.email || 'hillardc@gmail.com',
                subject: `💎 Paid Subscriber Goal Achieved: +${goal.targetSubs} Subs! (${goal.label})`,
                message_html: emailHtml
            };
            
            try {
                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams,
                    EMAILJS_CONFIG.publicKey
                );
                console.log('Paid subscriber goal notification sent!');
            } catch (error) {
                console.error('Failed to send paid subscriber goal notification:', error);
            }
        }

        function saveAnalyticsData() {
            db.collection('planner').doc('analytics').set({
                currentCount: analyticsData.currentCount,
                history: analyticsData.history,
                goals: analyticsData.goals,
                startDate: analyticsData.startDate,
                startCount: analyticsData.startCount,
                lastUpdated: new Date().toISOString()
            }).catch(error => {
                console.error("Error saving analytics data:", error);
            });
        }

        function loadAnalyticsData() {
            return db.collection('planner').doc('analytics').get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        analyticsData.currentCount = data.currentCount || 2000;
                        analyticsData.history = data.history || [];
                        if (data.startDate) analyticsData.startDate = data.startDate;
                        // Default startCount to 1971 if not set
                        analyticsData.startCount = data.startCount || 1971;
                        
                        // Always use the hardcoded goals (don't load from Firebase)
                        // This ensures goals are always correct
                        analyticsData.goals = [
                            { id: 1, label: '1 Week', target: 100, deadline: '1 week', icon: '🎯' },
                            { id: 2, label: '1 Month', target: 500, deadline: '1 month', icon: '📅' },
                            { id: 3, label: '6 Months', target: 6000, deadline: '6 months', icon: '🚀' },
                            { id: 4, label: '1 Year', target: 12000, deadline: '1 year', icon: '⭐' },
                            { id: 5, label: '2 Years', target: 26000, deadline: '2 years', icon: '💎' },
                            { id: 6, label: '3 Years', target: 52000, deadline: '3 years', icon: '👑' }
                        ];
                        
                        // Save the corrected data
                        saveAnalyticsData();
                    }
                })
                .catch(error => {
                    console.error("Error loading analytics data:", error);
                });
        }

        // ========== INIT ==========
        async function init() {
            initTheme();
            renderIdeas();
            
            // Initialize EmailJS
            if (EMAILJS_CONFIG.publicKey !== 'YOUR_PUBLIC_KEY') {
                emailjs.init(EMAILJS_CONFIG.publicKey);
            }
            
            // Load all data from Firebase
            await loadCategories();
            await loadTasks();
            await loadPriorityOrder();
            await loadCompletionHistory();
            await loadWeeklyScoreHistory();
            await loadNotificationSettings();
            await loadDailyHabits();
            await loadDailyHabitsState();
            await loadPinnedCompletions();
            await loadPinnedPriorityOrder();
            await loadTodoData();
            await loadAnalyticsData();
            await loadAnalyticsNotifySettings();
            await loadPaidSubscriberData();
            
            // Update category styles and populate dropdowns
            updateCategoryStyles();
            populateCategoryDropdowns();
            
            // Check if daily habits need to reset (new day)
            checkAndResetDailyHabits();
            
            // Render everything
            renderDailyHabits();
            renderTodoList();
            renderAnalytics();
            updateComingUp();
            updateStats();
            updateRecentlyCompleted();
            updateWeeklyProgress();
            
            // Check if we need to send scheduled email
            checkAndSendScheduledEmail();
            
            // Listen for real-time updates from Firebase
            listenForUpdates();
            listenForPriorityUpdates();
            listenForCategoryUpdates();
            listenForCompletionHistoryUpdates();
        }

        init();
        }); // end DOMContentLoaded
    </script>
</body>
</html>
